<!-- Juice Project - Est. 2016 | Last updated 2026 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="created" content="2016-03-14">
  <meta name="author" content="Juice Project">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="The Juice Box">
  <meta property="og:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:title" content="Network Graph">
  <meta property="og:description" content="Full database network graph - explore all connections across the entire Juice Box database.">
  <meta property="og:url" content="https://thejuicebox.live/graph.html">
  <meta name="twitter:title" content="Network Graph">
  <meta name="twitter:description" content="Full database network graph - explore all connections across the entire Juice Box database.">
  <title>Network Graph</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: #000; background: #fff; }
    nav { padding: 10px 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    nav ul { list-style: none; margin: 0; padding: 10px 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; }
    nav ul li { margin: 0; white-space: nowrap; }
    nav a { color: #0000EE !important; text-decoration: none; background: rgba(255,255,255,0.85); padding: 5px 12px; white-space: nowrap; border-radius: 6px; border: 1px solid rgba(0,0,255,0.3); box-shadow: 1px 1px 2px rgba(0,0,0,0.2); font-size: 0.82em; display: inline-block; line-height: 1.4; }
    nav select { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(0,0,255,0.3); font-size: 0.85em; background: rgba(255,255,255,0.85); }
    .panel, .gp, .sb, .header-panel, .graph-wrap {
      background: rgba(255,255,255,0.15) !important; backdrop-filter: blur(12px) !important; -webkit-backdrop-filter: blur(12px) !important;
      border: 1px solid rgba(255,255,255,0.25) !important; border-radius: 12px !important; box-shadow: 0 8px 32px rgba(0,0,0,0.08) !important;
    }
    .gp:hover, .header-panel:hover { box-shadow: 0 8px 32px rgba(0,0,0,0.15) !important; border-color: rgba(255,255,255,0.35) !important; }
    nav a { background: rgba(255,255,255,0.2) !important; backdrop-filter: blur(8px) !important; -webkit-backdrop-filter: blur(8px) !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 8px !important; }
    nav select { background: rgba(255,255,255,0.2) !important; backdrop-filter: blur(8px) !important; -webkit-backdrop-filter: blur(8px) !important; border: 1px solid rgba(255,255,255,0.3) !important; }

    .main { max-width: 1600px; margin: 0 auto; padding: 15px 20px; }
    .header-panel { background: rgba(255,255,255,0.85); border: 1px solid rgba(0,0,255,0.2); border-radius: 8px; padding: 16px 20px; margin-bottom: 15px; }
    .header-panel h1 { margin: 0 0 4px 0; color: #0056b3; }
    .header-panel .subtitle { color: #555; margin: 0; font-size: 0.95em; }
    .people-info { font-size: 0.82em; color: #888; margin-top: 2px; }
    .people-info b { color: #0056b3; }

    .graph-wrap { position: relative; width: 100%; height: 85vh; min-height: 500px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(0,0,255,0.15); background: #f8f9fa; }
    #cy { position: absolute; inset: 0; width: 100%; height: 100%; }

    .gp { overflow: hidden; transition: box-shadow 0.25s; }
    .gp-h { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; cursor: pointer; user-select: none; background: rgba(0,86,179,0.06); border-bottom: 1px solid rgba(0,0,255,0.08); transition: background 0.2s; }
    .gp-h:hover { background: rgba(0,86,179,0.12); }
    .gp-h strong, .gp-h h3 { color: #0056b3; font-size: 0.78em; font-weight: 600; margin: 0; }
    .gp-h .chv { color: #0056b3; font-size: 0.6em; transition: transform 0.25s; }
    .gp.shut .gp-b { display: none; }
    .gp.shut .gp-h { border-bottom: none; }
    .gp.shut .chv { transform: rotate(180deg); }

    .hud-ctrl { position: absolute; top: 10px; left: 10px; z-index: 12; width: 215px; }
    .cb { padding: 7px 10px 9px; }
    .cb label { font-size: 0.73em; color: #333; display: block; margin: 4px 0 1px; font-weight: 500; }
    .cb select { width: 100%; padding: 4px 6px; border-radius: 5px; border: 1px solid rgba(0,0,255,0.16); background: rgba(255,255,255,0.85); color: #333; font-size: 0.77em; outline: none; }
    .cb select:focus { border-color: #0056b3; }
    .cb input[type="range"] { width: 100%; margin: 2px 0; accent-color: #0056b3; }
    .cb .chks { display: flex; gap: 10px; margin: 5px 0 2px; }
    .cb .chks label { display: flex; align-items: center; gap: 3px; font-size: 0.73em; color: #333; cursor: pointer; margin: 0; }
    .cb .chks input[type="checkbox"] { accent-color: #0056b3; }
    .cb .btns { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
    .cb .btns button { flex: 1; padding: 4px 0; border-radius: 5px; border: 1px solid rgba(0,0,255,0.16); background: rgba(0,86,179,0.08); color: #0056b3; font-size: 0.73em; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 55px; }
    .cb .btns button:hover { background: rgba(0,86,179,0.18); }

    .hud-search { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 12; display: flex; align-items: center; }
    .hud-search input { padding: 5px 11px; border: 1px solid rgba(0,0,255,0.2); border-radius: 6px 0 0 6px; font-size: 0.77em; width: 200px; outline: none; background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); color: #333; }
    .hud-search input::placeholder { color: #888; }
    .hud-search input:focus { border-color: #0056b3; }
    .hud-search button { padding: 5px 9px; border: 1px solid rgba(0,0,255,0.2); border-left: none; border-radius: 0 6px 6px 0; background: rgba(0,86,179,0.1); color: #0056b3; cursor: pointer; font-size: 0.77em; transition: background 0.2s; }
    .hud-search button:hover { background: rgba(0,86,179,0.2); }
    .hud-search .sc { padding: 0 7px; font-size: 0.71em; color: #0056b3; white-space: nowrap; text-shadow: 0 0 4px rgba(255,255,255,0.9); }

    .hud-stats { position: absolute; top: 10px; right: 10px; z-index: 12; }
    .sb { padding: 5px 11px; font-size: 0.74em; color: #333; white-space: nowrap; }
    .sb b { color: #0056b3; font-weight: 700; }

    .hud-cat { position: absolute; bottom: 10px; left: 10px; z-index: 12; width: 190px; }
    .cat-b { padding: 4px 10px 7px; max-height: 180px; overflow-y: auto; }
    .li { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #333; margin: 1px 0; cursor: pointer; padding: 1px 2px; border-radius: 3px; transition: background 0.15s; }
    .li:hover { background: rgba(0,86,179,0.08); }
    .ld { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    .hud-edge { position: absolute; bottom: 10px; right: 10px; z-index: 12; width: 172px; }
    .edge-b { padding: 3px 10px 7px; max-height: 210px; overflow-y: auto; }
    .ei { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #333; margin: 1.5px 0; }
    .el { width: 15px; height: 3px; border-radius: 2px; flex-shrink: 0; }

    .cat-b::-webkit-scrollbar, .edge-b::-webkit-scrollbar { width: 4px; }
    .cat-b::-webkit-scrollbar-track, .edge-b::-webkit-scrollbar-track { background: transparent; }
    .cat-b::-webkit-scrollbar-thumb, .edge-b::-webkit-scrollbar-thumb { background: rgba(0,0,255,0.15); border-radius: 2px; }

    #tip {
      position: fixed; background: rgba(255,255,255,0.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      color: #222; padding: 10px 14px; border-radius: 9px; border: 1px solid rgba(0,0,255,0.15); font-size: 0.79em;
      pointer-events: none; z-index: 200; max-width: 340px; line-height: 1.55; display: none; box-shadow: 0 8px 28px rgba(0,0,0,0.12);
    }
    #tip strong { color: #0056b3; }
    #tip .tip-cat { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.85em; margin-top: 3px; }

    .ld-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 25; transition: opacity 0.5s; }
    .ld-overlay.off { opacity: 0; pointer-events: none; }
    .ld-spinner { width: 38px; height: 38px; border: 3px solid rgba(0,0,255,0.1); border-top-color: #0056b3; border-radius: 50%; animation: spin 0.75s linear infinite; }
    .ld-text { color: #0056b3; font-size: 0.82em; font-weight: 600; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 900px) { .hud-search input { width: 135px; } .hud-ctrl { width: 180px; } .hud-cat { width: 160px; } .hud-edge { width: 148px; } }
    @media (max-width: 600px) { .hud-search { display: none; } .hud-ctrl { width: 160px; } .hud-cat, .hud-edge { width: 135px; } }
  </style>
</head>
<body>
  <nav id="navbar"></nav>

  <div class="main">
  <div class="header-panel">
    <h1><i class="fa-solid fa-diagram-project"></i> <span id="page-title">Full Network Graph</span></h1>
    <p class="subtitle" id="page-subtitle">Loading full database graph...</p>
    <p class="people-info" id="people-info"></p>
  </div>

  <div class="graph-wrap">
    <div id="cy"></div>

    <div class="ld-overlay" id="loading">
      <div class="ld-spinner"></div>
      <div class="ld-text" id="ld-text">Loading graph data...</div>
    </div>

    <div class="hud-ctrl">
      <div class="gp" id="ctrl-p">
        <div class="gp-h" id="ctrl-t">
          <h3><i class="fa-solid fa-sliders"></i> Controls</h3>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cb">
          <label>Country</label>
          <select id="f-country"><option value="">All Countries</option></select>
          <label>Category</label>
          <select id="f-cat"><option value="">All Categories</option></select>
          <label>Layout</label>
          <select id="layout-select">
            <option value="fcose" selected>Force-Directed (fcose)</option>
            <option value="concentric">Concentric Rings</option>
            <option value="circle">Circle</option>
            <option value="grid">Grid</option>
            <option value="breadthfirst">Hierarchical</option>
          </select>
          <div class="chks">
            <label><input type="checkbox" id="show-people" /> People</label>
            <label><input type="checkbox" id="show-labels" checked /> Labels</label>
          </div>
          <div class="btns">
            <button id="btn-reload"><i class="fa-solid fa-rotate"></i> Reload</button>
            <button id="btn-fit"><i class="fa-solid fa-compress"></i> Fit</button>
          </div>
        </div>
      </div>
    </div>

    <div class="hud-search">
      <input type="text" id="s-input" placeholder="Search nodes..." />
      <button id="s-btn"><i class="fa-solid fa-search"></i></button>
      <span class="sc" id="s-count"></span>
    </div>

    <div class="hud-stats">
      <div class="sb" id="stats"><b>Loading...</b></div>
    </div>

    <div class="hud-cat">
      <div class="gp" id="cat-p">
        <div class="gp-h" id="cat-t">
          <strong><i class="fa-solid fa-palette"></i> Categories</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cat-b" id="cat-b"></div>
      </div>
    </div>

    <div class="hud-edge">
      <div class="gp" id="edge-p">
        <div class="gp-h" id="edge-t">
          <strong><i class="fa-solid fa-link"></i> Connections</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b edge-b" id="edge-b"></div>
      </div>
    </div>
  </div>
  </div>

  <div id="tip"></div>

  <script src="app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-fcose@2.2.0/cytoscape-fcose.js"></script>
  <script>
  /* =================================================================
   *  CYTOSCAPE.JS FULL DATABASE GRAPH — fcose anti-overlap layout
   *  Browse all entries. Filter by country/category.
   *  People OFF by default (1000+ entries is already dense).
   * ================================================================= */
  initPage('jewish');

  // Register fcose layout
  if (typeof cytoscapeFcose !== 'undefined') cytoscape.use(cytoscapeFcose);

  // ─── Collapsible panels ──────────────────────────────
  ['ctrl','cat','edge'].forEach(k => {
    document.getElementById(k+'-t').onclick = () => document.getElementById(k+'-p').classList.toggle('shut');
  });

  // ─── Color maps ──────────────────────────────────────
  const CC = {
    'Entertainment & Media':'#e74c3c','Religion & Synagogues':'#9b59b6',
    'Culture & Arts':'#e67e22','Technology':'#2ecc71',
    'Community & Social Organizations':'#3498db','Education & Academia':'#1abc9c',
    'Education':'#1abc9c',
    'Representative & Umbrella Bodies':'#f39c12','Heritage & Memorials':'#8e44ad',
    'Charity & Philanthropy':'#e91e63','Investment & Private Equity':'#00bcd4',
    'Real Estate & Property':'#795548','Sports':'#ff5722',
    'Advocacy & Public Affairs':'#607d8b','Healthcare & Pharmaceuticals':'#4caf50',
    'Banking & Financial Services':'#ff9800','Research & Think Tanks':'#673ab7',
    'Retail & E-Commerce':'#009688','Defense & Security':'#f44336',
    'Food & Beverage':'#8bc34a','Conglomerates & Holding Companies':'#9e9e9e',
    'Government & Diplomacy':'#3f51b5','Fashion & Consumer Goods':'#ff4081',
    'Manufacturing & Industry':'#757575','Law Firms':'#455a64',
    'Notable Individuals':'#ffc107','Transportation':'#00acc1',
    'Advertising & PR':'#d81b60','Telecommunications':'#7c4dff',
    'Utilities & Energy':'#66bb6a','People':'#ffab40','Controversy':'#d32f2f',
    'Advocacy & Political Organizations':'#607d8b','Corporate':'#78909c',
    'Energy':'#66bb6a','Finance':'#ff9800','Government':'#3f51b5',
    'Intelligence':'#f44336','Legal':'#455a64','Media':'#e74c3c',
    'Non-Profit':'#4caf50','Philanthropy':'#e91e63','Philanthropy & Foundations':'#e91e63',
    'Political':'#f44336','Real Estate & Property':'#795548',
    'Retail & Consumer Goods':'#009688','Fashion & Luxury':'#ff4081',
    'Conglomerates':'#9e9e9e','Healthcare & Pharmaceuticals':'#4caf50',
    'Community & Social Organizations':'#3498db','Defense & Security':'#f44336'
  };
  const DC = '#546e7a', PC = '#ffab40';
  const EC = {
    'financial':'#ff9800','shared-person':'#9c27b0','political':'#f44336',
    'organizational':'#2196f3','ideological':'#4caf50','historical':'#795548',
    'legal':'#607d8b','related':'#78909c','partnership':'#00bcd4',
    'subsidiary':'#ff5722','funding':'#ffc107','membership':'#3f51b5',
    'affiliation':'#e91e63','leadership':'#8e44ad','collaboration':'#1abc9c',
    'person-affiliation':'#ffab40','industry peer':'#78909c',
    'affiliate':'#42a5f5','communal partner':'#4db6ac',
    'heritage partner':'#ab47bc','funder':'#ffa726',
    'community institution':'#66bb6a','religious partner':'#ce93d8',
    'umbrella body':'#5c6bc0','member':'#26a69a',
    'museum peer':'#7e57c2','cultural partner':'#ec407a',
    'regional connection':'#8d6e63','educational partner':'#29b6f6',
    'government partner':'#ef5350','sports affiliate':'#ff7043',
    'operating body':'#26c6da','governing body':'#d4e157',
    'preservation partner':'#9ccc65','support':'#7986cb',
    'diplomatic partner':'#f06292','historical support':'#a1887f',
    'parent organization':'#4fc3f7','research partner':'#ba68c8',
    'educational':'#1abc9c','lobbying':'#607d8b',
    'advocacy peer':'#607d8b','pro-Israel peer':'#5c6bc0',
    'super PAC':'#f44336','affiliated charity':'#e91e63',
    'lobbying target':'#3f51b5','congressional ally':'#3f51b5',
    'major donor':'#ff9800','diplomatic bridge':'#f06292',
    'pro-Israel ecosystem':'#4caf50','think tank engagement':'#673ab7',
    'social connection':'#9c27b0','academic donation':'#1abc9c',
    'alleged intelligence connection':'#f44336',
    'science connection':'#2ecc71','property':'#795548',
    'investigation':'#607d8b','social':'#9c27b0'
  };
  const DEC = '#90a4ae';

  function darken(hex, amt) {
    amt = amt || 0.3;
    try {
      const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
      return '#' + [r,g,b].map(c => Math.round(c*(1-amt)).toString(16).padStart(2,'0')).join('');
    } catch(e) { return '#333'; }
  }

  const tipEl = document.getElementById('tip');

  // ─── Cytoscape stylesheet ───────────────────────────
  const cyStyle = [
    {
      selector: 'node[nodeType="entry"]',
      style: {
        'shape': 'round-rectangle',
        'background-color': 'data(color)',
        'border-width': 2,
        'border-color': 'data(borderColor)',
        'label': 'data(name)',
        'width': 'data(size)',
        'height': 'data(sizeH)',
        'font-size': 'data(fontSize)',
        'text-valign': 'bottom',
        'text-halign': 'center',
        'text-margin-y': 4,
        'color': '#222',
        'text-outline-width': 2.5,
        'text-outline-color': '#ffffff',
        'text-max-width': '120px',
        'text-wrap': 'ellipsis',
        'min-zoomed-font-size': 4,
        'z-index': 10
      }
    },
    {
      selector: 'node[nodeType="person"]',
      style: {
        'shape': 'ellipse',
        'background-color': '#ffab40',
        'border-width': 1,
        'border-color': '#e68a00',
        'label': 'data(name)',
        'width': 'data(size)',
        'height': 'data(size)',
        'font-size': 'data(fontSize)',
        'text-valign': 'bottom',
        'text-halign': 'center',
        'text-margin-y': 3,
        'color': '#444',
        'text-outline-width': 2,
        'text-outline-color': '#ffffff',
        'text-max-width': '100px',
        'text-wrap': 'ellipsis',
        'min-zoomed-font-size': 7,
        'z-index': 5
      }
    },
    {
      selector: 'edge',
      style: {
        'line-color': 'data(color)',
        'width': 1,
        'opacity': 0.3,
        'curve-style': 'bezier',
        'target-arrow-shape': 'none'
      }
    },
    {
      selector: 'edge[type="person-affiliation"]',
      style: {
        'line-style': 'dashed',
        'line-dash-pattern': [6, 4],
        'opacity': 0.2,
        'width': 0.7
      }
    },
    {
      selector: 'node.hover',
      style: {
        'border-width': 4,
        'border-color': '#0056b3',
        'z-index': 9999,
        'font-weight': 'bold',
        'text-outline-width': 3,
        'min-zoomed-font-size': 0
      }
    },
    {
      selector: 'node.neighbor',
      style: {
        'border-width': 3,
        'border-color': '#1976d2',
        'z-index': 100,
        'min-zoomed-font-size': 0
      }
    },
    {
      selector: 'edge.highlighted',
      style: {
        'opacity': 1,
        'width': 2.5,
        'z-index': 9998
      }
    },
    {
      selector: '.dimmed',
      style: {
        'opacity': 0.06
      }
    },
    {
      selector: 'node.found',
      style: {
        'border-width': 4,
        'border-color': '#ffeb3b',
        'z-index': 500,
        'min-zoomed-font-size': 0
      }
    },
    {
      selector: 'node.nolabel',
      style: {
        'label': ''
      }
    }
  ];

  // ─── Initialize Cytoscape ────────────────────────────
  const cy = cytoscape({
    container: document.getElementById('cy'),
    style: cyStyle,
    elements: [],
    minZoom: 0.03,
    maxZoom: 8,
    wheelSensitivity: 0.15,
    boxSelectionEnabled: false,
    selectionType: 'single',
    layout: { name: 'preset' }
  });

  // ─── Tooltip helpers ─────────────────────────────────
  let lastMouseX = 0, lastMouseY = 0;
  document.addEventListener('mousemove', e => { lastMouseX = e.clientX; lastMouseY = e.clientY; });

  function showTip(html) {
    tipEl.innerHTML = html;
    tipEl.style.display = 'block';
    tipEl.style.left = Math.min(lastMouseX + 15, window.innerWidth - 360) + 'px';
    tipEl.style.top = Math.min(lastMouseY - 10, window.innerHeight - 120) + 'px';
  }
  function hideTip() { tipEl.style.display = 'none'; }

  // ─── Cytoscape events ───────────────────────────────
  let hoverTimeout = null;

  cy.on('mouseover', 'node', function(e) {
    clearTimeout(hoverTimeout);
    const node = e.target;
    node.addClass('hover');
    const hood = node.neighborhood().add(node);
    cy.batch(() => {
      cy.elements().not(hood).addClass('dimmed');
      hood.nodes().not(node).addClass('neighbor');
      hood.edges().addClass('highlighted');
    });

    const d = node.data();
    let html;
    if (d.nodeType === 'person') {
      html = '<strong><i class="fa-solid fa-user"></i> ' + d.name + '</strong><br/>'
        + '<i class="fa-solid fa-briefcase"></i> ' + (d.role || 'Individual') + '<br/>'
        + '<i class="fa-solid fa-globe"></i> ' + (d.country || '')
        + '<br/><span style="color:#666;font-size:0.85em">' + (d.degree || 0) + ' connections</span>';
    } else {
      html = '<strong>' + d.name + '</strong><br/>'
        + '<i class="fa-solid fa-building"></i> ' + (d.entryType || '') + '<br/>'
        + '<i class="fa-solid fa-globe"></i> ' + (d.country || '') + '<br/>'
        + '<span class="tip-cat" style="background:' + (d.color || DC) + '30;color:' + (d.color || DC) + '">' + (d.category || '') + '</span>'
        + '<br/><span style="color:#666;font-size:0.85em">' + (d.degree || 0) + ' connections</span>';
    }
    showTip(html);
  });

  cy.on('mouseout', 'node', function() {
    hoverTimeout = setTimeout(() => {
      cy.batch(() => {
        cy.elements().removeClass('dimmed neighbor hover highlighted');
      });
      hideTip();
    }, 50);
  });

  cy.on('mouseover', 'edge', function(e) {
    const edge = e.target;
    const d = edge.data();
    edge.addClass('highlighted');
    showTip('<strong>' + (d.type || 'related') + '</strong>'
      + (d.description ? '<br/>' + d.description : '')
      + '<br/><span style="color:#888;font-size:0.85em">'
      + edge.source().data('name') + ' &harr; ' + edge.target().data('name') + '</span>');
  });

  cy.on('mouseout', 'edge', function(e) {
    e.target.removeClass('highlighted');
    hideTip();
  });

  cy.on('tap', 'node', function(e) {
    const d = e.target.data();
    if (d.nodeType === 'person') {
      window.location.href = 'person.html?id=' + encodeURIComponent(d.personId || d.id);
    } else {
      window.location.href = 'network.html?id=' + encodeURIComponent(d.id);
    }
  });

  // ─── Layout config builder ──────────────────────────
  function getLayoutConfig() {
    const layoutName = document.getElementById('layout-select').value;
    const base = { animate: true, animationDuration: 1500, fit: true, padding: 50 };

    switch (layoutName) {
      case 'fcose':
        return Object.assign(base, {
          name: 'fcose',
          quality: 'default',
          randomize: true,
          nodeDimensionsIncludeLabels: true,
          nodeRepulsion: function() { return 6500; },
          idealEdgeLength: function() { return 100; },
          edgeElasticity: function() { return 0.45; },
          nestingFactor: 0.1,
          gravity: 0.3,
          gravityRange: 3.8,
          numIter: 2500
        });
      case 'concentric':
        return Object.assign(base, {
          name: 'concentric',
          concentric: function(node) {
            return node.data('degree') || 1;
          },
          levelWidth: function() { return 3; },
          minNodeSpacing: 25,
          avoidOverlap: true,
          nodeDimensionsIncludeLabels: true
        });
      case 'circle':
        return Object.assign(base, { name: 'circle', avoidOverlap: true, nodeDimensionsIncludeLabels: true });
      case 'grid':
        return Object.assign(base, { name: 'grid', avoidOverlap: true, nodeDimensionsIncludeLabels: true, condense: true });
      case 'breadthfirst':
        return Object.assign(base, {
          name: 'breadthfirst',
          directed: false,
          avoidOverlap: true,
          nodeDimensionsIncludeLabels: true,
          spacingFactor: 1.2
        });
      default:
        return Object.assign(base, { name: 'fcose', quality: 'default', randomize: true, nodeDimensionsIncludeLabels: true, nodeRepulsion: function() { return 6500; }, numIter: 2500 });
    }
  }

  // ─── Build graph from API data ──────────────────────
  function buildGraph(data) {
    const elements = [];

    const degMap = {};
    data.nodes.forEach(n => { degMap[n.id] = 0; });
    data.links.forEach(l => {
      degMap[l.source] = (degMap[l.source] || 0) + 1;
      degMap[l.target] = (degMap[l.target] || 0) + 1;
    });

    data.nodes.forEach(n => {
      const deg = degMap[n.id] || 0;
      const isPerson = n.nodeType === 'person';
      const catColor = CC[n.category] || DC;

      let size, sizeH, fontSize;
      if (isPerson) {
        size = Math.max(10, 8 + Math.sqrt(deg) * 2);
        sizeH = size;
        fontSize = Math.max(6, 5 + Math.min(deg, 10) * 0.2);
      } else {
        size = Math.max(18, 12 + Math.sqrt(deg) * 4);
        sizeH = Math.max(14, 10 + Math.sqrt(deg) * 3);
        fontSize = Math.max(8, 6 + Math.sqrt(deg) * 0.9);
      }

      elements.push({
        group: 'nodes',
        data: {
          id: n.id,
          name: n.name,
          nodeType: n.nodeType,
          category: n.category || '',
          country: n.country || '',
          entryType: n.type || '',
          role: n.role || '',
          personId: n.personId || '',
          degree: deg,
          color: isPerson ? PC : catColor,
          borderColor: isPerson ? '#e68a00' : darken(catColor),
          size: size,
          sizeH: sizeH,
          fontSize: fontSize
        }
      });
    });

    data.links.forEach((l, i) => {
      elements.push({
        group: 'edges',
        data: {
          id: 'e' + i,
          source: l.source,
          target: l.target,
          type: l.type || 'related',
          description: l.description || '',
          color: EC[l.type] || DEC
        }
      });
    });

    cy.batch(() => {
      cy.elements().remove();
      cy.add(elements);
    });

    const layoutConfig = getLayoutConfig();
    document.getElementById('ld-text').textContent = 'Computing layout for ' + data.nodes.length + ' nodes...';

    const layout = cy.layout(layoutConfig);
    layout.on('layoutstop', () => {
      setTimeout(() => document.getElementById('loading').classList.add('off'), 200);
    });
    layout.run();

    const entryCount = data.nodes.filter(n => n.nodeType !== 'person').length;
    const peopleCount = data.nodes.filter(n => n.nodeType === 'person').length;
    document.getElementById('stats').innerHTML =
      '<b>' + entryCount + '</b> entries &middot; <b>' + peopleCount + '</b> people &middot; <b>' + data.links.length + '</b> links';

    setSEO({ title: 'Network Graph - Juice Project', description: 'Full database network graph with ' + entryCount + ' entries and ' + data.links.length + ' connections.' });
    document.getElementById('page-subtitle').textContent =
      entryCount + ' entries \u00B7 ' + data.links.length + ' connections' + (peopleCount ? ' \u00B7 ' + peopleCount + ' people' : '');

    if (data.totalPeople !== undefined) {
      const showing = document.getElementById('show-people').checked;
      document.getElementById('people-info').innerHTML = showing
        ? 'Showing <b>' + peopleCount + '</b> of <b>' + data.totalPeople + '</b> associated individuals'
        : '<b>' + data.totalPeople + '</b> people available \u2014 check "People" to show';
    }

    buildCatLegend(data.nodes);
    buildEdgeLegend(data.links);
  }

  function buildCatLegend(nodeList) {
    const cats = [...new Set(nodeList.map(n => n.category).filter(Boolean))].sort();
    const catB = document.getElementById('cat-b');
    catB.innerHTML = '';
    cats.forEach(c => {
      const r = document.createElement('div'); r.className = 'li';
      const d = document.createElement('div'); d.className = 'ld';
      d.style.background = CC[c] || DC;
      if (c === 'People') { d.style.borderRadius = '2px'; d.style.transform = 'rotate(45deg)'; }
      r.appendChild(d);
      r.appendChild(document.createTextNode(c));
      r.onclick = () => {
        cy.batch(() => { cy.nodes().removeClass('found'); });
        const matching = cy.nodes().filter(n => n.data('category') === c);
        cy.batch(() => { matching.addClass('found'); });
        document.getElementById('s-count').textContent = matching.length + ' in ' + c;
        document.getElementById('s-input').value = '';
        if (matching.length) cy.fit(matching, 60);
      };
      catB.appendChild(r);
    });
  }

  function buildEdgeLegend(linkList) {
    const eTypes = [...new Set(linkList.map(l => l.type).filter(Boolean))].sort();
    const edgeB = document.getElementById('edge-b');
    edgeB.innerHTML = '';
    eTypes.forEach(t => {
      const r = document.createElement('div'); r.className = 'ei';
      const l = document.createElement('div'); l.className = 'el';
      l.style.background = EC[t] || DEC;
      r.appendChild(l);
      r.appendChild(document.createTextNode(t));
      edgeB.appendChild(r);
    });
  }

  // ─── Dropdown population ─────────────────────────────
  let dropdownsReady = 0;
  function tryLoad() { dropdownsReady++; if (dropdownsReady >= 2) loadGraph(); }

  fetch('/api/jewish/categories').then(r => r.json()).then(cats => {
    const sel = document.getElementById('f-cat');
    cats.sort().forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
    tryLoad();
  }).catch(() => tryLoad());

  fetch('/api/countries').then(r => r.json()).then(countries => {
    const sel = document.getElementById('f-country');
    countries.sort().forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
    tryLoad();
  }).catch(() => tryLoad());

  // ─── Data loading ────────────────────────────────────
  function loadGraph() {
    const ppl = document.getElementById('show-people').checked;
    const country = document.getElementById('f-country').value;
    const cat = document.getElementById('f-cat').value;

    let url = '/api/graph?people=' + (ppl ? '1' : '0');
    if (country) url += '&country=' + encodeURIComponent(country);
    if (cat) url += '&category=' + encodeURIComponent(cat);

    const ld = document.getElementById('loading');
    ld.classList.remove('off');
    document.getElementById('ld-text').textContent = 'Fetching graph data...';
    document.getElementById('stats').innerHTML = '<b>Loading...</b>';

    fetch(url).then(r => r.json()).then(data => {
      if (!data.nodes || data.nodes.length === 0) {
        document.getElementById('ld-text').textContent = 'No data found for these filters.';
        return;
      }
      buildGraph(data);
    }).catch(err => {
      console.error('Load error:', err);
      document.getElementById('ld-text').textContent = 'Error loading data: ' + err.message;
    });
  }

  // ─── Controls ────────────────────────────────────────
  document.getElementById('btn-reload').onclick = loadGraph;
  document.getElementById('btn-fit').onclick = () => cy.animate({ fit: { padding: 50 }, duration: 500 });
  document.getElementById('show-people').onchange = loadGraph;
  document.getElementById('f-country').onchange = loadGraph;
  document.getElementById('f-cat').onchange = loadGraph;

  document.getElementById('layout-select').onchange = () => {
    if (cy.nodes().length === 0) return;
    const layoutConfig = getLayoutConfig();
    document.getElementById('loading').classList.remove('off');
    document.getElementById('ld-text').textContent = 'Re-laying out ' + cy.nodes().length + ' nodes...';
    const layout = cy.layout(layoutConfig);
    layout.on('layoutstop', () => {
      setTimeout(() => document.getElementById('loading').classList.add('off'), 200);
    });
    layout.run();
  };

  document.getElementById('show-labels').onchange = function() {
    if (this.checked) {
      cy.batch(() => { cy.nodes().removeClass('nolabel'); });
    } else {
      cy.batch(() => { cy.nodes().addClass('nolabel'); });
    }
  };

  // ─── Search ──────────────────────────────────────────
  function doSearch() {
    const q = document.getElementById('s-input').value.trim().toLowerCase();
    cy.batch(() => { cy.nodes().removeClass('found'); });
    cy.batch(() => { cy.elements().removeClass('dimmed'); });
    if (!q) { document.getElementById('s-count').textContent = ''; return; }
    const matches = cy.nodes().filter(n => (n.data('name') || '').toLowerCase().includes(q));
    if (matches.length) {
      cy.batch(() => { matches.addClass('found'); });
      document.getElementById('s-count').textContent = matches.length + ' found';
      cy.fit(matches, 60);
    } else {
      document.getElementById('s-count').textContent = 'none';
    }
  }
  document.getElementById('s-btn').onclick = doSearch;
  document.getElementById('s-input').onkeydown = function(e) { if (e.key === 'Enter') doSearch(); };
  document.getElementById('s-input').oninput = function() {
    if (!this.value.trim()) {
      cy.batch(() => { cy.nodes().removeClass('found'); cy.elements().removeClass('dimmed'); });
      document.getElementById('s-count').textContent = '';
    }
  };

  cy.on('tap', function(e) {
    if (e.target === cy) {
      cy.batch(() => { cy.nodes().removeClass('found'); cy.elements().removeClass('dimmed neighbor hover highlighted'); });
      document.getElementById('s-count').textContent = '';
      document.getElementById('s-input').value = '';
    }
  });
  </script>
</body>
</html>
