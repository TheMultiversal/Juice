<!-- Juice Project - Est. 2016 | Last updated 2025 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="created" content="2016-03-14">
  <meta name="author" content="Juice Project">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="The Juice Box">
  <meta property="og:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:title" content="Network Graph">
  <meta property="og:description" content="Comprehensive directory of Jewish organizations worldwide - tracking structure, people, and connections since 2016.">
  <meta property="og:url" content="https://thejuicebox.live/graph.html">
  <meta name="twitter:title" content="Network Graph">
  <meta name="twitter:description" content="Comprehensive directory of Jewish organizations worldwide - tracking structure, people, and connections since 2016.">
  <title>Network Graph</title>

  <!-- d3-force: collision force for better layout -->
  <script src="https://cdn.jsdelivr.net/npm/d3-dispatch@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-quadtree@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-timer@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-force@3"></script>
  <!-- force-graph: d3-force Canvas2D renderer - async layout, handles 10k+ nodes -->
  <script src="https://unpkg.com/force-graph"></script>

  <style>
    /* ===== BASE ===== */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: #000; background: #fff; }
    nav { padding: 10px 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    nav ul { list-style: none; margin: 0; padding: 10px 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; }
    nav ul li { margin: 0; white-space: nowrap; }
    nav a { color: #0000EE !important; text-decoration: none; background: rgba(255,255,255,0.85); padding: 5px 12px; white-space: nowrap; border-radius: 6px; border: 1px solid rgba(0,0,255,0.3); box-shadow: 1px 1px 2px rgba(0,0,0,0.2); font-size: 0.82em; display: inline-block; line-height: 1.4; }
    nav select { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(0,0,255,0.3); font-size: 0.85em; background: rgba(255,255,255,0.85); }

    /* Glassmorphism */
    .panel, .gp, .sb, .header-panel, .graph-wrap {
      background: rgba(255, 255, 255, 0.15) !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      border: 1px solid rgba(255, 255, 255, 0.25) !important;
      border-radius: 12px !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08) !important;
    }
    .gp:hover, .header-panel:hover { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important; border-color: rgba(255, 255, 255, 0.35) !important; }
    nav a {
      background: rgba(255, 255, 255, 0.2) !important;
      backdrop-filter: blur(8px) !important;
      -webkit-backdrop-filter: blur(8px) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
      border-radius: 8px !important;
    }
    nav select {
      background: rgba(255, 255, 255, 0.2) !important;
      backdrop-filter: blur(8px) !important;
      -webkit-backdrop-filter: blur(8px) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
    }

    /* ===== PAGE LAYOUT ===== */
    .main { max-width: 1600px; margin: 0 auto; padding: 15px 20px; }
    .header-panel { background: rgba(255,255,255,0.85); border: 1px solid rgba(0,0,255,0.2); border-radius: 8px; padding: 16px 20px; margin-bottom: 15px; }
    .header-panel h1 { margin: 0 0 4px 0; color: #0056b3; }
    .header-panel .subtitle { color: #555; margin: 0; font-size: 0.95em; }

    /* ===== GRAPH WRAPPER ===== */
    .graph-wrap { position: relative; width: 100%; height: 85vh; min-height: 500px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(0,0,255,0.15); background: #fff; }
    #graph-container { position: absolute; inset: 0; width: 100%; height: 100%; }
    #graph-container canvas { border-radius: 12px; }

    /* ===== SHARED PANEL ===== */
    .gp { overflow: hidden; transition: box-shadow 0.25s; }
    .gp-h {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 10px; cursor: pointer; user-select: none;
      background: rgba(0,86,179,0.06);
      border-bottom: 1px solid rgba(0,0,255,0.08);
      transition: background 0.2s;
    }
    .gp-h:hover { background: rgba(0,86,179,0.12); }
    .gp-h strong, .gp-h h3 { color: #0056b3; font-size: 0.78em; font-weight: 600; margin: 0; }
    .gp-h .chv { color: #0056b3; font-size: 0.6em; transition: transform 0.25s; }
    .gp.shut .gp-b { display: none; }
    .gp.shut .gp-h { border-bottom: none; }
    .gp.shut .chv { transform: rotate(180deg); }

    /* ===== CONTROLS (top-left) ===== */
    .hud-ctrl { position: absolute; top: 10px; left: 10px; z-index: 12; width: 210px; }
    .cb { padding: 7px 10px 9px; }
    .cb label { font-size: 0.73em; color: #333; display: block; margin: 4px 0 1px; font-weight: 500; }
    .cb select { width: 100%; padding: 4px 6px; border-radius: 5px; border: 1px solid rgba(0,0,255,0.16); background: rgba(255,255,255,0.85); color: #333; font-size: 0.77em; outline: none; }
    .cb select:focus { border-color: #0056b3; }
    .cb input[type="range"] { width: 100%; margin: 2px 0; accent-color: #0056b3; }
    .cb .chks { display: flex; gap: 10px; margin: 5px 0 2px; }
    .cb .chks label { display: flex; align-items: center; gap: 3px; font-size: 0.73em; color: #333; cursor: pointer; margin: 0; }
    .cb .chks input[type="checkbox"] { accent-color: #0056b3; }
    .cb .btns { display: flex; gap: 5px; margin-top: 5px; }
    .cb .btns button { flex: 1; padding: 4px 0; border-radius: 5px; border: 1px solid rgba(0,0,255,0.16); background: rgba(0,86,179,0.08); color: #0056b3; font-size: 0.73em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .cb .btns button:hover { background: rgba(0,86,179,0.18); }

    /* ===== SEARCH (top-center) ===== */
    .hud-search { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 12; display: flex; align-items: center; }
    .hud-search input { padding: 5px 11px; border: 1px solid rgba(0,0,255,0.2); border-radius: 6px 0 0 6px; font-size: 0.77em; width: 200px; outline: none; background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); color: #333; }
    .hud-search input::placeholder { color: #888; }
    .hud-search input:focus { border-color: #0056b3; }
    .hud-search button { padding: 5px 9px; border: 1px solid rgba(0,0,255,0.2); border-left: none; border-radius: 0 6px 6px 0; background: rgba(0,86,179,0.1); color: #0056b3; cursor: pointer; font-size: 0.77em; transition: background 0.2s; }
    .hud-search button:hover { background: rgba(0,86,179,0.2); }
    .hud-search .sc { padding: 0 7px; font-size: 0.71em; color: #0056b3; white-space: nowrap; text-shadow: 0 0 4px rgba(255,255,255,0.9); }

    /* ===== STATS (top-right) ===== */
    .hud-stats { position: absolute; top: 10px; right: 10px; z-index: 12; }
    .sb { padding: 5px 11px; font-size: 0.74em; color: #333; white-space: nowrap; }
    .sb b { color: #0056b3; font-weight: 700; }

    /* ===== CATEGORY LEGEND (bottom-left) ===== */
    .hud-cat { position: absolute; bottom: 10px; left: 10px; z-index: 12; width: 190px; }
    .cat-b { padding: 4px 10px 7px; max-height: 180px; overflow-y: auto; }
    .li { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #333; margin: 1px 0; cursor: pointer; padding: 1px 2px; border-radius: 3px; transition: background 0.15s; }
    .li:hover { background: rgba(0,86,179,0.08); }
    .ld { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    /* ===== EDGE LEGEND (bottom-right) ===== */
    .hud-edge { position: absolute; bottom: 10px; right: 10px; z-index: 12; width: 172px; }
    .edge-b { padding: 3px 10px 7px; max-height: 210px; overflow-y: auto; }
    .ei { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #333; margin: 1.5px 0; }
    .el { width: 15px; height: 3px; border-radius: 2px; flex-shrink: 0; }

    /* ===== SCROLLBAR ===== */
    .cat-b::-webkit-scrollbar, .edge-b::-webkit-scrollbar { width: 4px; }
    .cat-b::-webkit-scrollbar-track, .edge-b::-webkit-scrollbar-track { background: transparent; }
    .cat-b::-webkit-scrollbar-thumb, .edge-b::-webkit-scrollbar-thumb { background: rgba(0,0,255,0.15); border-radius: 2px; }

    /* ===== TOOLTIP ===== */
    #tip {
      position: fixed; background: rgba(255,255,255,0.95); backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      color: #222; padding: 10px 14px; border-radius: 9px;
      border: 1px solid rgba(0,0,255,0.15); font-size: 0.79em;
      pointer-events: none; z-index: 200; max-width: 340px;
      line-height: 1.55; display: none;
      box-shadow: 0 8px 28px rgba(0,0,0,0.12);
    }
    #tip strong { color: #0056b3; }
    #tip .tip-cat { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.85em; margin-top: 3px; }

    /* ===== LOADING ===== */
    .ld-overlay {
      position: absolute; inset: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 12px;
      background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 25; transition: opacity 0.5s;
    }
    .ld-overlay.off { opacity: 0; pointer-events: none; }
    .ld-spinner { width: 38px; height: 38px; border: 3px solid rgba(0,0,255,0.1); border-top-color: #0056b3; border-radius: 50%; animation: spin 0.75s linear infinite; }
    .ld-text { color: #0056b3; font-size: 0.82em; font-weight: 600; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) {
      .hud-search input { width: 135px; }
      .hud-ctrl { width: 180px; }
      .hud-cat { width: 160px; }
      .hud-edge { width: 148px; }
    }
    @media (max-width: 600px) {
      .hud-search { display: none; }
      .hud-ctrl { width: 160px; }
      .hud-cat, .hud-edge { width: 135px; }
    }
  </style>
</head>
<body>
  <nav id="navbar"></nav>

  <div class="main">
  <div class="header-panel">
    <h1><i class="fa-solid fa-diagram-project"></i> Network Graph</h1>
    <p class="subtitle">Interactive force-directed visualization - drag nodes, scroll to zoom, hover for details, click to open.</p>
  </div>

  <div class="graph-wrap">
    <!-- force-graph canvas container -->
    <div id="graph-container"></div>

    <!-- Loading -->
    <div class="ld-overlay" id="loading">
      <div class="ld-spinner"></div>
      <div class="ld-text" id="ld-text">Loading graph data...</div>
    </div>

    <!-- HUD: Controls -->
    <div class="hud-ctrl">
      <div class="gp" id="ctrl-p">
        <div class="gp-h" id="ctrl-t">
          <h3><i class="fa-solid fa-sliders"></i> Controls</h3>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cb">
          <label>Country</label>
          <select id="f-country"><option value="">All Countries</option></select>
          <label>Category</label>
          <select id="f-cat"><option value="">All Categories</option></select>
          <label>Node Size</label>
          <input type="range" id="node-scale" min="2" max="20" value="6" />
          <label>Link Distance</label>
          <input type="range" id="link-dist" min="30" max="350" value="100" />
          <div class="chks">
            <label><input type="checkbox" id="show-people" /> People</label>
          </div>
          <div class="btns">
            <button id="btn-reload"><i class="fa-solid fa-rotate"></i> Reload</button>
            <button id="btn-fit"><i class="fa-solid fa-compress"></i> Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HUD: Search -->
    <div class="hud-search">
      <input type="text" id="s-input" placeholder="Search nodes..." />
      <button id="s-btn"><i class="fa-solid fa-search"></i></button>
      <span class="sc" id="s-count"></span>
    </div>

    <!-- HUD: Stats -->
    <div class="hud-stats">
      <div class="sb" id="stats"><b>Loading...</b></div>
    </div>

    <!-- HUD: Category legend -->
    <div class="hud-cat">
      <div class="gp" id="cat-p">
        <div class="gp-h" id="cat-t">
          <strong><i class="fa-solid fa-palette"></i> Categories</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cat-b" id="cat-b"></div>
      </div>
    </div>

    <!-- HUD: Edge legend -->
    <div class="hud-edge">
      <div class="gp" id="edge-p">
        <div class="gp-h" id="edge-t">
          <strong><i class="fa-solid fa-link"></i> Connections</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b edge-b" id="edge-b"></div>
      </div>
    </div>

  </div>
  </div><!-- /.main -->

  <!-- Tooltip (must be outside .graph-wrap to avoid backdrop-filter containing block + overflow:hidden clipping) -->
  <div id="tip"></div>

  <script src="app.js"></script>
  <script>
    initPage('jewish');
    setSEO({ title: 'Network Graph - Juice Project', description: 'Interactive network visualization.' });

    // ─── Collapsible panels ──────────────────────────────
    ['ctrl','cat','edge'].forEach(k => {
      document.getElementById(k+'-t').onclick = () => document.getElementById(k+'-p').classList.toggle('shut');
    });

    // ─── Color maps ──────────────────────────────────────
    const CC = {
      'Entertainment & Media': '#e74c3c', 'Religion & Synagogues': '#9b59b6',
      'Culture & Arts': '#e67e22', 'Technology': '#2ecc71',
      'Community & Social Organizations': '#3498db', 'Education & Academia': '#1abc9c',
      'Representative & Umbrella Bodies': '#f39c12', 'Heritage & Memorials': '#8e44ad',
      'Charity & Philanthropy': '#e91e63', 'Investment & Private Equity': '#00bcd4',
      'Real Estate & Property': '#795548', 'Sports': '#ff5722',
      'Advocacy & Public Affairs': '#607d8b', 'Healthcare & Pharmaceuticals': '#4caf50',
      'Banking & Financial Services': '#ff9800', 'Research & Think Tanks': '#673ab7',
      'Retail & E-Commerce': '#009688', 'Defense & Security': '#f44336',
      'Food & Beverage': '#8bc34a', 'Conglomerates & Holding Companies': '#9e9e9e',
      'Government & Diplomacy': '#3f51b5', 'Fashion & Consumer Goods': '#ff4081',
      'Manufacturing & Industry': '#757575', 'Law Firms': '#455a64',
      'Notable Individuals': '#ffc107', 'Transportation': '#00acc1',
      'Advertising & PR': '#d81b60', 'Telecommunications': '#7c4dff',
      'Utilities & Energy': '#66bb6a', 'People': '#ffab40'
    };
    const DC = '#546e7a', PC = '#ffab40';

    const EC = {
      'financial': '#ff9800', 'shared-person': '#9c27b0', 'political': '#f44336',
      'organizational': '#2196f3', 'ideological': '#4caf50', 'historical': '#795548',
      'legal': '#607d8b', 'related': '#78909c', 'partnership': '#00bcd4',
      'subsidiary': '#ff5722', 'funding': '#ffc107', 'membership': '#3f51b5',
      'affiliation': '#e91e63', 'leadership': '#8e44ad', 'collaboration': '#1abc9c',
      'person-affiliation': '#ffab40', 'industry peer': '#78909c',
      'affiliate': '#42a5f5', 'communal partner': '#4db6ac',
      'heritage partner': '#ab47bc', 'funder': '#ffa726',
      'community institution': '#66bb6a', 'religious partner': '#ce93d8',
      'umbrella body': '#5c6bc0', 'member': '#26a69a',
      'museum peer': '#7e57c2', 'cultural partner': '#ec407a',
      'regional connection': '#8d6e63', 'educational partner': '#29b6f6',
      'government partner': '#ef5350', 'sports affiliate': '#ff7043',
      'operating body': '#26c6da', 'governing body': '#d4e157',
      'preservation partner': '#9ccc65', 'support': '#7986cb',
      'diplomatic partner': '#f06292', 'historical support': '#a1887f',
      'parent organization': '#4fc3f7', 'research partner': '#ba68c8'
    };
    const DEC = '#90a4ae';

    // ─── State ───────────────────────────────────────────
    let graph = null;
    let hoveredNode = null;
    let neighborMap = {};      // nodeId -> Set of neighbor nodeIds
    let neighborSet = new Set(); // current hover neighborhood
    let searchMatches = new Set();
    let nodeScale = 6;
    let linkDist = 100;
    let mouseX = 0, mouseY = 0;
    const tipEl = document.getElementById('tip');
    const container = document.getElementById('graph-container');

    // Track mouse on document (not just container) so coordinates are always fresh
    // even if force-graph's canvas captures events before they bubble
    document.addEventListener('mousemove', e => {
      mouseX = e.clientX;
      mouseY = e.clientY;
      if (tipEl.style.display === 'block') {
        tipEl.style.left = Math.min(mouseX + 15, window.innerWidth - 360) + 'px';
        tipEl.style.top = Math.min(mouseY - 10, window.innerHeight - 120) + 'px';
      }
    });

    // Hide tooltip when mouse leaves the graph area entirely
    document.querySelector('.graph-wrap').addEventListener('mouseleave', () => {
      tipEl.style.display = 'none';
      hoveredNode = null;
      neighborSet.clear();
    });

    // ─── Populate dropdowns ──────────────────────────────
    let catOk = 0, cOk = 0;
    function tryLoad() { if (catOk && cOk) loadGraph(); }

    fetch('/api/jewish/categories').then(r=>r.json()).then(d => {
      const s = document.getElementById('f-cat');
      Object.keys(d.categories).sort().forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c + ' (' + d.categories[c].count + ')';
        s.appendChild(o);
      });
      catOk = 1; tryLoad();
    });
    fetch('/api/countries').then(r=>r.json()).then(d => {
      const s = document.getElementById('f-country');
      (Array.isArray(d) ? d : d.countries || []).sort().forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        s.appendChild(o);
      });
      cOk = 1; tryLoad();
    });

    // ─── Custom node rendering ───────────────────────────
    function renderNode(node, ctx, globalScale) {
      if (node.x == null || node.y == null) return;

      const s = nodeScale;
      let size;
      if (node.nodeType === 'person') {
        size = Math.max(s * 0.4, s * 0.4 + (node._degree || 0) * (s * 0.05));
      } else {
        size = Math.max(s * 0.6, s * 0.6 + (node._degree || 0) * (s * 0.07));
      }
      node._renderedSize = size;

      const isHovered = node === hoveredNode;
      const isNeighbor = hoveredNode && neighborSet.has(node.id);
      const dimByHover = hoveredNode && !isHovered && !isNeighbor;
      const dimBySearch = searchMatches.size > 0 && !node._found;
      const shouldDim = dimByHover || dimBySearch;

      ctx.save();
      ctx.globalAlpha = shouldDim ? 0.06 : 1;

      // Shape
      ctx.beginPath();
      if (node.nodeType === 'person') {
        // Diamond
        ctx.moveTo(node.x, node.y - size);
        ctx.lineTo(node.x + size * 0.75, node.y);
        ctx.lineTo(node.x, node.y + size);
        ctx.lineTo(node.x - size * 0.75, node.y);
        ctx.closePath();
      } else {
        // Circle
        ctx.arc(node.x, node.y, size, 0, Math.PI * 2);
      }
      ctx.fillStyle = node._color || DC;
      ctx.fill();

      // Border
      if (isHovered) {
        ctx.strokeStyle = '#0056b3';
        ctx.lineWidth = 2.5 / globalScale;
        ctx.stroke();
      } else if (node._found) {
        ctx.strokeStyle = '#ffeb3b';
        ctx.lineWidth = 2 / globalScale;
        ctx.stroke();
      } else if (!shouldDim) {
        ctx.strokeStyle = 'rgba(0,0,0,0.12)';
        ctx.lineWidth = 0.4 / globalScale;
        ctx.stroke();
      }

      // Label
      const showLabel = !shouldDim && (
        isHovered ||
        isNeighbor ||
        node._found ||
        ((node._degree || 0) > 12 && globalScale > 0.6) ||
        ((node._degree || 0) > 6 && globalScale > 1.2) ||
        ((node._degree || 0) > 2 && globalScale > 2.5) ||
        globalScale > 4
      );

      if (showLabel) {
        const fontSize = Math.max(3, (isHovered ? 12 : 10) / globalScale);
        ctx.font = (isHovered ? 'bold ' : '') + fontSize + 'px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';

        const label = node.name || '';
        const textW = ctx.measureText(label).width;
        const textH = fontSize;
        const pad = 1.5 / globalScale;
        const textY = node.y + size + 2 / globalScale;

        // Label background
        ctx.fillStyle = 'rgba(255,255,255,0.88)';
        ctx.fillRect(node.x - textW / 2 - pad, textY - pad, textW + pad * 2, textH + pad * 2);

        // Label text
        ctx.fillStyle = isHovered ? '#0056b3' : '#333';
        ctx.fillText(label, node.x, textY);
      }

      ctx.restore();
    }

    // ─── Node pointer area ───────────────────────────────
    function paintNodeArea(node, color, ctx) {
      // Extra padding (+6) for easier hover detection on small nodes
      const size = (node._renderedSize || nodeScale * 0.6) + 6;
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(node.x, node.y, size, 0, Math.PI * 2);
      ctx.fill();
    }

    // ─── Link accessors ──────────────────────────────────
    function lSrc(link) { return typeof link.source === 'object' ? link.source.id : link.source; }
    function lTgt(link) { return typeof link.target === 'object' ? link.target.id : link.target; }

    function linkWidthFn(link) {
      if (hoveredNode) {
        const s = lSrc(link), t = lTgt(link);
        if (s === hoveredNode.id || t === hoveredNode.id) return 1.8;
        return 0.08;
      }
      if (searchMatches.size > 0) {
        const s = lSrc(link), t = lTgt(link);
        if (searchMatches.has(s) || searchMatches.has(t)) return 1;
        return 0.05;
      }
      return link._width || 0.5;
    }

    function linkColorFn(link) {
      if (hoveredNode) {
        const s = lSrc(link), t = lTgt(link);
        if (s === hoveredNode.id || t === hoveredNode.id) return link._color || DEC;
        return 'rgba(180,180,180,0.04)';
      }
      if (searchMatches.size > 0) {
        const s = lSrc(link), t = lTgt(link);
        if (searchMatches.has(s) || searchMatches.has(t)) return link._color || DEC;
        return 'rgba(180,180,180,0.06)';
      }
      return link._color || DEC;
    }

    // ─── Initialize graph ────────────────────────────────
    function initGraph(nodeCount) {
      const rect = container.getBoundingClientRect();
      const nc = nodeCount || 200;

      graph = ForceGraph()(container)
        .width(rect.width)
        .height(rect.height)
        .backgroundColor('#fff')
        .nodeCanvasObject(renderNode)
        .nodeCanvasObjectMode(() => 'replace')
        .nodePointerAreaPaint(paintNodeArea)
        .linkWidth(linkWidthFn)
        .linkColor(linkColorFn)
        .linkLineDash(link => (link.type === 'person-affiliation') ? [2, 2] : null)
        .cooldownTime(22000)
        .warmupTicks(nc > 600 ? 350 : nc > 300 ? 250 : 180)
        .d3AlphaDecay(0.018)
        .d3VelocityDecay(0.3)
        .d3AlphaMin(0.005)
        .autoPauseRedraw(false)
        .nodeLabel(node => '') // suppress default title tooltip (we use custom #tip)
        .onNodeHover(handleNodeHover)
        .onNodeClick(handleNodeClick)
        .onLinkHover(handleLinkHover)
        .onBackgroundClick(handleBgClick)
        .enableNodeDrag(true);

      // Charge: strong many-body repulsion to push nodes apart
      graph.d3Force('charge')
        .strength(nc > 600 ? -200 : nc > 300 ? -280 : -350)
        .distanceMax(nc > 600 ? 500 : 800);

      // Link distance varies by type
      graph.d3Force('link')
        .distance(link => {
          if (link.type === 'person-affiliation') return linkDist * 1.8;
          if (link.type === 'shared-person') return linkDist * 0.8;
          return linkDist;
        })
        .strength(link => {
          if (link.type === 'person-affiliation') return 0.15;
          return 0.5;
        });

      // Collision force: prevent node overlap — radii include label space
      graph.d3Force('collide', d3.forceCollide()
        .radius(node => {
          if (node.nodeType === 'person') return nodeScale * 1.2 + 8;
          return nodeScale * 1.5 + 10;
        })
        .strength(0.9)
        .iterations(4)
      );

      // Resize handler
      window.addEventListener('resize', () => {
        const r = container.getBoundingClientRect();
        graph.width(r.width).height(r.height);
      });
    }

    // ─── Event handlers ──────────────────────────────────
    function handleNodeHover(node) {
      hoveredNode = node;
      neighborSet.clear();
      container.style.cursor = node ? 'pointer' : 'default';

      if (node) {
        neighborSet.add(node.id);
        const nb = neighborMap[node.id];
        if (nb) nb.forEach(id => neighborSet.add(id));

        // Tooltip
        let html;
        if (node.nodeType === 'person') {
          html = '<strong><i class="fa-solid fa-user"></i> ' + node.name + '</strong><br/>'
            + '<i class="fa-solid fa-briefcase"></i> ' + (node.role || 'Individual') + '<br/>'
            + '<i class="fa-solid fa-globe"></i> ' + (node.country || '')
            + '<br/><span style="color:#666;font-size:0.85em">' + (node._degree || 0) + ' connections</span>';
        } else {
          html = '<strong>' + node.name + '</strong><br/>'
            + '<i class="fa-solid fa-building"></i> ' + (node.type || node.entryType || '') + '<br/>'
            + '<i class="fa-solid fa-globe"></i> ' + (node.country || '') + '<br/>'
            + '<span class="tip-cat" style="background:' + (CC[node.category] || DC) + '30;color:' + (CC[node.category] || DC) + '">' + (node.category || '') + '</span>'
            + '<br/><span style="color:#666;font-size:0.85em">' + (node._degree || 0) + ' connections</span>';
        }
        tipEl.innerHTML = html;
        tipEl.style.display = 'block';
        tipEl.style.left = Math.min(mouseX + 15, window.innerWidth - 360) + 'px';
        tipEl.style.top = Math.min(mouseY - 10, window.innerHeight - 120) + 'px';
      } else {
        tipEl.style.display = 'none';
      }
    }

    function handleNodeClick(node) {
      if (!node) return;
      if (node.nodeType === 'person') {
        window.location.href = 'person.html?id=' + encodeURIComponent(node.personId || node.id);
      } else {
        window.location.href = 'entry.html?religion=jewish&id=' + encodeURIComponent(node.id);
      }
    }

    function handleLinkHover(link) {
      if (link) {
        tipEl.innerHTML = '<strong>' + (link.type || 'related') + '</strong>'
          + (link.description ? '<br/>' + link.description : '');
        tipEl.style.display = 'block';
        tipEl.style.left = Math.min(mouseX + 15, window.innerWidth - 360) + 'px';
        tipEl.style.top = Math.min(mouseY - 10, window.innerHeight - 120) + 'px';
      } else if (!hoveredNode) {
        tipEl.style.display = 'none';
      }
    }

    function handleBgClick() {
      // Clear search highlights on background click
      searchMatches.clear();
      if (graph) {
        graph.graphData().nodes.forEach(n => { n._found = false; });
      }
      document.getElementById('s-count').textContent = '';
      document.getElementById('s-input').value = '';
    }

    // ─── Load graph data ─────────────────────────────────
    function loadGraph() {
      const country = document.getElementById('f-country').value;
      const cat = document.getElementById('f-cat').value;
      const ppl = document.getElementById('show-people').checked;
      let url = '/api/graph?people=' + (ppl ? '1' : '0');
      if (country) url += '&country=' + encodeURIComponent(country);
      if (cat) url += '&category=' + encodeURIComponent(cat);

      const ld = document.getElementById('loading');
      const lt = document.getElementById('ld-text');
      ld.classList.remove('off');
      lt.textContent = 'Fetching graph data...';
      document.getElementById('stats').innerHTML = '<b>Loading...</b>';

      fetch(url).then(r => r.json()).then(data => {
        lt.textContent = 'Rendering ' + data.nodes.length + ' nodes...';
        setTimeout(() => buildGraph(data), 30);
      }).catch(err => {
        console.error('Failed to load graph data:', err);
        lt.textContent = 'Error loading data.';
      });
    }

    function buildGraph(data) {
      // Compute degree
      const degreeMap = {};
      data.nodes.forEach(n => { degreeMap[n.id] = 0; });
      data.links.forEach(l => {
        degreeMap[l.source] = (degreeMap[l.source] || 0) + 1;
        degreeMap[l.target] = (degreeMap[l.target] || 0) + 1;
      });

      // Build neighbor map (before d3-force mutates source/target)
      neighborMap = {};
      data.nodes.forEach(n => { neighborMap[n.id] = new Set(); });
      data.links.forEach(l => {
        if (neighborMap[l.source]) neighborMap[l.source].add(l.target);
        if (neighborMap[l.target]) neighborMap[l.target].add(l.source);
      });

      // Assign computed properties to nodes
      data.nodes.forEach(n => {
        n._degree = degreeMap[n.id] || 0;
        n._color = n.nodeType === 'person' ? PC : (CC[n.category] || DC);
        n._found = false;
      });

      // Assign computed properties to links
      data.links.forEach(l => {
        l._color = EC[l.type] || DEC;
        l._width = l.type === 'person-affiliation' ? 0.3 : 0.5;
      });

      // Stats
      const entries = data.nodes.filter(n => n.nodeType !== 'person');
      const people = data.nodes.filter(n => n.nodeType === 'person');
      document.getElementById('stats').innerHTML =
        '<b>' + entries.length + '</b> entries · <b>' + people.length + '</b> people · <b>' + data.links.length + '</b> links';

      // Category legend
      const cats = [...new Set(data.nodes.map(n => n.category))].filter(Boolean).sort();
      const catB = document.getElementById('cat-b');
      catB.innerHTML = '';
      cats.forEach(c => {
        const r = document.createElement('div'); r.className = 'li';
        const d = document.createElement('div'); d.className = 'ld';
        d.style.background = CC[c] || DC;
        if (c === 'People') { d.style.borderRadius = '2px'; d.style.transform = 'rotate(45deg)'; }
        r.appendChild(d);
        const txt = document.createTextNode(c);
        r.appendChild(txt);
        // Click category to highlight
        r.onclick = function() {
          searchMatches.clear();
          graph.graphData().nodes.forEach(n => { n._found = false; });
          graph.graphData().nodes.forEach(n => {
            if (n.category === c) { n._found = true; searchMatches.add(n.id); }
          });
          document.getElementById('s-count').textContent = searchMatches.size + ' in ' + c;
          document.getElementById('s-input').value = '';
          graph.zoomToFit(400, 50, n => n._found);
        };
        catB.appendChild(r);
      });

      // Edge legend
      const eTypes = [...new Set(data.links.map(l => l.type).filter(Boolean))].sort();
      const edgeB = document.getElementById('edge-b');
      edgeB.innerHTML = '';
      eTypes.forEach(t => {
        const r = document.createElement('div'); r.className = 'ei';
        const l = document.createElement('div'); l.className = 'el';
        l.style.background = EC[t] || DEC;
        r.appendChild(l);
        r.appendChild(document.createTextNode(t));
        edgeB.appendChild(r);
      });

      // Clear search state
      searchMatches.clear();
      hoveredNode = null;
      neighborSet.clear();

      // Init graph instance if needed
      const nodeCount = data.nodes.length;
      if (!graph) initGraph(nodeCount);

      // Feed data - d3-force simulation starts automatically & asynchronously
      graph.graphData(data);

      // Update forces for current data
      graph.d3Force('charge')
        .strength(nodeCount > 600 ? -200 : nodeCount > 300 ? -280 : -350)
        .distanceMax(nodeCount > 600 ? 500 : 800);

      graph.d3Force('link')
        .distance(link => {
          const lt = (typeof link.type === 'string') ? link.type : '';
          if (lt === 'person-affiliation') return linkDist * 1.8;
          if (lt === 'shared-person') return linkDist * 0.8;
          return linkDist;
        });

      // Update collision radii
      graph.d3Force('collide')
        .radius(node => {
          if (node.nodeType === 'person') return nodeScale * 1.2 + 8;
          return nodeScale * 1.5 + 10;
        });

      graph.d3ReheatSimulation();

      // Hide loading overlay and zoom to fit
      setTimeout(() => {
        document.getElementById('loading').classList.add('off');
        graph.zoomToFit(600, 40);
      }, 800);
    }

    // ─── Controls ────────────────────────────────────────
    document.getElementById('btn-reload').onclick = loadGraph;

    document.getElementById('btn-fit').onclick = () => {
      if (graph) {
        graph.zoomToFit(400, 40);
        graph.d3ReheatSimulation();
      }
    };

    document.getElementById('show-people').onchange = loadGraph;
    document.getElementById('f-country').onchange = loadGraph;
    document.getElementById('f-cat').onchange = loadGraph;

    document.getElementById('node-scale').oninput = function() {
      nodeScale = +this.value;
      if (graph && graph.d3Force('collide')) {
        graph.d3Force('collide').radius(node => {
          if (node.nodeType === 'person') return nodeScale * 1.2 + 8;
          return nodeScale * 1.5 + 10;
        });
        graph.d3ReheatSimulation();
      }
    };

    document.getElementById('link-dist').oninput = function() {
      linkDist = +this.value;
      if (graph) {
        graph.d3Force('link').distance(link => {
          const lt = (typeof link.type === 'string') ? link.type : '';
          if (lt === 'person-affiliation') return linkDist * 1.8;
          if (lt === 'shared-person') return linkDist * 0.8;
          return linkDist;
        });
        graph.d3ReheatSimulation();
      }
    };

    // ─── Search ──────────────────────────────────────────
    function doSearch() {
      const q = document.getElementById('s-input').value.trim().toLowerCase();
      if (!graph) return;

      searchMatches.clear();
      graph.graphData().nodes.forEach(n => { n._found = false; });

      if (!q) {
        document.getElementById('s-count').textContent = '';
        return;
      }

      const matches = graph.graphData().nodes.filter(n =>
        (n.name || '').toLowerCase().includes(q)
      );
      matches.forEach(n => { n._found = true; searchMatches.add(n.id); });

      const count = matches.length;
      document.getElementById('s-count').textContent = count ? count + ' found' : 'none';

      if (count) {
        graph.zoomToFit(400, 50, n => n._found);
      }
    }

    document.getElementById('s-btn').onclick = doSearch;
    document.getElementById('s-input').onkeydown = function(e) { if (e.key === 'Enter') doSearch(); };
    document.getElementById('s-input').oninput = function() {
      if (!this.value.trim()) {
        searchMatches.clear();
        if (graph) graph.graphData().nodes.forEach(n => { n._found = false; });
        document.getElementById('s-count').textContent = '';
      }
    };
  </script>
</body>
</html>
