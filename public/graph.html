<!-- Juice Project - Est. 2016 | Last updated 2025 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <meta name="created" content="2016-03-14">
  <meta name="author" content="Juice Project">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Graph</title>

  <!-- Cytoscape.js — Canvas-based graph engine (handles 10k+ nodes) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
  <!-- fCoSE layout — overlap-free, compound-aware spring embedder -->
  <script src="https://unpkg.com/cytoscape-fcose@2.2.0/cytoscape-fcose.js"></script>

  <style>
    /* ===== BASE ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; color: #c8d6f0; background: #080818; display: flex; flex-direction: column; }

    /* ===== NAV ===== */
    nav { flex-shrink: 0; padding: 6px 12px; position: relative; z-index: 50; background: rgba(8,8,24,0.92); backdrop-filter: blur(14px); border-bottom: 1px solid rgba(80,100,220,0.14); }
    nav ul { list-style: none; display: flex; flex-wrap: wrap; gap: 4px 6px; justify-content: center; align-items: center; padding: 4px 0; }
    nav ul li { white-space: nowrap; }
    nav a { color: #7ea8e8 !important; text-decoration: none; padding: 3px 9px; border-radius: 5px; border: 1px solid rgba(80,100,220,0.18); font-size: 0.73em; display: inline-block; line-height: 1.3; background: rgba(25,25,55,0.55); transition: all 0.2s; }
    nav a:hover { background: rgba(50,65,160,0.35); border-color: rgba(80,100,220,0.4); color: #a5c8ff !important; }
    nav select { padding: 3px 8px; border-radius: 5px; border: 1px solid rgba(80,100,220,0.18); font-size: 0.73em; background: rgba(25,25,55,0.55); color: #7ea8e8; }

    /* ===== GRAPH WRAPPER ===== */
    .graph-wrap { flex: 1; position: relative; overflow: hidden; background: #080818; }
    #cy { position: absolute; inset: 0; width: 100%; height: 100%; }

    /* ===== SHARED PANEL ===== */
    .gp {
      background: rgba(10,10,28,0.93);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(80,100,220,0.14);
      border-radius: 10px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.5);
      overflow: hidden;
      transition: box-shadow 0.25s;
    }
    .gp:hover { box-shadow: 0 8px 36px rgba(0,0,0,0.6); }
    .gp-h {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 10px; cursor: pointer; user-select: none;
      background: rgba(35,42,100,0.2);
      border-bottom: 1px solid rgba(80,100,220,0.08);
      transition: background 0.2s;
    }
    .gp-h:hover { background: rgba(35,42,100,0.35); }
    .gp-h strong, .gp-h h3 { color: #7ea8e8; font-size: 0.78em; font-weight: 600; margin: 0; }
    .gp-h .chv { color: #5a7ad4; font-size: 0.6em; transition: transform 0.25s; }
    .gp.shut .gp-b { display: none; }
    .gp.shut .gp-h { border-bottom: none; }
    .gp.shut .chv { transform: rotate(180deg); }

    /* ===== CONTROLS (top-left) ===== */
    .hud-ctrl { position: absolute; top: 10px; left: 10px; z-index: 12; width: 210px; }
    .cb { padding: 7px 10px 9px; }
    .cb label { font-size: 0.73em; color: #7a8aaa; display: block; margin: 4px 0 1px; font-weight: 500; }
    .cb select { width: 100%; padding: 4px 6px; border-radius: 5px; border: 1px solid rgba(80,100,220,0.16); background: rgba(14,14,38,0.85); color: #a0b8d8; font-size: 0.77em; outline: none; }
    .cb select:focus { border-color: #5a7ad4; }
    .cb input[type="range"] { width: 100%; margin: 2px 0; accent-color: #5a7ad4; }
    .cb .chks { display: flex; gap: 10px; margin: 5px 0 2px; }
    .cb .chks label { display: flex; align-items: center; gap: 3px; font-size: 0.73em; color: #7a8aaa; cursor: pointer; margin: 0; }
    .cb .chks input[type="checkbox"] { accent-color: #5a7ad4; }
    .cb .btns { display: flex; gap: 5px; margin-top: 5px; }
    .cb .btns button { flex: 1; padding: 4px 0; border-radius: 5px; border: 1px solid rgba(80,100,220,0.16); background: rgba(35,42,100,0.22); color: #7ea8e8; font-size: 0.73em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .cb .btns button:hover { background: rgba(50,65,160,0.35); }
    .cb .layout-row { margin-top: 5px; }
    .cb .layout-row label { margin-bottom: 2px; }
    .cb .layout-row select { font-size: 0.74em; }

    /* ===== SEARCH (top-center) ===== */
    .hud-search { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 12; display: flex; align-items: center; }
    .hud-search input { padding: 5px 11px; border: 1px solid rgba(80,100,220,0.2); border-radius: 6px 0 0 6px; font-size: 0.77em; width: 200px; outline: none; background: rgba(10,10,28,0.93); backdrop-filter: blur(20px); color: #a0b8d8; }
    .hud-search input::placeholder { color: #405070; }
    .hud-search input:focus { border-color: #5a7ad4; }
    .hud-search button { padding: 5px 9px; border: 1px solid rgba(80,100,220,0.2); border-left: none; border-radius: 0 6px 6px 0; background: rgba(35,42,100,0.35); color: #7ea8e8; cursor: pointer; font-size: 0.77em; transition: background 0.2s; }
    .hud-search button:hover { background: rgba(50,65,160,0.45); }
    .hud-search .sc { padding: 0 7px; font-size: 0.71em; color: #5a7ad4; white-space: nowrap; }

    /* ===== STATS (top-right) ===== */
    .hud-stats { position: absolute; top: 10px; right: 10px; z-index: 12; }
    .sb { background: rgba(10,10,28,0.93); backdrop-filter: blur(20px); border: 1px solid rgba(80,100,220,0.14); border-radius: 8px; padding: 5px 11px; font-size: 0.74em; color: #7a8aaa; box-shadow: 0 4px 14px rgba(0,0,0,0.35); white-space: nowrap; }
    .sb b { color: #5a7ad4; font-weight: 700; }

    /* ===== CATEGORY LEGEND (bottom-left) ===== */
    .hud-cat { position: absolute; bottom: 10px; left: 10px; z-index: 12; width: 190px; }
    .cat-b { padding: 4px 10px 7px; max-height: 180px; overflow-y: auto; }
    .li { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #7a8aaa; margin: 1px 0; cursor: pointer; padding: 1px 2px; border-radius: 3px; transition: background 0.15s; }
    .li:hover { background: rgba(80,100,220,0.1); }
    .ld { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    /* ===== EDGE LEGEND (bottom-right) ===== */
    .hud-edge { position: absolute; bottom: 10px; right: 10px; z-index: 12; width: 172px; }
    .edge-b { padding: 3px 10px 7px; max-height: 210px; overflow-y: auto; }
    .ei { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #7a8aaa; margin: 1.5px 0; }
    .el { width: 15px; height: 3px; border-radius: 2px; flex-shrink: 0; }

    /* ===== SCROLLBAR ===== */
    .cat-b::-webkit-scrollbar, .edge-b::-webkit-scrollbar { width: 4px; }
    .cat-b::-webkit-scrollbar-track, .edge-b::-webkit-scrollbar-track { background: transparent; }
    .cat-b::-webkit-scrollbar-thumb, .edge-b::-webkit-scrollbar-thumb { background: rgba(80,100,220,0.2); border-radius: 2px; }

    /* ===== TOOLTIP ===== */
    #tip {
      position: fixed; background: rgba(6,6,22,0.97); backdrop-filter: blur(16px);
      color: #d8e2f4; padding: 10px 14px; border-radius: 9px;
      border: 1px solid rgba(80,100,220,0.2); font-size: 0.79em;
      pointer-events: none; z-index: 200; max-width: 340px;
      line-height: 1.55; display: none;
      box-shadow: 0 8px 28px rgba(0,0,0,0.6);
    }
    #tip strong { color: #a5c8ff; }
    #tip .tip-cat { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.85em; margin-top: 3px; }

    /* ===== LOADING ===== */
    .ld-overlay {
      position: absolute; inset: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 12px;
      background: rgba(8,8,24,0.75); z-index: 25; transition: opacity 0.5s;
    }
    .ld-overlay.off { opacity: 0; pointer-events: none; }
    .ld-spinner { width: 38px; height: 38px; border: 3px solid rgba(80,100,220,0.1); border-top-color: #5a7ad4; border-radius: 50%; animation: spin 0.75s linear infinite; }
    .ld-text { color: #5a7ad4; font-size: 0.82em; font-weight: 500; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) {
      .hud-search input { width: 135px; }
      .hud-ctrl { width: 180px; }
      .hud-cat { width: 160px; }
      .hud-edge { width: 148px; }
    }
    @media (max-width: 600px) {
      .hud-search { display: none; }
      .hud-ctrl { width: 160px; }
      .hud-cat, .hud-edge { width: 135px; }
    }
  </style>
</head>
<body>
  <nav id="navbar"></nav>

  <div class="graph-wrap">
    <!-- Cytoscape canvas container -->
    <div id="cy"></div>

    <!-- Loading -->
    <div class="ld-overlay" id="loading">
      <div class="ld-spinner"></div>
      <div class="ld-text" id="ld-text">Loading graph data...</div>
    </div>

    <!-- HUD: Controls -->
    <div class="hud-ctrl">
      <div class="gp" id="ctrl-p">
        <div class="gp-h" id="ctrl-t">
          <h3><i class="fa-solid fa-sliders"></i> Controls</h3>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cb">
          <label>Country</label>
          <select id="f-country"><option value="">All Countries</option></select>
          <label>Category</label>
          <select id="f-cat"><option value="">All Categories</option></select>
          <div class="layout-row">
            <label>Layout Algorithm</label>
            <select id="f-layout">
              <option value="fcose" selected>fCoSE (best spread)</option>
              <option value="cose">CoSE (fast)</option>
              <option value="circle">Circle</option>
              <option value="concentric">Concentric</option>
              <option value="grid">Grid</option>
            </select>
          </div>
          <label>Node Scale</label>
          <input type="range" id="node-scale" min="5" max="40" value="14" />
          <div class="chks">
            <label><input type="checkbox" id="show-people" /> People</label>
            <label><input type="checkbox" id="show-labels" checked /> Labels</label>
          </div>
          <div class="btns">
            <button id="btn-reload"><i class="fa-solid fa-rotate"></i> Reload</button>
            <button id="btn-fit"><i class="fa-solid fa-expand"></i> Fit</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HUD: Search -->
    <div class="hud-search">
      <input type="text" id="s-input" placeholder="Search nodes..." />
      <button id="s-btn"><i class="fa-solid fa-search"></i></button>
      <span class="sc" id="s-count"></span>
    </div>

    <!-- HUD: Stats -->
    <div class="hud-stats">
      <div class="sb" id="stats"><b>Loading...</b></div>
    </div>

    <!-- HUD: Category legend -->
    <div class="hud-cat">
      <div class="gp" id="cat-p">
        <div class="gp-h" id="cat-t">
          <strong><i class="fa-solid fa-palette"></i> Categories</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cat-b" id="cat-b"></div>
      </div>
    </div>

    <!-- HUD: Edge legend -->
    <div class="hud-edge">
      <div class="gp" id="edge-p">
        <div class="gp-h" id="edge-t">
          <strong><i class="fa-solid fa-link"></i> Connections</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b edge-b" id="edge-b"></div>
      </div>
    </div>

    <!-- Tooltip -->
    <div id="tip"></div>
  </div>

  <script src="app.js"></script>
  <script>
    initPage('jewish');
    setSEO({ title: 'Network Graph - Juice Project', description: 'Interactive network visualization.' });

    // ─── Collapsible panels ──────────────────────────────
    ['ctrl','cat','edge'].forEach(k => {
      document.getElementById(k+'-t').onclick = () => document.getElementById(k+'-p').classList.toggle('shut');
    });

    // ─── Color maps ──────────────────────────────────────
    const CC = {
      'Entertainment & Media': '#e74c3c', 'Religion & Synagogues': '#9b59b6',
      'Culture & Arts': '#e67e22', 'Technology': '#2ecc71',
      'Community & Social Organizations': '#3498db', 'Education & Academia': '#1abc9c',
      'Representative & Umbrella Bodies': '#f39c12', 'Heritage & Memorials': '#8e44ad',
      'Charity & Philanthropy': '#e91e63', 'Investment & Private Equity': '#00bcd4',
      'Real Estate & Property': '#795548', 'Sports': '#ff5722',
      'Advocacy & Public Affairs': '#607d8b', 'Healthcare & Pharmaceuticals': '#4caf50',
      'Banking & Financial Services': '#ff9800', 'Research & Think Tanks': '#673ab7',
      'Retail & E-Commerce': '#009688', 'Defense & Security': '#f44336',
      'Food & Beverage': '#8bc34a', 'Conglomerates & Holding Companies': '#9e9e9e',
      'Government & Diplomacy': '#3f51b5', 'Fashion & Consumer Goods': '#ff4081',
      'Manufacturing & Industry': '#757575', 'Law Firms': '#455a64',
      'Notable Individuals': '#ffc107', 'Transportation': '#00acc1',
      'Advertising & PR': '#d81b60', 'Telecommunications': '#7c4dff',
      'Utilities & Energy': '#66bb6a', 'People': '#ffab40'
    };
    const DC = '#546e7a', PC = '#ffab40';

    const EC = {
      'financial': '#ff9800', 'shared-person': '#9c27b0', 'political': '#f44336',
      'organizational': '#2196f3', 'ideological': '#4caf50', 'historical': '#795548',
      'legal': '#607d8b', 'related': '#78909c', 'partnership': '#00bcd4',
      'subsidiary': '#ff5722', 'funding': '#ffc107', 'membership': '#3f51b5',
      'affiliation': '#e91e63', 'leadership': '#8e44ad', 'collaboration': '#1abc9c',
      'person-affiliation': '#ffab40', 'industry peer': '#78909c',
      'affiliate': '#42a5f5', 'communal partner': '#4db6ac',
      'heritage partner': '#ab47bc', 'funder': '#ffa726',
      'community institution': '#66bb6a', 'religious partner': '#ce93d8',
      'umbrella body': '#5c6bc0', 'member': '#26a69a',
      'museum peer': '#7e57c2', 'cultural partner': '#ec407a',
      'regional connection': '#8d6e63', 'educational partner': '#29b6f6',
      'government partner': '#ef5350', 'sports affiliate': '#ff7043',
      'operating body': '#26c6da', 'governing body': '#d4e157',
      'preservation partner': '#9ccc65', 'support': '#7986cb',
      'diplomatic partner': '#f06292', 'historical support': '#a1887f',
      'parent organization': '#4fc3f7', 'research partner': '#ba68c8'
    };
    const DEC = '#2a2a44';

    // ─── Populate dropdowns ──────────────────────────────
    let catOk = 0, cOk = 0;
    function tryLoad() { if (catOk && cOk) loadGraph(); }

    fetch('/api/jewish/categories').then(r=>r.json()).then(d => {
      const s = document.getElementById('f-cat');
      Object.keys(d.categories).sort().forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c + ' (' + d.categories[c].count + ')';
        s.appendChild(o);
      });
      catOk = 1; tryLoad();
    });
    fetch('/api/countries').then(r=>r.json()).then(d => {
      const s = document.getElementById('f-country');
      (Array.isArray(d) ? d : d.countries || []).sort().forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        s.appendChild(o);
      });
      cOk = 1; tryLoad();
    });

    // ─── Cytoscape instance ─────────────────────────────
    let cy = null;

    function loadGraph() {
      const country = document.getElementById('f-country').value;
      const cat = document.getElementById('f-cat').value;
      const ppl = document.getElementById('show-people').checked;
      let url = '/api/graph?people=' + (ppl ? '1' : '0');
      if (country) url += '&country=' + encodeURIComponent(country);
      if (cat) url += '&category=' + encodeURIComponent(cat);

      const ld = document.getElementById('loading');
      const lt = document.getElementById('ld-text');
      ld.classList.remove('off');
      lt.textContent = 'Fetching graph data...';
      document.getElementById('stats').innerHTML = '<b>Loading...</b>';

      fetch(url).then(r => r.json()).then(data => {
        lt.textContent = 'Building layout for ' + data.nodes.length + ' nodes...';
        // Small delay so loading text renders before heavy computation
        setTimeout(() => buildGraph(data), 60);
      });
    }

    function buildGraph(data) {
      // Convert API data to Cytoscape format
      const elements = [];
      const edgeIdCounter = {};

      data.nodes.forEach(n => {
        elements.push({
          group: 'nodes',
          data: {
            id: n.id, name: n.name, category: n.category || '',
            country: n.country || '', entryType: n.type || '',
            nodeType: n.nodeType || 'entry', personId: n.personId || '',
            role: n.role || '', color: n.nodeType === 'person' ? PC : (CC[n.category] || DC)
          }
        });
      });

      data.links.forEach(l => {
        const key = l.source + '|' + l.target + '|' + (l.type||'');
        edgeIdCounter[key] = (edgeIdCounter[key] || 0) + 1;
        elements.push({
          group: 'edges',
          data: {
            id: key + '#' + edgeIdCounter[key],
            source: l.source, target: l.target,
            edgeType: l.type || 'related',
            description: l.description || '',
            color: EC[l.type] || DEC
          }
        });
      });

      const entryNodes = data.nodes.filter(n => n.nodeType !== 'person');
      const personNodes = data.nodes.filter(n => n.nodeType === 'person');
      const totalNodes = data.nodes.length;

      // Stats
      document.getElementById('stats').innerHTML =
        '<b>' + entryNodes.length + '</b> entries · <b>' + personNodes.length + '</b> people · <b>' + data.links.length + '</b> links';

      // Category legend
      const cats = [...new Set(data.nodes.map(n => n.category))].filter(Boolean).sort();
      const catB = document.getElementById('cat-b');
      catB.innerHTML = '';
      cats.forEach(c => {
        const r = document.createElement('div'); r.className = 'li';
        const d = document.createElement('div'); d.className = 'ld';
        d.style.background = CC[c] || DC;
        if (c === 'People') { d.style.borderRadius = '2px'; d.style.transform = 'rotate(45deg)'; }
        r.appendChild(d);
        r.appendChild(document.createTextNode(c));
        catB.appendChild(r);
      });

      // Edge legend
      const eTypes = [...new Set(data.links.map(l => l.type).filter(Boolean))].sort();
      const edgeB = document.getElementById('edge-b');
      edgeB.innerHTML = '';
      eTypes.forEach(t => {
        const r = document.createElement('div'); r.className = 'ei';
        const l = document.createElement('div'); l.className = 'el';
        l.style.background = EC[t] || DEC;
        r.appendChild(l);
        r.appendChild(document.createTextNode(t));
        edgeB.appendChild(r);
      });

      // Destroy previous instance
      if (cy) { cy.destroy(); cy = null; }

      // ── Layout config ──
      const layoutName = document.getElementById('f-layout').value;
      const baseScale = +document.getElementById('node-scale').value;
      let layoutOpts;

      if (layoutName === 'fcose') {
        layoutOpts = {
          name: 'fcose',
          quality: totalNodes > 1500 ? 'default' : 'default',
          randomize: true,
          animate: false,
          fit: true,
          padding: 40,
          nodeDimensionsIncludeLabels: false,
          uniformNodeDimensions: false,
          packComponents: true,
          nodeRepulsion: totalNodes > 1500 ? 12000 : 8000,
          idealEdgeLength: totalNodes > 1500 ? 120 : 90,
          edgeElasticity: 0.4,
          nestingFactor: 0.1,
          gravity: 0.2,
          gravityRange: 3.8,
          numIter: totalNodes > 1500 ? 3000 : 2500,
          tile: true,
          tilingPaddingVertical: 20,
          tilingPaddingHorizontal: 20
        };
      } else if (layoutName === 'cose') {
        layoutOpts = {
          name: 'cose',
          animate: false,
          fit: true,
          padding: 40,
          nodeRepulsion: function() { return 9000; },
          idealEdgeLength: function() { return 100; },
          edgeElasticity: function() { return 100; },
          gravity: 0.3,
          numIter: 1500,
          nodeOverlap: 20
        };
      } else if (layoutName === 'concentric') {
        layoutOpts = {
          name: 'concentric',
          fit: true,
          padding: 30,
          concentric: function(node) { return node.degree(); },
          levelWidth: function() { return 3; },
          animate: false,
          minNodeSpacing: 20
        };
      } else if (layoutName === 'circle') {
        layoutOpts = { name: 'circle', fit: true, padding: 30, animate: false };
      } else {
        layoutOpts = { name: 'grid', fit: true, padding: 30, animate: false, condense: true };
      }

      // ── Create Cytoscape ──
      cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        wheelSensitivity: 0.3,
        minZoom: 0.02,
        maxZoom: 8,
        pixelRatio: 'auto',
        textureOnViewport: totalNodes > 800,
        hideEdgesOnViewport: totalNodes > 1200,
        hideLabelsOnViewport: totalNodes > 1500,

        style: [
          // Entry nodes
          {
            selector: 'node[nodeType = "entry"]',
            style: {
              'shape': 'ellipse',
              'background-color': 'data(color)',
              'border-width': 1,
              'border-color': 'rgba(180,200,255,0.2)',
              'width': function(n) { return Math.max(baseScale * 0.6, Math.min(baseScale * 2.5, baseScale * 0.6 + n.degree() * 1.2)); },
              'height': function(n) { return Math.max(baseScale * 0.6, Math.min(baseScale * 2.5, baseScale * 0.6 + n.degree() * 1.2)); },
              'label': 'data(name)',
              'font-size': function(n) { return Math.max(6, Math.min(11, 6 + n.degree() * 0.3)); },
              'color': '#8a9cc0',
              'text-valign': 'bottom',
              'text-halign': 'center',
              'text-margin-y': 3,
              'text-max-width': 90,
              'text-wrap': 'ellipsis',
              'min-zoomed-font-size': 10,
              'text-background-color': '#080818',
              'text-background-opacity': 0.7,
              'text-background-padding': '1px',
              'text-background-shape': 'roundrectangle',
              'transition-property': 'border-width, border-color, width, height',
              'transition-duration': '0.15s'
            }
          },
          // Person nodes
          {
            selector: 'node[nodeType = "person"]',
            style: {
              'shape': 'diamond',
              'background-color': PC,
              'border-width': 0.8,
              'border-color': 'rgba(255,200,100,0.25)',
              'width': function(n) { return Math.max(baseScale * 0.35, Math.min(baseScale * 1.5, baseScale * 0.35 + n.degree() * 0.8)); },
              'height': function(n) { return Math.max(baseScale * 0.35, Math.min(baseScale * 1.5, baseScale * 0.35 + n.degree() * 0.8)); },
              'label': 'data(name)',
              'font-size': 6,
              'color': '#7a8a60',
              'text-valign': 'bottom',
              'text-halign': 'center',
              'text-margin-y': 2,
              'text-max-width': 70,
              'text-wrap': 'ellipsis',
              'min-zoomed-font-size': 14,
              'text-background-color': '#080818',
              'text-background-opacity': 0.65,
              'text-background-padding': '1px',
              'text-background-shape': 'roundrectangle',
              'transition-property': 'border-width, border-color, width, height',
              'transition-duration': '0.15s'
            }
          },
          // Edges
          {
            selector: 'edge',
            style: {
              'line-color': 'data(color)',
              'width': function(e) { return e.data('edgeType') === 'person-affiliation' ? 0.4 : 0.8; },
              'opacity': function(e) { return e.data('edgeType') === 'person-affiliation' ? 0.12 : 0.28; },
              'curve-style': 'haystack',
              'haystack-radius': 0.5
            }
          },
          // Hover state for nodes
          {
            selector: 'node:active, node.hover',
            style: {
              'border-width': 3,
              'border-color': '#fff',
              'z-index': 999,
              'min-zoomed-font-size': 0,
              'text-background-opacity': 0.9
            }
          },
          // Highlighted neighbor edges
          {
            selector: 'edge.neighbor',
            style: {
              'opacity': 0.85,
              'width': 2,
              'z-index': 100
            }
          },
          // Highlighted neighbor nodes
          {
            selector: 'node.neighbor',
            style: {
              'border-width': 2,
              'border-color': '#a5c8ff',
              'min-zoomed-font-size': 0,
              'z-index': 100
            }
          },
          // Dimmed (non-neighbor) when a node is selected
          {
            selector: 'node.dimmed',
            style: { 'opacity': 0.12 }
          },
          {
            selector: 'edge.dimmed',
            style: { 'opacity': 0.03 }
          },
          // Search highlight
          {
            selector: 'node.found',
            style: {
              'border-width': 3,
              'border-color': '#ffeb3b',
              'z-index': 999,
              'min-zoomed-font-size': 0
            }
          }
        ],
        layout: layoutOpts
      });

      // ── Label visibility via checkbox ──
      if (!document.getElementById('show-labels').checked) {
        cy.nodes().style('label', '');
      }

      // ── Events ──

      // Hover: highlight neighborhood
      let hoverTimeout;
      cy.on('mouseover', 'node', function(e) {
        clearTimeout(hoverTimeout);
        const node = e.target;
        node.addClass('hover');
        // Show tooltip
        const d = node.data();
        const pos = e.renderedPosition || e.position;
        const rect = document.getElementById('cy').getBoundingClientRect();
        let html;
        if (d.nodeType === 'person') {
          html = '<strong><i class="fa-solid fa-user"></i> ' + d.name + '</strong><br/>'
            + '<i class="fa-solid fa-briefcase"></i> ' + (d.role || 'Individual') + '<br/>'
            + '<i class="fa-solid fa-globe"></i> ' + d.country
            + '<br/><span style="color:#7a8aaa;font-size:0.85em">' + node.degree() + ' connections</span>';
        } else {
          html = '<strong>' + d.name + '</strong><br/>'
            + '<i class="fa-solid fa-building"></i> ' + d.entryType + '<br/>'
            + '<i class="fa-solid fa-globe"></i> ' + d.country + '<br/>'
            + '<span class="tip-cat" style="background:' + (CC[d.category]||DC) + '30;color:' + (CC[d.category]||DC) + '">' + d.category + '</span>'
            + '<br/><span style="color:#7a8aaa;font-size:0.85em">' + node.degree() + ' connections</span>';
        }
        const tip = document.getElementById('tip');
        tip.innerHTML = html;
        tip.style.display = 'block';
        tip.style.left = Math.min(rect.left + pos.x + 18, window.innerWidth - 360) + 'px';
        tip.style.top = Math.min(rect.top + pos.y - 10, window.innerHeight - 120) + 'px';
      });

      cy.on('mouseout', 'node', function(e) {
        e.target.removeClass('hover');
        document.getElementById('tip').style.display = 'none';
        hoverTimeout = setTimeout(clearHighlight, 100);
      });

      // Click: focus neighborhood (dim everything else)
      cy.on('tap', 'node', function(e) {
        e.stopPropagation();
        const node = e.target;
        const d = node.data();

        // Double-tap = navigate
        if (node._lastTap && Date.now() - node._lastTap < 400) {
          if (d.nodeType === 'person') {
            window.open('person.html?id=' + encodeURIComponent(d.personId), '_blank');
          } else {
            window.open('entry.html?religion=jewish&id=' + encodeURIComponent(d.id), '_blank');
          }
          return;
        }
        node._lastTap = Date.now();

        // Focus neighborhood
        clearHighlight();
        const neighborhood = node.neighborhood().add(node);
        cy.elements().not(neighborhood).addClass('dimmed');
        neighborhood.edges().addClass('neighbor');
        neighborhood.nodes().not(node).addClass('neighbor');
        node.addClass('hover');
      });

      // Tap background = clear focus
      cy.on('tap', function(e) {
        if (e.target === cy) clearHighlight();
      });

      function clearHighlight() {
        cy.elements().removeClass('dimmed neighbor hover found');
      }

      // Edge hover tooltip
      cy.on('mouseover', 'edge', function(e) {
        const d = e.target.data();
        const pos = e.renderedPosition || { x: 0, y: 0 };
        const rect = document.getElementById('cy').getBoundingClientRect();
        const tip = document.getElementById('tip');
        tip.innerHTML = '<strong>' + d.edgeType + '</strong>' + (d.description ? '<br/>' + d.description : '');
        tip.style.display = 'block';
        tip.style.left = Math.min(rect.left + pos.x + 18, window.innerWidth - 360) + 'px';
        tip.style.top = Math.min(rect.top + pos.y - 10, window.innerHeight - 120) + 'px';
      });
      cy.on('mouseout', 'edge', function() {
        document.getElementById('tip').style.display = 'none';
      });

      // Layout done
      cy.one('layoutstop', function() {
        document.getElementById('loading').classList.add('off');
        cy.fit(undefined, 50);
      });

      // Fallback hide loading after timeout
      setTimeout(() => document.getElementById('loading').classList.add('off'), 15000);
    }

    // ─── Controls ────────────────────────────────────────
    document.getElementById('btn-reload').onclick = loadGraph;
    document.getElementById('btn-fit').onclick = () => { if (cy) cy.fit(undefined, 50); };
    document.getElementById('show-people').onchange = loadGraph;
    document.getElementById('f-country').onchange = loadGraph;
    document.getElementById('f-cat').onchange = loadGraph;
    document.getElementById('f-layout').onchange = function() {
      if (!cy) return;
      // Re-run layout without reloading data
      document.getElementById('loading').classList.remove('off');
      document.getElementById('ld-text').textContent = 'Recalculating layout...';
      setTimeout(() => {
        const name = this.value;
        let opts;
        const n = cy.nodes().length;
        if (name === 'fcose') {
          opts = { name:'fcose', randomize:true, animate:false, fit:true, padding:40,
            nodeRepulsion: n>1500?12000:8000, idealEdgeLength: n>1500?120:90,
            edgeElasticity:0.4, gravity:0.2, numIter: n>1500?3000:2500,
            tile:true, tilingPaddingVertical:20, tilingPaddingHorizontal:20 };
        } else if (name === 'cose') {
          opts = { name:'cose', animate:false, fit:true, padding:40,
            nodeRepulsion:()=>9000, idealEdgeLength:()=>100, gravity:0.3, numIter:1500, nodeOverlap:20 };
        } else if (name === 'concentric') {
          opts = { name:'concentric', fit:true, padding:30,
            concentric: nd=>nd.degree(), levelWidth:()=>3, animate:false, minNodeSpacing:20 };
        } else if (name === 'circle') {
          opts = { name:'circle', fit:true, padding:30, animate:false };
        } else {
          opts = { name:'grid', fit:true, padding:30, animate:false, condense:true };
        }
        const layout = cy.layout(opts);
        layout.one('layoutstop', () => {
          document.getElementById('loading').classList.add('off');
          cy.fit(undefined, 50);
        });
        layout.run();
        setTimeout(() => document.getElementById('loading').classList.add('off'), 15000);
      }, 60);
    };
    document.getElementById('show-labels').onchange = function() {
      if (!cy) return;
      if (this.checked) {
        cy.nodes('[nodeType = "entry"]').style('label', function(n){ return n.data('name'); });
        cy.nodes('[nodeType = "person"]').style('label', function(n){ return n.data('name'); });
      } else {
        cy.nodes().style('label', '');
      }
    };
    document.getElementById('node-scale').oninput = function() {
      if (!cy) return;
      const s = +this.value;
      cy.nodes('[nodeType = "entry"]').style({
        'width': function(n) { return Math.max(s*0.6, Math.min(s*2.5, s*0.6 + n.degree()*1.2)); },
        'height': function(n) { return Math.max(s*0.6, Math.min(s*2.5, s*0.6 + n.degree()*1.2)); }
      });
      cy.nodes('[nodeType = "person"]').style({
        'width': function(n) { return Math.max(s*0.35, Math.min(s*1.5, s*0.35 + n.degree()*0.8)); },
        'height': function(n) { return Math.max(s*0.35, Math.min(s*1.5, s*0.35 + n.degree()*0.8)); }
      });
    };

    // ─── Search ──────────────────────────────────────────
    function doSearch() {
      const q = document.getElementById('s-input').value.trim().toLowerCase();
      if (!cy) return;
      cy.elements().removeClass('found dimmed');
      if (!q) { document.getElementById('s-count').textContent = ''; return; }
      const matches = cy.nodes().filter(n => n.data('name').toLowerCase().includes(q));
      const count = matches.length;
      document.getElementById('s-count').textContent = count ? count + ' found' : 'none';
      if (count) {
        matches.addClass('found');
        cy.nodes().not(matches).addClass('dimmed');
        cy.edges().addClass('dimmed');
        // Fit camera to matches with padding
        cy.fit(matches, 80);
      }
    }
    document.getElementById('s-btn').onclick = doSearch;
    document.getElementById('s-input').onkeydown = function(e) { if (e.key === 'Enter') doSearch(); };
    document.getElementById('s-input').oninput = function() { if (!this.value.trim()) { if (cy) cy.elements().removeClass('found dimmed'); document.getElementById('s-count').textContent=''; } };
  </script>
</body>
</html>
