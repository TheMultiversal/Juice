<!-- Juice Project - Est. 2016 | Last updated 2025 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <meta name="created" content="2016-03-14">
  <meta name="author" content="Juice Project">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Graph</title>
  <style>
    /* ===== BASE ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; color: #c8d6f0; background: #0a0a1a; display: flex; flex-direction: column; }

    /* ===== NAV ===== */
    nav { flex-shrink: 0; padding: 6px 12px; position: relative; z-index: 50; background: rgba(10,10,30,0.88); backdrop-filter: blur(14px); border-bottom: 1px solid rgba(100,120,255,0.15); }
    nav ul { list-style: none; display: flex; flex-wrap: wrap; gap: 4px 6px; justify-content: center; align-items: center; padding: 4px 0; }
    nav ul li { white-space: nowrap; }
    nav a { color: #8ab4f8 !important; text-decoration: none; padding: 3px 9px; border-radius: 5px; border: 1px solid rgba(100,120,255,0.2); font-size: 0.74em; display: inline-block; line-height: 1.3; background: rgba(30,30,60,0.5); transition: all 0.2s; }
    nav a:hover { background: rgba(60,80,180,0.35); border-color: rgba(100,120,255,0.45); }
    nav select { padding: 3px 8px; border-radius: 5px; border: 1px solid rgba(100,120,255,0.2); font-size: 0.74em; background: rgba(30,30,60,0.5); color: #8ab4f8; }

    /* ===== GRAPH WRAPPER (fills all remaining space below nav) ===== */
    .graph-wrapper { flex: 1; position: relative; overflow: hidden; background: #0a0a1a; }
    #graph { position: absolute; inset: 0; width: 100%; height: 100%; display: block; }

    /* ===== SHARED PANEL STYLE ===== */
    .g-panel {
      background: rgba(12,12,32,0.94);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(100,120,255,0.16);
      border-radius: 10px;
      box-shadow: 0 6px 28px rgba(0,0,0,0.45);
      overflow: hidden;
    }
    .g-panel-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 10px; cursor: pointer; user-select: none;
      background: rgba(40,50,120,0.22);
      border-bottom: 1px solid rgba(100,120,255,0.1);
    }
    .g-panel-header:hover { background: rgba(40,50,120,0.38); }
    .g-panel-header strong,
    .g-panel-header h3 { color: #8ab4f8; font-size: 0.8em; font-weight: 600; margin: 0; }
    .g-panel-header .chv { color: #6b8cff; font-size: 0.65em; transition: transform 0.25s; }
    .g-panel.collapsed .g-panel-body { display: none; }
    .g-panel.collapsed .g-panel-header { border-bottom: none; }
    .g-panel.collapsed .chv { transform: rotate(180deg); }

    /* ===== CONTROLS (top-left) ===== */
    .hud-ctrl { position: absolute; top: 10px; left: 10px; z-index: 12; width: 205px; }
    .ctrl-body { padding: 7px 10px 9px; }
    .ctrl-body label { font-size: 0.74em; color: #8895b3; display: block; margin: 4px 0 1px; font-weight: 500; letter-spacing: 0.3px; }
    .ctrl-body select { width: 100%; padding: 4px 6px; border-radius: 5px; border: 1px solid rgba(100,120,255,0.18); background: rgba(18,18,45,0.8); color: #b0c4e8; font-size: 0.78em; outline: none; }
    .ctrl-body select:focus { border-color: #6b8cff; }
    .ctrl-body input[type="range"] { width: 100%; margin: 2px 0; accent-color: #6b8cff; }
    .ctrl-checks { display: flex; gap: 10px; margin: 5px 0 2px; }
    .ctrl-checks label { display: flex; align-items: center; gap: 3px; font-size: 0.74em; color: #8895b3; cursor: pointer; margin: 0; }
    .ctrl-checks input[type="checkbox"] { accent-color: #6b8cff; }
    .ctrl-btns { display: flex; gap: 5px; margin-top: 5px; }
    .ctrl-btns button { flex: 1; padding: 4px 0; border-radius: 5px; border: 1px solid rgba(100,120,255,0.18); background: rgba(40,50,120,0.25); color: #8ab4f8; font-size: 0.74em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .ctrl-btns button:hover { background: rgba(60,80,180,0.38); border-color: rgba(100,120,255,0.35); }

    /* ===== SEARCH (top-center) ===== */
    .hud-search { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 12; display: flex; align-items: center; }
    .hud-search input { padding: 5px 11px; border: 1px solid rgba(100,120,255,0.22); border-radius: 6px 0 0 6px; font-size: 0.78em; width: 195px; outline: none; background: rgba(12,12,32,0.94); backdrop-filter: blur(18px); color: #b0c4e8; }
    .hud-search input::placeholder { color: #4a5a7a; }
    .hud-search input:focus { border-color: #6b8cff; }
    .hud-search button { padding: 5px 9px; border: 1px solid rgba(100,120,255,0.22); border-left: none; border-radius: 0 6px 6px 0; background: rgba(40,50,120,0.4); color: #8ab4f8; cursor: pointer; font-size: 0.78em; }
    .hud-search button:hover { background: rgba(60,80,180,0.45); }
    .hud-search .s-count { padding: 0 7px; font-size: 0.72em; color: #6b8cff; white-space: nowrap; }

    /* ===== STATS (top-right) ===== */
    .hud-stats { position: absolute; top: 10px; right: 10px; z-index: 12; }
    .stats-badge { background: rgba(12,12,32,0.94); backdrop-filter: blur(18px); border: 1px solid rgba(100,120,255,0.16); border-radius: 8px; padding: 5px 11px; font-size: 0.75em; color: #8895b3; box-shadow: 0 4px 14px rgba(0,0,0,0.35); white-space: nowrap; }
    .stats-badge b { color: #6b8cff; font-weight: 700; }

    /* ===== CATEGORY LEGEND (bottom-left) ===== */
    .hud-cat { position: absolute; bottom: 10px; left: 10px; z-index: 12; width: 185px; }
    .cat-body { padding: 4px 10px 7px; max-height: 175px; overflow-y: auto; }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.7em; color: #8895b3; margin: 1px 0; }
    .legend-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }

    /* ===== EDGE LEGEND (bottom-right) ===== */
    .hud-edge { position: absolute; bottom: 10px; right: 10px; z-index: 12; width: 170px; }
    .edge-body { padding: 3px 10px 7px; max-height: 200px; overflow-y: auto; }
    .edge-item { display: flex; align-items: center; gap: 5px; font-size: 0.7em; color: #8895b3; margin: 1.5px 0; }
    .edge-line { width: 16px; height: 3px; border-radius: 2px; flex-shrink: 0; }

    /* ===== SCROLLBAR ===== */
    .cat-body::-webkit-scrollbar, .edge-body::-webkit-scrollbar { width: 4px; }
    .cat-body::-webkit-scrollbar-track, .edge-body::-webkit-scrollbar-track { background: transparent; }
    .cat-body::-webkit-scrollbar-thumb, .edge-body::-webkit-scrollbar-thumb { background: rgba(100,120,255,0.22); border-radius: 2px; }

    /* ===== TOOLTIP ===== */
    .tooltip { position: fixed; background: rgba(8,8,25,0.96); backdrop-filter: blur(14px); color: #dce4f4; padding: 8px 14px; border-radius: 8px; border: 1px solid rgba(100,120,255,0.2); font-size: 0.8em; pointer-events: none; z-index: 100; max-width: 320px; line-height: 1.5; display: none; box-shadow: 0 6px 24px rgba(0,0,0,0.55); }

    /* ===== D3 ELEMENTS ===== */
    .node-label { font-size: 9px; fill: #8a9ab5; pointer-events: none; font-weight: 600; }
    .person-label { fill: #6a7a95; }
    .link { stroke-width: 1.2px; }

    /* ===== MINIMAP ===== */
    .minimap { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 11; background: rgba(12,12,32,0.88); border: 1px solid rgba(100,120,255,0.15); border-radius: 7px; overflow: hidden; box-shadow: 0 4px 14px rgba(0,0,0,0.4); opacity: 0.65; transition: opacity 0.2s; }
    .minimap:hover { opacity: 1; }
    .minimap canvas { display: block; }

    /* ===== LOADING ===== */
    .loading-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(10,10,26,0.6); z-index: 20; pointer-events: none; transition: opacity 0.4s; }
    .loading-overlay.hidden { opacity: 0; }
    .loading-spinner { width: 36px; height: 36px; border: 3px solid rgba(100,120,255,0.12); border-top-color: #6b8cff; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) {
      .hud-search input { width: 130px; }
      .hud-ctrl { width: 175px; }
      .hud-cat { width: 155px; }
      .hud-edge { width: 145px; }
    }
    @media (max-width: 600px) {
      .hud-search { display: none; }
      .hud-ctrl { width: 155px; }
      .hud-cat, .hud-edge { width: 130px; }
      .minimap { display: none; }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav id="navbar"></nav>

  <!-- Graph area (everything below nav) -->
  <div class="graph-wrapper">
    <svg id="graph"></svg>

    <!-- Loading -->
    <div class="loading-overlay" id="loading"><div class="loading-spinner"></div></div>

    <!-- HUD: Controls (top-left) -->
    <div class="hud-ctrl">
      <div class="g-panel" id="ctrl-panel">
        <div class="g-panel-header" id="ctrl-toggle">
          <h3><i class="fa-solid fa-sliders"></i> Controls</h3>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="g-panel-body ctrl-body">
          <label>Country</label>
          <select id="country-select"><option value="">All Countries</option></select>
          <label>Category</label>
          <select id="category-select"><option value="">All Categories</option></select>
          <label>Node Size</label>
          <input type="range" id="node-size" min="2" max="20" value="7" />
          <label>Link Distance</label>
          <input type="range" id="link-dist" min="20" max="300" value="90" />
          <div class="ctrl-checks">
            <label><input type="checkbox" id="show-people" checked /> People</label>
            <label><input type="checkbox" id="show-labels" checked /> Labels</label>
          </div>
          <div class="ctrl-btns">
            <button id="reload-btn"><i class="fa-solid fa-rotate"></i> Reload</button>
            <button id="reset-btn"><i class="fa-solid fa-expand"></i> Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HUD: Search (top-center) -->
    <div class="hud-search">
      <input type="text" id="search-input" placeholder="Search nodes..." />
      <button id="search-btn"><i class="fa-solid fa-search"></i></button>
      <span class="s-count" id="search-count"></span>
    </div>

    <!-- HUD: Stats (top-right) -->
    <div class="hud-stats">
      <div class="stats-badge" id="node-count"><b>Loading...</b></div>
    </div>

    <!-- HUD: Category legend (bottom-left) -->
    <div class="hud-cat">
      <div class="g-panel" id="cat-panel">
        <div class="g-panel-header" id="cat-toggle">
          <strong><i class="fa-solid fa-palette"></i> Categories</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="g-panel-body cat-body" id="cat-body"></div>
      </div>
    </div>

    <!-- HUD: Edge legend (bottom-right) -->
    <div class="hud-edge">
      <div class="g-panel" id="edge-panel">
        <div class="g-panel-header" id="edge-toggle">
          <strong><i class="fa-solid fa-link"></i> Connections</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="g-panel-body edge-body" id="edge-body"></div>
      </div>
    </div>

    <!-- Minimap -->
    <div class="minimap" id="minimap"><canvas id="minimap-canvas" width="150" height="100"></canvas></div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>
  </div>

  <script src="app.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    initPage('jewish');
    setSEO({ title: 'Network Graph - Juice Project', description: 'Interactive network visualization.' });

    // ─── Collapsible panels ──────────────────────────────
    document.getElementById('ctrl-toggle').onclick = () => document.getElementById('ctrl-panel').classList.toggle('collapsed');
    document.getElementById('cat-toggle').onclick = () => document.getElementById('cat-panel').classList.toggle('collapsed');
    document.getElementById('edge-toggle').onclick = () => document.getElementById('edge-panel').classList.toggle('collapsed');

    // ─── Color maps ──────────────────────────────────────
    const categoryColors = {
      'Entertainment & Media': '#e74c3c', 'Religion & Synagogues': '#9b59b6',
      'Culture & Arts': '#e67e22', 'Technology': '#2ecc71',
      'Community & Social Organizations': '#3498db', 'Education & Academia': '#1abc9c',
      'Representative & Umbrella Bodies': '#f39c12', 'Heritage & Memorials': '#8e44ad',
      'Charity & Philanthropy': '#e91e63', 'Investment & Private Equity': '#00bcd4',
      'Real Estate & Property': '#795548', 'Sports': '#ff5722',
      'Advocacy & Public Affairs': '#607d8b', 'Healthcare & Pharmaceuticals': '#4caf50',
      'Banking & Financial Services': '#ff9800', 'Research & Think Tanks': '#673ab7',
      'Retail & E-Commerce': '#009688', 'Defense & Security': '#f44336',
      'Food & Beverage': '#8bc34a', 'Conglomerates & Holding Companies': '#9e9e9e',
      'Government & Diplomacy': '#3f51b5', 'Fashion & Consumer Goods': '#ff4081',
      'Manufacturing & Industry': '#757575', 'Law Firms': '#455a64',
      'Notable Individuals': '#ffc107', 'Transportation': '#00acc1',
      'Advertising & PR': '#d81b60', 'Telecommunications': '#7c4dff',
      'Utilities & Energy': '#66bb6a', 'People': '#ffab40'
    };
    const defaultColor = '#546e7a';
    const personColor = '#ffab40';

    const edgeTypeColors = {
      'financial': '#ff9800', 'shared-person': '#9c27b0', 'political': '#f44336',
      'organizational': '#2196f3', 'ideological': '#4caf50', 'historical': '#795548',
      'legal': '#607d8b', 'related': '#90a4ae', 'partnership': '#00bcd4',
      'subsidiary': '#ff5722', 'funding': '#ffc107', 'membership': '#3f51b5',
      'affiliation': '#e91e63', 'leadership': '#8e44ad', 'collaboration': '#1abc9c',
      'person-affiliation': '#ffab40', 'industry peer': '#78909c',
      'affiliate': '#42a5f5', 'communal partner': '#4db6ac',
      'heritage partner': '#ab47bc', 'funder': '#ffa726',
      'community institution': '#66bb6a', 'religious partner': '#ce93d8',
      'umbrella body': '#5c6bc0', 'member': '#26a69a',
      'museum peer': '#7e57c2', 'cultural partner': '#ec407a',
      'regional connection': '#8d6e63', 'educational partner': '#29b6f6',
      'government partner': '#ef5350', 'sports affiliate': '#ff7043',
      'operating body': '#26c6da', 'governing body': '#d4e157',
      'preservation partner': '#9ccc65', 'support': '#7986cb',
      'diplomatic partner': '#f06292', 'historical support': '#a1887f',
      'parent organization': '#4fc3f7', 'research partner': '#ba68c8'
    };
    const defaultEdgeColor = '#334';

    // ─── Populate dropdowns ──────────────────────────────
    let catReady = false, countryReady = false;
    function tryLoad() { if (catReady && countryReady) loadGraph(); }

    fetch('/api/jewish/categories').then(r => r.json()).then(d => {
      const sel = document.getElementById('category-select');
      Object.keys(d.categories).sort().forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c + ' (' + d.categories[c].count + ')';
        sel.appendChild(o);
      });
      catReady = true; tryLoad();
    });
    fetch('/api/countries').then(r => r.json()).then(d => {
      const sel = document.getElementById('country-select');
      (Array.isArray(d) ? d : d.countries || []).sort().forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        sel.appendChild(o);
      });
      countryReady = true; tryLoad();
    });

    // ─── Graph state ─────────────────────────────────────
    let simulation, svgG, zoom, allNodes = [];

    function loadGraph() {
      const country = document.getElementById('country-select').value;
      const category = document.getElementById('category-select').value;
      const showPeople = document.getElementById('show-people').checked;
      let url = '/api/graph?people=' + (showPeople ? '1' : '0');
      if (country) url += '&country=' + encodeURIComponent(country);
      if (category) url += '&category=' + encodeURIComponent(category);

      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('node-count').innerHTML = '<b>Loading...</b>';

      fetch(url).then(r => r.json()).then(data => {
        renderGraph(data);
        document.getElementById('loading').classList.add('hidden');
      });
    }

    function renderGraph(data) {
      const svg = d3.select('#graph');
      svg.selectAll('*').remove();
      if (simulation) { simulation.stop(); simulation = null; }

      const wrapper = document.querySelector('.graph-wrapper');
      const width = wrapper.clientWidth;
      const height = wrapper.clientHeight;
      svg.attr('viewBox', `0 0 ${width} ${height}`);

      allNodes = data.nodes;
      const entryNodes = data.nodes.filter(n => n.nodeType !== 'person');
      const personNodes = data.nodes.filter(n => n.nodeType === 'person');
      const totalNodes = data.nodes.length;

      // Stats
      document.getElementById('node-count').innerHTML =
        '<b>' + entryNodes.length + '</b> entries &middot; <b>' + personNodes.length + '</b> people &middot; <b>' + data.links.length + '</b> links';

      // ── Category legend ──
      const cats = [...new Set(data.nodes.map(n => n.category || n.group))].filter(Boolean).sort();
      const catBody = document.getElementById('cat-body');
      catBody.innerHTML = '';
      cats.forEach(c => {
        const row = document.createElement('div');
        row.className = 'legend-item';
        const dot = document.createElement('div');
        dot.className = 'legend-dot';
        dot.style.background = categoryColors[c] || defaultColor;
        if (c === 'People') { dot.style.borderRadius = '2px'; dot.style.transform = 'rotate(45deg)'; dot.style.width = '7px'; dot.style.height = '7px'; }
        row.appendChild(dot);
        row.appendChild(document.createTextNode(c));
        catBody.appendChild(row);
      });

      // ── Edge legend ──
      const edgeTypes = [...new Set(data.links.map(l => l.type).filter(Boolean))].sort();
      const edgeBody = document.getElementById('edge-body');
      edgeBody.innerHTML = '';
      edgeTypes.forEach(t => {
        const row = document.createElement('div');
        row.className = 'edge-item';
        const line = document.createElement('div');
        line.className = 'edge-line';
        line.style.background = edgeTypeColors[t] || defaultEdgeColor;
        row.appendChild(line);
        row.appendChild(document.createTextNode(t));
        edgeBody.appendChild(row);
      });

      // ── D3 ──
      zoom = d3.zoom().scaleExtent([0.03, 12]).on('zoom', onZoom);
      svg.call(zoom);
      svgG = svg.append('g');

      const nodeSize = +document.getElementById('node-size').value;
      const linkDist = +document.getElementById('link-dist').value;
      const charge = totalNodes > 2000 ? -22 : totalNodes > 500 ? -40 : -65;
      const decay = totalNodes > 2000 ? 0.04 : 0.023;

      simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.links).id(d => d.id).distance(d =>
          d.type === 'person-affiliation' ? linkDist * 0.3 : linkDist
        ))
        .force('charge', d3.forceManyBody().strength(charge))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(d => d.nodeType === 'person' ? nodeSize * 0.35 + 1 : nodeSize + 1))
        .alphaDecay(decay);

      // ── Links ──
      const link = svgG.append('g').attr('class', 'g-links')
        .selectAll('line').data(data.links).join('line')
        .attr('class', 'link')
        .attr('stroke', d => edgeTypeColors[d.type] || defaultEdgeColor)
        .attr('stroke-opacity', d => d.type === 'person-affiliation' ? 0.12 : 0.3)
        .attr('stroke-width', d => d.type === 'person-affiliation' ? 0.5 : 1)
        .on('mouseover', (e, d) => {
          d3.select(e.target).attr('stroke-opacity', 1).attr('stroke-width', 2.5);
          showTooltip(e, '<strong>' + d.type + '</strong><br/>' + (d.description || ''));
        })
        .on('mouseout', (e, d) => {
          d3.select(e.target)
            .attr('stroke-opacity', d.type === 'person-affiliation' ? 0.12 : 0.3)
            .attr('stroke-width', d.type === 'person-affiliation' ? 0.5 : 1);
          hideTooltip();
        });

      // ── Entry nodes (circles) ──
      const entryNode = svgG.append('g').attr('class', 'g-entries')
        .selectAll('circle').data(entryNodes).join('circle')
        .attr('r', nodeSize)
        .attr('fill', d => categoryColors[d.category] || defaultColor)
        .attr('stroke', 'rgba(200,210,240,0.35)')
        .attr('stroke-width', 0.7)
        .style('cursor', 'pointer')
        .on('mouseover', (e, d) => {
          d3.select(e.target).attr('r', nodeSize * 1.5).attr('stroke', '#fff').attr('stroke-width', 2);
          showTooltip(e, '<strong>' + d.name + '</strong><br/><i class="fa-solid fa-building"></i> ' + d.type + '<br/><i class="fa-solid fa-globe"></i> ' + d.country + '<br/><i class="fa-solid fa-tag"></i> ' + d.category);
        })
        .on('mouseout', (e) => {
          d3.select(e.target).attr('r', nodeSize).attr('stroke', 'rgba(200,210,240,0.35)').attr('stroke-width', 0.7);
          hideTooltip();
        })
        .on('click', (e, d) => window.open('entry.html?religion=jewish&id=' + encodeURIComponent(d.id), '_blank'))
        .call(makeDrag());

      // ── Person nodes (proper diamonds via polygon) ──
      const pSize = nodeSize * 0.5;
      const personNode = svgG.append('g').attr('class', 'g-people')
        .selectAll('polygon').data(personNodes).join('polygon')
        .attr('points', diamondPts(pSize))
        .attr('fill', personColor)
        .attr('stroke', 'rgba(200,210,240,0.3)')
        .attr('stroke-width', 0.5)
        .style('cursor', 'pointer')
        .on('mouseover', (e, d) => {
          d3.select(e.target).attr('points', diamondPts(pSize * 1.6)).attr('stroke', '#fff').attr('stroke-width', 1.5);
          showTooltip(e, '<strong><i class="fa-solid fa-user"></i> ' + d.name + '</strong><br/><i class="fa-solid fa-briefcase"></i> ' + (d.role || 'Individual') + '<br/><i class="fa-solid fa-globe"></i> ' + d.country);
        })
        .on('mouseout', (e) => {
          d3.select(e.target).attr('points', diamondPts(pSize)).attr('stroke', 'rgba(200,210,240,0.3)').attr('stroke-width', 0.5);
          hideTooltip();
        })
        .on('click', (e, d) => window.open('person.html?id=' + encodeURIComponent(d.personId), '_blank'))
        .call(makeDrag());

      function diamondPts(s) { return '0,' + (-s) + ' ' + s + ',0 0,' + s + ' ' + (-s) + ',0'; }

      // ── Labels ──
      const showLabels = document.getElementById('show-labels').checked;
      const entryLabels = svgG.append('g').attr('class', 'g-elabels')
        .selectAll('text').data(entryNodes).join('text')
        .attr('class', 'node-label')
        .text(d => d.name.length > 22 ? d.name.substring(0, 22) + '\u2026' : d.name)
        .attr('dx', nodeSize + 3).attr('dy', 3)
        .style('display', showLabels ? 'block' : 'none')
        .style('font-size', totalNodes > 1000 ? '7px' : '9px');

      const personLabels = svgG.append('g').attr('class', 'g-plabels')
        .selectAll('text').data(personNodes).join('text')
        .attr('class', 'node-label person-label')
        .text(d => d.name.length > 18 ? d.name.substring(0, 18) + '\u2026' : d.name)
        .attr('dx', pSize + 4).attr('dy', 3)
        .style('display', showLabels && totalNodes < 300 ? 'block' : 'none')
        .style('font-size', '7px');

      // ── Tick ──
      simulation.on('tick', () => {
        link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
        entryNode.attr('cx', d => d.x).attr('cy', d => d.y);
        personNode.attr('transform', d => 'translate(' + d.x + ',' + d.y + ')');
        entryLabels.attr('x', d => d.x).attr('y', d => d.y);
        personLabels.attr('x', d => d.x).attr('y', d => d.y);
      });

      simulation.on('end', drawMinimap);
      setTimeout(drawMinimap, 3500);

      // ── Zoom handler ──
      function onZoom(e) {
        svgG.attr('transform', e.transform);
        if (showLabels) {
          const k = e.transform.k;
          personLabels.style('display', k > 1.5 || totalNodes < 300 ? 'block' : 'none');
          entryLabels.style('display', k < 0.25 ? 'none' : 'block');
        }
      }

      function makeDrag() {
        return d3.drag()
          .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
          .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
          .on('end', (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; });
      }
    }

    // ─── Minimap ─────────────────────────────────────────
    function drawMinimap() {
      const canvas = document.getElementById('minimap-canvas');
      const ctx = canvas.getContext('2d');
      const W = 150, H = 100;
      ctx.clearRect(0, 0, W, H);
      if (!allNodes.length) return;
      let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
      allNodes.forEach(n => { if (n.x < minX) minX = n.x; if (n.x > maxX) maxX = n.x; if (n.y < minY) minY = n.y; if (n.y > maxY) maxY = n.y; });
      const rX = (maxX - minX) || 1, rY = (maxY - minY) || 1;
      const sc = Math.min(130 / rX, 80 / rY);
      const ox = (W - rX * sc) / 2, oy = (H - rY * sc) / 2;
      allNodes.forEach(n => {
        ctx.fillStyle = n.nodeType === 'person' ? 'rgba(255,171,64,0.5)' : (categoryColors[n.category] || defaultColor);
        ctx.globalAlpha = 0.6;
        ctx.fillRect((n.x - minX) * sc + ox - 0.7, (n.y - minY) * sc + oy - 0.7, 1.4, 1.4);
      });
      ctx.globalAlpha = 1;
    }

    // ─── Tooltip ─────────────────────────────────────────
    const tooltip = document.getElementById('tooltip');
    function showTooltip(e, html) {
      tooltip.style.display = 'block';
      tooltip.innerHTML = html;
      tooltip.style.left = Math.min(e.pageX + 15, window.innerWidth - 340) + 'px';
      tooltip.style.top = Math.min(e.pageY - 10, window.innerHeight - 100) + 'px';
    }
    function hideTooltip() { tooltip.style.display = 'none'; }

    // ─── Controls ────────────────────────────────────────
    document.getElementById('reload-btn').onclick = loadGraph;
    document.getElementById('reset-btn').onclick = () => {
      d3.select('#graph').transition().duration(500).call(zoom.transform, d3.zoomIdentity);
    };
    document.getElementById('show-labels').onchange = function () {
      d3.selectAll('.node-label').style('display', this.checked ? 'block' : 'none');
      if (!this.checked) d3.selectAll('.person-label').style('display', 'none');
    };
    document.getElementById('show-people').onchange = loadGraph;
    document.getElementById('country-select').onchange = loadGraph;
    document.getElementById('category-select').onchange = loadGraph;
    document.getElementById('link-dist').oninput = function () {
      if (simulation) { simulation.force('link').distance(+this.value); simulation.alpha(0.3).restart(); }
    };
    document.getElementById('node-size').oninput = function () {
      const s = +this.value;
      d3.selectAll('.g-entries circle').attr('r', s);
      const ps = s * 0.5;
      d3.selectAll('.g-people polygon').attr('points', '0,' + (-ps) + ' ' + ps + ',0 0,' + ps + ' ' + (-ps) + ',0');
    };

    // ─── Search ──────────────────────────────────────────
    function searchGraph() {
      const q = document.getElementById('search-input').value.trim().toLowerCase();
      d3.selectAll('.g-entries circle').attr('stroke', 'rgba(200,210,240,0.35)').attr('stroke-width', 0.7);
      d3.selectAll('.g-people polygon').attr('stroke', 'rgba(200,210,240,0.3)').attr('stroke-width', 0.5);
      if (!q) { document.getElementById('search-count').textContent = ''; return; }
      let count = 0, first = null;
      d3.selectAll('.g-entries circle').each(function (d) {
        if (d.name && d.name.toLowerCase().includes(q)) {
          d3.select(this).attr('stroke', '#ffeb3b').attr('stroke-width', 3);
          count++; if (!first) first = d;
        }
      });
      d3.selectAll('.g-people polygon').each(function (d) {
        if (d.name && d.name.toLowerCase().includes(q)) {
          d3.select(this).attr('stroke', '#ffeb3b').attr('stroke-width', 3);
          count++; if (!first) first = d;
        }
      });
      document.getElementById('search-count').textContent = count ? count + ' found' : 'none';
      if (first && zoom) {
        d3.select('#graph').transition().duration(600).call(zoom.transform,
          d3.zoomIdentity.translate(window.innerWidth / 2, window.innerHeight / 2).scale(2.5).translate(-first.x, -first.y));
      }
    }
    document.getElementById('search-btn').onclick = searchGraph;
    document.getElementById('search-input').onkeydown = function (e) { if (e.key === 'Enter') searchGraph(); };
  </script>
</body>
</html>
