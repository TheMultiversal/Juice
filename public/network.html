<!-- Juice Project - Est. 2016 | Last updated 2025 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="created" content="2016-03-14">
  <meta name="author" content="Juice Project">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="The Juice Box">
  <meta property="og:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:title" content="Focused Network">
  <meta property="og:description" content="Focused network visualization - explore connections for any entity in The Juice Box database.">
  <meta property="og:url" content="https://thejuicebox.live/network.html">
  <meta name="twitter:title" content="Focused Network">
  <meta name="twitter:description" content="Focused network visualization - explore connections for any entity in The Juice Box database.">
  <title>Focused Network</title>

  <!-- Cytoscape.js: high-performance graph with built-in overlap prevention -->
  <script src="https://unpkg.com/cytoscape@3/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/cytoscape-fcose@2/cytoscape-fcose.js"></script>

  <style>
    /* ===== BASE ===== */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: #000; background: #fff; }
    nav { padding: 10px 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    nav ul { list-style: none; margin: 0; padding: 10px 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; }
    nav ul li { margin: 0; white-space: nowrap; }
    nav a { color: #0000EE !important; text-decoration: none; background: rgba(255,255,255,0.85); padding: 5px 12px; white-space: nowrap; border-radius: 6px; border: 1px solid rgba(0,0,255,0.3); box-shadow: 1px 1px 2px rgba(0,0,0,0.2); font-size: 0.82em; display: inline-block; line-height: 1.4; }
    nav select { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(0,0,255,0.3); font-size: 0.85em; background: rgba(255,255,255,0.85); }

    /* Glassmorphism */
    .panel, .gp, .sb, .header-panel, .graph-wrap {
      background: rgba(255, 255, 255, 0.15) !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      border: 1px solid rgba(255, 255, 255, 0.25) !important;
      border-radius: 12px !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08) !important;
    }
    .gp:hover, .header-panel:hover { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important; border-color: rgba(255, 255, 255, 0.35) !important; }
    nav a {
      background: rgba(255, 255, 255, 0.2) !important;
      backdrop-filter: blur(8px) !important;
      -webkit-backdrop-filter: blur(8px) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
      border-radius: 8px !important;
    }
    nav select {
      background: rgba(255, 255, 255, 0.2) !important;
      backdrop-filter: blur(8px) !important;
      -webkit-backdrop-filter: blur(8px) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
    }

    /* ===== PAGE LAYOUT ===== */
    .main { max-width: 1600px; margin: 0 auto; padding: 15px 20px; }
    .header-panel { background: rgba(255,255,255,0.85); border: 1px solid rgba(0,0,255,0.2); border-radius: 8px; padding: 16px 20px; margin-bottom: 15px; }
    .header-panel h1 { margin: 0 0 4px 0; color: #0056b3; }
    .header-panel .focus-name { color: #c62828; font-weight: 800; }
    .header-panel .subtitle { color: #555; margin: 0; font-size: 0.95em; }
    .header-panel .back-links { margin-bottom: 6px; }
    .header-panel .back-links a { color: #0056b3; text-decoration: none; font-size: 0.85em; margin-right: 12px; }
    .header-panel .back-links a:hover { text-decoration: underline; }
    .people-info { font-size: 0.82em; color: #888; margin-top: 2px; }
    .people-info b { color: #0056b3; }

    /* ===== GRAPH WRAPPER ===== */
    .graph-wrap { position: relative; width: 100%; height: 85vh; min-height: 500px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(0,0,255,0.15); background: #fff; }
    #graph-container { position: absolute; inset: 0; width: 100%; height: 100%; }

    /* ===== SHARED PANEL ===== */
    .gp { overflow: hidden; transition: box-shadow 0.25s; }
    .gp-h {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 10px; cursor: pointer; user-select: none;
      background: rgba(0,86,179,0.06);
      border-bottom: 1px solid rgba(0,0,255,0.08);
      transition: background 0.2s;
    }
    .gp-h:hover { background: rgba(0,86,179,0.12); }
    .gp-h strong, .gp-h h3 { color: #0056b3; font-size: 0.78em; font-weight: 600; margin: 0; }
    .gp-h .chv { color: #0056b3; font-size: 0.6em; transition: transform 0.25s; }
    .gp.shut .gp-b { display: none; }
    .gp.shut .gp-h { border-bottom: none; }
    .gp.shut .chv { transform: rotate(180deg); }

    /* ===== CONTROLS (top-left) ===== */
    .hud-ctrl { position: absolute; top: 10px; left: 10px; z-index: 12; width: 210px; }
    .cb { padding: 7px 10px 9px; }
    .cb label { font-size: 0.73em; color: #333; display: block; margin: 4px 0 1px; font-weight: 500; }
    .cb select { width: 100%; padding: 4px 6px; border-radius: 5px; border: 1px solid rgba(0,0,255,0.16); background: rgba(255,255,255,0.85); color: #333; font-size: 0.77em; outline: none; }
    .cb select:focus { border-color: #0056b3; }
    .cb input[type="range"] { width: 100%; margin: 2px 0; accent-color: #0056b3; }
    .cb .chks { display: flex; gap: 10px; margin: 5px 0 2px; }
    .cb .chks label { display: flex; align-items: center; gap: 3px; font-size: 0.73em; color: #333; cursor: pointer; margin: 0; }
    .cb .chks input[type="checkbox"] { accent-color: #0056b3; }
    .cb .btns { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
    .cb .btns button { flex: 1; padding: 4px 0; border-radius: 5px; border: 1px solid rgba(0,0,255,0.16); background: rgba(0,86,179,0.08); color: #0056b3; font-size: 0.73em; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 60px; }
    .cb .btns button:hover { background: rgba(0,86,179,0.18); }
    .cb .depth-row { display: flex; align-items: center; gap: 6px; }
    .cb .depth-row input { flex: 1; }
    .cb .depth-row span { font-size: 0.77em; color: #0056b3; font-weight: 700; min-width: 12px; text-align: center; }

    /* ===== SEARCH (top-center) ===== */
    .hud-search { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 12; display: flex; align-items: center; }
    .hud-search input { padding: 5px 11px; border: 1px solid rgba(0,0,255,0.2); border-radius: 6px 0 0 6px; font-size: 0.77em; width: 200px; outline: none; background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); color: #333; }
    .hud-search input::placeholder { color: #888; }
    .hud-search input:focus { border-color: #0056b3; }
    .hud-search button { padding: 5px 9px; border: 1px solid rgba(0,0,255,0.2); border-left: none; border-radius: 0 6px 6px 0; background: rgba(0,86,179,0.1); color: #0056b3; cursor: pointer; font-size: 0.77em; transition: background 0.2s; }
    .hud-search button:hover { background: rgba(0,86,179,0.2); }
    .hud-search .sc { padding: 0 7px; font-size: 0.71em; color: #0056b3; white-space: nowrap; text-shadow: 0 0 4px rgba(255,255,255,0.9); }

    /* ===== STATS (top-right) ===== */
    .hud-stats { position: absolute; top: 10px; right: 10px; z-index: 12; }
    .sb { padding: 5px 11px; font-size: 0.74em; color: #333; white-space: nowrap; }
    .sb b { color: #0056b3; font-weight: 700; }

    /* ===== CATEGORY LEGEND (bottom-left) ===== */
    .hud-cat { position: absolute; bottom: 10px; left: 10px; z-index: 12; width: 190px; }
    .cat-b { padding: 4px 10px 7px; max-height: 180px; overflow-y: auto; }
    .li { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #333; margin: 1px 0; cursor: pointer; padding: 1px 2px; border-radius: 3px; transition: background 0.15s; }
    .li:hover { background: rgba(0,86,179,0.08); }
    .ld { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    /* ===== EDGE LEGEND (bottom-right) ===== */
    .hud-edge { position: absolute; bottom: 10px; right: 10px; z-index: 12; width: 172px; }
    .edge-b { padding: 3px 10px 7px; max-height: 210px; overflow-y: auto; }
    .ei { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #333; margin: 1.5px 0; }
    .el { width: 15px; height: 3px; border-radius: 2px; flex-shrink: 0; }

    /* ===== SCROLLBAR ===== */
    .cat-b::-webkit-scrollbar, .edge-b::-webkit-scrollbar { width: 4px; }
    .cat-b::-webkit-scrollbar-track, .edge-b::-webkit-scrollbar-track { background: transparent; }
    .cat-b::-webkit-scrollbar-thumb, .edge-b::-webkit-scrollbar-thumb { background: rgba(0,0,255,0.15); border-radius: 2px; }

    /* ===== TOOLTIP ===== */
    #tip {
      position: fixed; background: rgba(255,255,255,0.95); backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      color: #222; padding: 10px 14px; border-radius: 9px;
      border: 1px solid rgba(0,0,255,0.15); font-size: 0.79em;
      pointer-events: none; z-index: 200; max-width: 340px;
      line-height: 1.55; display: none;
      box-shadow: 0 8px 28px rgba(0,0,0,0.12);
    }
    #tip strong { color: #0056b3; }
    #tip .tip-cat { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.85em; margin-top: 3px; }

    /* ===== LOADING ===== */
    .ld-overlay {
      position: absolute; inset: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 12px;
      background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 25; transition: opacity 0.5s;
    }
    .ld-overlay.off { opacity: 0; pointer-events: none; }
    .ld-spinner { width: 38px; height: 38px; border: 3px solid rgba(0,0,255,0.1); border-top-color: #0056b3; border-radius: 50%; animation: spin 0.75s linear infinite; }
    .ld-text { color: #0056b3; font-size: 0.82em; font-weight: 600; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) {
      .hud-search input { width: 135px; }
      .hud-ctrl { width: 180px; }
      .hud-cat { width: 160px; }
      .hud-edge { width: 148px; }
    }
    @media (max-width: 600px) {
      .hud-search { display: none; }
      .hud-ctrl { width: 160px; }
      .hud-cat, .hud-edge { width: 135px; }
    }
  </style>
</head>
<body>
  <nav id="navbar"></nav>

  <div class="main">
  <div class="header-panel">
    <div class="back-links">
      <a href="graph.html"><i class="fa-solid fa-diagram-project"></i> Full Graph</a>
      <a href="index.html"><i class="fa-solid fa-house"></i> Home</a>
      <a href="#" id="btn-entry-top"><i class="fa-solid fa-building"></i> View Entry</a>
    </div>
    <h1><i class="fa-solid fa-spider-web"></i> <span id="page-title">Focused Network</span></h1>
    <p class="subtitle" id="page-subtitle">Loading network data...</p>
    <p class="people-info" id="people-info"></p>
  </div>

  <div class="graph-wrap">
    <!-- Cytoscape graph container -->
    <div id="graph-container"></div>

    <!-- Loading -->
    <div class="ld-overlay" id="loading">
      <div class="ld-spinner"></div>
      <div class="ld-text" id="ld-text">Loading network data...</div>
    </div>

    <!-- HUD: Controls -->
    <div class="hud-ctrl">
      <div class="gp" id="ctrl-p">
        <div class="gp-h" id="ctrl-t">
          <h3><i class="fa-solid fa-sliders"></i> Controls</h3>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cb">
          <label>Depth</label>
          <div class="depth-row">
            <input type="range" id="depth-range" min="1" max="3" value="1" step="1">
            <span id="depth-val">1</span>
          </div>
          <label>Node Size</label>
          <input type="range" id="node-scale" min="2" max="20" value="6" />
          <label>Spacing</label>
          <input type="range" id="link-dist" min="30" max="350" value="120" />
          <div class="chks">
            <label><input type="checkbox" id="show-people" checked /> People</label>
          </div>
          <div class="btns">
            <button id="btn-reload"><i class="fa-solid fa-rotate"></i> Reload</button>
            <button id="btn-fit"><i class="fa-solid fa-compress"></i> Reset</button>
          </div>
          <div class="btns">
            <button id="btn-entry"><i class="fa-solid fa-building"></i> View Entry</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HUD: Search -->
    <div class="hud-search">
      <input type="text" id="s-input" placeholder="Search nodes..." />
      <button id="s-btn"><i class="fa-solid fa-search"></i></button>
      <span class="sc" id="s-count"></span>
    </div>

    <!-- HUD: Stats -->
    <div class="hud-stats">
      <div class="sb" id="stats"><b>Loading...</b></div>
    </div>

    <!-- HUD: Category legend -->
    <div class="hud-cat">
      <div class="gp" id="cat-p">
        <div class="gp-h" id="cat-t">
          <strong><i class="fa-solid fa-palette"></i> Categories</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cat-b" id="cat-b"></div>
      </div>
    </div>

    <!-- HUD: Edge legend -->
    <div class="hud-edge">
      <div class="gp" id="edge-p">
        <div class="gp-h" id="edge-t">
          <strong><i class="fa-solid fa-link"></i> Connections</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b edge-b" id="edge-b"></div>
      </div>
    </div>

  </div>
  </div><!-- /.main -->

  <!-- Tooltip (outside graph-wrap to avoid clipping) -->
  <div id="tip"></div>

  <script src="app.js"></script>
  <script>
    // Register fcose layout extension
    cytoscape.use(cytoscapeFcose);

    initPage('jewish');

    // ─── Collapsible panels ──────────────────────────────
    ['ctrl','cat','edge'].forEach(k => {
      document.getElementById(k+'-t').onclick = () => document.getElementById(k+'-p').classList.toggle('shut');
    });

    // ─── Color maps ──────────────────────────────────────
    const CC = {
      'Entertainment & Media': '#e74c3c', 'Religion & Synagogues': '#9b59b6',
      'Culture & Arts': '#e67e22', 'Technology': '#2ecc71',
      'Community & Social Organizations': '#3498db', 'Education & Academia': '#1abc9c',
      'Representative & Umbrella Bodies': '#f39c12', 'Heritage & Memorials': '#8e44ad',
      'Charity & Philanthropy': '#e91e63', 'Investment & Private Equity': '#00bcd4',
      'Real Estate & Property': '#795548', 'Sports': '#ff5722',
      'Advocacy & Public Affairs': '#607d8b', 'Healthcare & Pharmaceuticals': '#4caf50',
      'Banking & Financial Services': '#ff9800', 'Research & Think Tanks': '#673ab7',
      'Retail & E-Commerce': '#009688', 'Defense & Security': '#f44336',
      'Food & Beverage': '#8bc34a', 'Conglomerates & Holding Companies': '#9e9e9e',
      'Government & Diplomacy': '#3f51b5', 'Fashion & Consumer Goods': '#ff4081',
      'Manufacturing & Industry': '#757575', 'Law Firms': '#455a64',
      'Notable Individuals': '#ffc107', 'Transportation': '#00acc1',
      'Advertising & PR': '#d81b60', 'Telecommunications': '#7c4dff',
      'Utilities & Energy': '#66bb6a', 'People': '#ffab40',
      'Controversy': '#d32f2f'
    };
    const DC = '#546e7a', PC = '#ffab40';

    const EC = {
      'financial': '#ff9800', 'shared-person': '#9c27b0', 'political': '#f44336',
      'organizational': '#2196f3', 'ideological': '#4caf50', 'historical': '#795548',
      'legal': '#607d8b', 'related': '#78909c', 'partnership': '#00bcd4',
      'subsidiary': '#ff5722', 'funding': '#ffc107', 'membership': '#3f51b5',
      'affiliation': '#e91e63', 'leadership': '#8e44ad', 'collaboration': '#1abc9c',
      'person-affiliation': '#ffab40', 'industry peer': '#78909c',
      'affiliate': '#42a5f5', 'communal partner': '#4db6ac',
      'heritage partner': '#ab47bc', 'funder': '#ffa726',
      'community institution': '#66bb6a', 'religious partner': '#ce93d8',
      'umbrella body': '#5c6bc0', 'member': '#26a69a',
      'museum peer': '#7e57c2', 'cultural partner': '#ec407a',
      'regional connection': '#8d6e63', 'educational partner': '#29b6f6',
      'government partner': '#ef5350', 'sports affiliate': '#ff7043',
      'operating body': '#26c6da', 'governing body': '#d4e157',
      'preservation partner': '#9ccc65', 'support': '#7986cb',
      'diplomatic partner': '#f06292', 'historical support': '#a1887f',
      'parent organization': '#4fc3f7', 'research partner': '#ba68c8'
    };
    const DEC = '#90a4ae';

    // ─── State ───────────────────────────────────────────
    let cy = null;
    let focusEntryId = null;
    let isBigEntry = false;
    let nodeScale = 6;
    let spacingVal = 120;
    let mouseX = 0, mouseY = 0;
    const tipEl = document.getElementById('tip');
    const container = document.getElementById('graph-container');

    // Track mouse for tooltip positioning
    document.addEventListener('mousemove', e => {
      mouseX = e.clientX;
      mouseY = e.clientY;
      if (tipEl.style.display === 'block') {
        tipEl.style.left = Math.min(mouseX + 15, window.innerWidth - 360) + 'px';
        tipEl.style.top = Math.min(mouseY - 10, window.innerHeight - 120) + 'px';
      }
    });

    document.querySelector('.graph-wrap').addEventListener('mouseleave', () => {
      tipEl.style.display = 'none';
    });

    // ─── Parse URL ───────────────────────────────────────
    const ID_ALIASES = { 'jeffrey-epstein-network': 'epstein-network' };
    const params = new URLSearchParams(window.location.search);
    focusEntryId = params.get('id') || 'epstein-network';
    if (ID_ALIASES[focusEntryId]) {
      focusEntryId = ID_ALIASES[focusEntryId];
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('id', focusEntryId);
      window.history.replaceState({}, '', newUrl);
    }

    document.getElementById('btn-entry-top').href = 'entry.html?religion=jewish&id=' + encodeURIComponent(focusEntryId);

    // ─── Cytoscape stylesheet ────────────────────────────
    function getCyStyle() {
      return [
        // Base node
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'text-valign': 'bottom',
            'text-halign': 'center',
            'text-margin-y': 5,
            'font-family': 'Arial, sans-serif',
            'font-size': 9,
            'text-outline-width': 2,
            'text-outline-color': '#fff',
            'text-outline-opacity': 0.85,
            'color': '#333',
            'text-max-width': '100px',
            'text-wrap': 'ellipsis',
            'overlay-padding': 4,
            'overlay-opacity': 0,
          }
        },
        // Entry nodes
        {
          selector: 'node[nodeType="entry"]',
          style: {
            'shape': 'ellipse',
            'background-color': 'data(color)',
            'width': 'data(displaySize)',
            'height': 'data(displaySize)',
            'border-width': 1.5,
            'border-color': 'data(borderColor)',
            'font-size': 10,
            'min-zoomed-font-size': 8,
            'z-index': 10,
          }
        },
        // Person nodes
        {
          selector: 'node[nodeType="person"]',
          style: {
            'shape': 'diamond',
            'background-color': '#ffab40',
            'width': 'data(displaySize)',
            'height': 'data(displaySize)',
            'border-width': 0.5,
            'border-color': '#e69500',
            'font-size': 7,
            'min-zoomed-font-size': 14,
            'z-index': 5,
          }
        },
        // Focus node (overrides entry)
        {
          selector: 'node[?isFocus]',
          style: {
            'width': 'data(displaySize)',
            'height': 'data(displaySize)',
            'background-color': '#c62828',
            'border-width': 4,
            'border-color': '#b71c1c',
            'font-size': 14,
            'font-weight': 'bold',
            'color': '#c62828',
            'min-zoomed-font-size': 0,
            'z-index': 9999,
            'text-outline-width': 3,
          }
        },
        // Edges
        {
          selector: 'edge',
          style: {
            'width': 1.2,
            'line-color': 'data(color)',
            'curve-style': 'haystack',
            'haystack-radius': 0.5,
            'opacity': 0.55,
            'overlay-padding': 3,
            'overlay-opacity': 0,
          }
        },
        // Person-affiliation edges
        {
          selector: 'edge[type="person-affiliation"]',
          style: {
            'width': 0.6,
            'line-style': 'dashed',
            'line-dash-pattern': [4, 3],
            'opacity': 0.3,
          }
        },
        // Shared-person edges
        {
          selector: 'edge[type="shared-person"]',
          style: {
            'width': 1.5,
            'line-style': 'dotted',
            'opacity': 0.5,
          }
        },
        // Dimmed (on hover)
        {
          selector: '.dimmed',
          style: { 'opacity': 0.06, 'z-index': 0 }
        },
        // Highlighted neighborhood nodes
        {
          selector: 'node.highlighted',
          style: {
            'opacity': 1,
            'z-index': 999,
            'min-zoomed-font-size': 0,
            'border-width': 3,
            'border-color': '#0056b3',
            'font-size': 11,
          }
        },
        // Highlighted neighborhood edges
        {
          selector: 'edge.highlighted',
          style: { 'opacity': 1, 'width': 2.5, 'z-index': 998 }
        },
        // The hovered node itself
        {
          selector: 'node.hovered',
          style: {
            'opacity': 1, 'z-index': 9998,
            'min-zoomed-font-size': 0,
            'border-width': 3, 'border-color': '#0056b3',
          }
        },
        // Search found
        {
          selector: '.found',
          style: { 'opacity': 1, 'z-index': 9000 }
        },
        {
          selector: 'node.found',
          style: { 'border-width': 3, 'border-color': '#ffeb3b', 'min-zoomed-font-size': 0 }
        },
      ];
    }

    // ─── Layout configuration ────────────────────────────
    function getLayoutConfig(nodeCount) {
      const isHuge = nodeCount > 400;
      const isLarge = nodeCount > 150;
      return {
        name: 'fcose',
        quality: isHuge ? 'default' : 'proof',
        randomize: true,
        animate: nodeCount < 1200,
        animationDuration: isHuge ? 3000 : 1500,
        animationEasing: 'ease-out-cubic',
        fit: true,
        padding: 50,
        nodeDimensionsIncludeLabels: false,
        nodeRepulsion: function(node) {
          if (node.data('isFocus')) return isHuge ? 80000 : 50000;
          if (node.data('nodeType') === 'person') return isHuge ? 3000 : 4500;
          return isHuge ? 8000 : 6000;
        },
        idealEdgeLength: function(edge) {
          if (edge.data('type') === 'person-affiliation') return isHuge ? spacingVal * 0.4 : spacingVal * 0.6;
          if (edge.data('type') === 'shared-person') return spacingVal * 0.5;
          return spacingVal;
        },
        edgeElasticity: function(edge) {
          if (edge.data('type') === 'person-affiliation') return 0.8;
          return 0.45;
        },
        gravity: isHuge ? 0.4 : 0.25,
        gravityRange: 3.8,
        numIter: isHuge ? 8000 : 5000,
        tile: true,
        tilingPaddingVertical: 10,
        tilingPaddingHorizontal: 10,
        packComponents: true,
        nodeSeparation: isHuge ? 20 : 30,
      };
    }

    // ─── Compute node sizes ──────────────────────────────
    function computeNodeSizes(nodes, degreeMap, scale) {
      const s = scale || nodeScale;
      const factor = s / 6;
      nodes.forEach(n => {
        const deg = degreeMap[n.id] || 0;
        let base;
        if (n.isFocus) base = 55 + Math.min(deg, 30) * 0.5;
        else if (n.nodeType === 'person') base = 12 + Math.min(deg, 5) * 1.5;
        else base = 25 + Math.min(deg, 30) * 1.2;
        n.baseSize = base;
        n.displaySize = Math.round(base * factor);
      });
    }

    // ─── Helpers ─────────────────────────────────────────
    function clearHighlights() {
      if (!cy) return;
      cy.elements().removeClass('dimmed highlighted hovered found');
    }

    // ─── Build Cytoscape graph ───────────────────────────
    function buildGraph(data) {
      // Compute degree
      const degreeMap = {};
      data.nodes.forEach(n => { degreeMap[n.id] = 0; });
      data.links.forEach(l => {
        degreeMap[l.source] = (degreeMap[l.source] || 0) + 1;
        degreeMap[l.target] = (degreeMap[l.target] || 0) + 1;
      });

      // Assign colors and sizes
      computeNodeSizes(data.nodes, degreeMap);
      data.nodes.forEach(n => {
        n.color = n.nodeType === 'person' ? PC : (CC[n.category] || DC);
        n.borderColor = n.isFocus ? '#b71c1c' : n.nodeType === 'person' ? '#e69500' : (CC[n.category] || DC);
        n.degree = degreeMap[n.id] || 0;
      });
      data.links.forEach(l => { l.color = EC[l.type] || DEC; });

      // Build Cytoscape elements
      const cyNodes = data.nodes.map(n => ({
        group: 'nodes',
        data: {
          id: n.id,
          label: n.name || n.id,
          nodeType: n.nodeType,
          category: n.category || '',
          type: n.type || '',
          country: n.country || '',
          isFocus: n.isFocus || false,
          personId: n.personId || '',
          role: n.role || '',
          roleTag: n.roleTag || '',
          color: n.color,
          borderColor: n.borderColor,
          degree: n.degree,
          baseSize: n.baseSize,
          displaySize: n.displaySize,
        }
      }));

      const cyEdges = data.links.map((l, i) => ({
        group: 'edges',
        data: {
          id: 'e' + i,
          source: l.source,
          target: l.target,
          type: l.type || 'related',
          description: l.description || '',
          color: l.color,
        }
      }));

      // Stats
      const entries = data.nodes.filter(n => n.nodeType !== 'person');
      const people = data.nodes.filter(n => n.nodeType === 'person');
      document.getElementById('stats').innerHTML =
        '<b>' + entries.length + '</b> entries \u00b7 <b>' + people.length + '</b> people \u00b7 <b>' + data.links.length + '</b> links';

      // Category legend
      const cats = [...new Set(data.nodes.map(n => n.category))].filter(Boolean).sort();
      const catB = document.getElementById('cat-b');
      catB.innerHTML = '';
      cats.forEach(c => {
        const r = document.createElement('div'); r.className = 'li';
        const d = document.createElement('div'); d.className = 'ld';
        d.style.background = CC[c] || DC;
        if (c === 'People') { d.style.borderRadius = '2px'; d.style.transform = 'rotate(45deg)'; }
        r.appendChild(d);
        r.appendChild(document.createTextNode(c));
        r.onclick = function() {
          if (!cy) return;
          clearHighlights();
          const matches = cy.nodes().filter(n => n.data('category') === c);
          matches.addClass('found');
          document.getElementById('s-count').textContent = matches.length + ' in ' + c;
          document.getElementById('s-input').value = '';
          if (matches.length) cy.animate({ fit: { eles: matches, padding: 60 } }, { duration: 400 });
        };
        catB.appendChild(r);
      });

      // Edge legend
      const eTypes = [...new Set(data.links.map(l => l.type).filter(Boolean))].sort();
      const edgeB = document.getElementById('edge-b');
      edgeB.innerHTML = '';
      eTypes.forEach(t => {
        const r = document.createElement('div'); r.className = 'ei';
        const l = document.createElement('div'); l.className = 'el';
        l.style.background = EC[t] || DEC;
        r.appendChild(l);
        r.appendChild(document.createTextNode(t));
        edgeB.appendChild(r);
      });

      // Destroy old instance
      if (cy) { cy.destroy(); cy = null; }

      const lt = document.getElementById('ld-text');
      lt.textContent = 'Computing layout for ' + data.nodes.length + ' nodes...';
      const nodeCount = data.nodes.length;

      // Create Cytoscape instance
      cy = cytoscape({
        container: container,
        elements: cyNodes.concat(cyEdges),
        style: getCyStyle(),
        layout: { name: 'preset' },
        wheelSensitivity: 0.15,
        minZoom: 0.03,
        maxZoom: 6,
        boxSelectionEnabled: false,
        selectionType: 'single',
      });

      // ── Node hover ────────────────────
      cy.on('mouseover', 'node', function(evt) {
        const node = evt.target;
        container.style.cursor = 'pointer';
        clearHighlights();
        const neighborhood = node.closedNeighborhood();
        cy.elements().not(neighborhood).addClass('dimmed');
        neighborhood.addClass('highlighted');
        node.addClass('hovered');

        const d = node.data();
        let html;
        if (d.nodeType === 'person') {
          html = '<strong><i class="fa-solid fa-user"></i> ' + d.label + '</strong><br/>'
            + '<i class="fa-solid fa-briefcase"></i> ' + (d.role || 'Individual') + '<br/>'
            + '<i class="fa-solid fa-globe"></i> ' + (d.country || '')
            + '<br/><span style="color:#666;font-size:0.85em">' + (d.degree || 0) + ' connections</span>';
        } else {
          html = '<strong>' + d.label + '</strong>'
            + (d.isFocus ? '<span style="display:inline-block;padding:1px 6px;background:#c62828;color:#fff;border-radius:10px;font-size:0.7em;font-weight:700;margin-left:6px;">FOCUS</span>' : '') + '<br/>'
            + '<i class="fa-solid fa-building"></i> ' + (d.type || '') + '<br/>'
            + '<i class="fa-solid fa-globe"></i> ' + (d.country || '') + '<br/>'
            + '<span class="tip-cat" style="background:' + (CC[d.category] || DC) + '30;color:' + (CC[d.category] || DC) + '">' + (d.category || '') + '</span>'
            + '<br/><span style="color:#666;font-size:0.85em">' + (d.degree || 0) + ' connections</span>';
        }
        tipEl.innerHTML = html;
        tipEl.style.display = 'block';
        tipEl.style.left = Math.min(mouseX + 15, window.innerWidth - 360) + 'px';
        tipEl.style.top = Math.min(mouseY - 10, window.innerHeight - 120) + 'px';
      });

      cy.on('mouseout', 'node', function() {
        container.style.cursor = 'default';
        cy.elements().removeClass('dimmed highlighted hovered');
        tipEl.style.display = 'none';
      });

      // ── Edge hover ────────────────────
      cy.on('mouseover', 'edge', function(evt) {
        container.style.cursor = 'pointer';
        const d = evt.target.data();
        tipEl.innerHTML = '<strong>' + (d.type || 'related') + '</strong>'
          + (d.description ? '<br/>' + d.description : '')
          + '<br/><span style="color:#888;font-size:0.85em">Click to explore</span>';
        tipEl.style.display = 'block';
        tipEl.style.left = Math.min(mouseX + 15, window.innerWidth - 360) + 'px';
        tipEl.style.top = Math.min(mouseY - 10, window.innerHeight - 120) + 'px';
      });

      cy.on('mouseout', 'edge', function() {
        container.style.cursor = 'default';
        tipEl.style.display = 'none';
      });

      // ── Node click ────────────────────
      cy.on('tap', 'node', function(evt) {
        const d = evt.target.data();
        if (d.nodeType === 'person') {
          window.location.href = 'person.html?id=' + encodeURIComponent(d.personId || d.id);
        } else if (d.isFocus) {
          window.location.href = 'entry.html?religion=jewish&id=' + encodeURIComponent(d.id);
        } else {
          window.location.href = 'network.html?id=' + encodeURIComponent(d.id);
        }
      });

      // ── Edge click ────────────────────
      cy.on('tap', 'edge', function(evt) {
        const edge = evt.target;
        const d = edge.data();
        if (d.type === 'person-affiliation') {
          const srcD = edge.source().data();
          const tgtD = edge.target().data();
          const person = srcD.nodeType === 'person' ? srcD : tgtD.nodeType === 'person' ? tgtD : null;
          if (person) { window.location.href = 'person.html?id=' + encodeURIComponent(person.personId || person.id); return; }
        }
        const srcD = edge.source().data();
        const tgtD = edge.target().data();
        const entryD = (tgtD.nodeType === 'entry' && !tgtD.isFocus) ? tgtD : (srcD.nodeType === 'entry' && !srcD.isFocus) ? srcD : null;
        if (entryD) window.location.href = 'network.html?id=' + encodeURIComponent(entryD.id);
      });

      // ── Background click ──────────────
      cy.on('tap', function(evt) {
        if (evt.target === cy) {
          clearHighlights();
          document.getElementById('s-count').textContent = '';
          document.getElementById('s-input').value = '';
        }
      });

      // Resize handler
      const resizeObs = new ResizeObserver(() => { if (cy) cy.resize(); });
      resizeObs.observe(container);

      // ── Run fcose layout ──────────────
      const layoutConf = getLayoutConfig(nodeCount);
      const layout = cy.layout(layoutConf);
      layout.on('layoutstop', function() {
        document.getElementById('loading').classList.add('off');
      });
      layout.run();
    }

    // ─── Load focused graph ──────────────────────────────
    function loadGraph() {
      const depth = document.getElementById('depth-range').value;
      const ppl = document.getElementById('show-people').checked;
      let url = '/api/graph/focus/' + encodeURIComponent(focusEntryId)
        + '?depth=' + depth
        + '&people=' + (ppl ? '1' : '0');

      const ld = document.getElementById('loading');
      const lt = document.getElementById('ld-text');
      ld.classList.remove('off');
      lt.textContent = 'Fetching network data...';
      document.getElementById('stats').innerHTML = '<b>Loading...</b>';

      fetch(url).then(r => r.json()).then(data => {
        if (data.error) { lt.textContent = 'Entry not found: ' + focusEntryId; return; }
        isBigEntry = data.isBigEntry || false;

        const focusName = data.focusName || focusEntryId;
        document.getElementById('page-title').innerHTML = '<span class="focus-name">' + focusName + '</span> Network';
        document.getElementById('page-subtitle').textContent = data.nodes.length + ' nodes \u00b7 ' + data.links.length + ' connections \u00b7 Depth ' + data.depth;
        document.title = focusName + ' Network - The Juice Box';

        const pInfo = document.getElementById('people-info');
        if (data.totalPeople > 0) {
          const shownPeople = data.nodes.filter(n => n.nodeType === 'person').length;
          if (ppl && shownPeople > 0) {
            pInfo.innerHTML = 'Showing <b>' + shownPeople + '</b> of <b>' + data.totalPeople + '</b> associated individuals';
          } else {
            pInfo.innerHTML = '<b>' + data.totalPeople + '</b> associated individuals (toggle People in controls to show)';
          }
        } else {
          pInfo.innerHTML = '';
        }

        setSEO({
          title: focusName + ' Network - The Juice Box',
          description: 'Explore the full connection network of ' + focusName + '.',
          url: window.location.origin + '/network.html?id=' + focusEntryId
        });

        lt.textContent = 'Building graph with ' + data.nodes.length + ' nodes...';
        setTimeout(() => buildGraph(data), 30);
      }).catch(err => {
        console.error('Failed to load:', err);
        lt.textContent = 'Error loading data.';
      });
    }

    // ─── Controls ────────────────────────────────────────
    document.getElementById('btn-reload').onclick = loadGraph;

    document.getElementById('btn-fit').onclick = () => {
      if (cy) cy.animate({ fit: { padding: 50 } }, { duration: 400 });
    };

    document.getElementById('btn-entry').onclick = () => {
      window.location.href = 'entry.html?religion=jewish&id=' + encodeURIComponent(focusEntryId);
    };

    document.getElementById('show-people').onchange = loadGraph;

    document.getElementById('depth-range').oninput = function() {
      document.getElementById('depth-val').textContent = this.value;
    };
    document.getElementById('depth-range').onchange = loadGraph;

    // Node size slider - updates sizes live without re-layout
    document.getElementById('node-scale').oninput = function() {
      nodeScale = +this.value;
      if (!cy) return;
      const factor = nodeScale / 6;
      cy.startBatch();
      cy.nodes().forEach(n => {
        n.data('displaySize', Math.round(n.data('baseSize') * factor));
      });
      cy.endBatch();
    };

    // Spacing slider - re-runs layout on mouseup
    document.getElementById('link-dist').onchange = function() {
      spacingVal = +this.value;
      if (!cy) return;
      const nodeCount = cy.nodes().length;
      const ld = document.getElementById('loading');
      const lt = document.getElementById('ld-text');
      ld.classList.remove('off');
      lt.textContent = 'Re-computing layout...';
      const layoutConf = getLayoutConfig(nodeCount);
      const layout = cy.layout(layoutConf);
      layout.on('layoutstop', function() { ld.classList.add('off'); });
      layout.run();
    };

    // ─── Search ──────────────────────────────────────────
    function doSearch() {
      const q = document.getElementById('s-input').value.trim().toLowerCase();
      if (!cy) return;
      clearHighlights();
      if (!q) { document.getElementById('s-count').textContent = ''; return; }

      const matches = cy.nodes().filter(n => (n.data('label') || '').toLowerCase().includes(q));
      matches.addClass('found');
      const count = matches.length;
      document.getElementById('s-count').textContent = count ? count + ' found' : 'none';
      if (count) cy.animate({ fit: { eles: matches, padding: 60 } }, { duration: 400 });
    }

    document.getElementById('s-btn').onclick = doSearch;
    document.getElementById('s-input').onkeydown = function(e) { if (e.key === 'Enter') doSearch(); };
    document.getElementById('s-input').oninput = function() {
      if (!this.value.trim()) {
        clearHighlights();
        document.getElementById('s-count').textContent = '';
      }
    };

    // ─── Auto-load on page ready ─────────────────────────
    loadGraph();
  </script>
</body>
</html>
