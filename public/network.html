<!-- Juice Project - Est. 2016 | Last updated 2026 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="created" content="2016-03-14">
  <meta name="author" content="Juice Project">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="The Juice Box">
  <meta property="og:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:title" content="Focused Network">
  <meta property="og:description" content="Focused network visualization - explore connections for any entity in The Juice Box database.">
  <meta property="og:url" content="https://thejuicebox.live/network.html">
  <meta name="twitter:title" content="Focused Network">
  <meta name="twitter:description" content="Focused network visualization - explore connections for any entity in The Juice Box database.">
  <title>Focused Network</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: #000; background: #fff; }
    nav { padding: 10px 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    nav ul { list-style: none; margin: 0; padding: 10px 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; }
    nav ul li { margin: 0; white-space: nowrap; }
    nav a { color: #0000EE !important; text-decoration: none; background: rgba(255,255,255,0.85); padding: 5px 12px; white-space: nowrap; border-radius: 6px; border: 1px solid rgba(0,0,255,0.3); box-shadow: 1px 1px 2px rgba(0,0,0,0.2); font-size: 0.82em; display: inline-block; line-height: 1.4; }
    nav select { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(0,0,255,0.3); font-size: 0.85em; background: rgba(255,255,255,0.85); }
    .panel, .gp, .sb, .header-panel, .graph-wrap {
      background: rgba(255,255,255,0.15) !important; backdrop-filter: blur(12px) !important; -webkit-backdrop-filter: blur(12px) !important;
      border: 1px solid rgba(255,255,255,0.25) !important; border-radius: 12px !important; box-shadow: 0 8px 32px rgba(0,0,0,0.08) !important;
    }
    .gp:hover, .header-panel:hover { box-shadow: 0 8px 32px rgba(0,0,0,0.15) !important; border-color: rgba(255,255,255,0.35) !important; }
    nav a { background: rgba(255,255,255,0.2) !important; backdrop-filter: blur(8px) !important; -webkit-backdrop-filter: blur(8px) !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 8px !important; }
    nav select { background: rgba(255,255,255,0.2) !important; backdrop-filter: blur(8px) !important; -webkit-backdrop-filter: blur(8px) !important; border: 1px solid rgba(255,255,255,0.3) !important; }

    .main { max-width: 1600px; margin: 0 auto; padding: 15px 20px; }
    .header-panel { background: rgba(255,255,255,0.85); border: 1px solid rgba(0,0,255,0.2); border-radius: 8px; padding: 16px 20px; margin-bottom: 15px; }
    .header-panel h1 { margin: 0 0 4px 0; color: #0056b3; }
    .header-panel .focus-name { color: #c62828; font-weight: 800; }
    .header-panel .subtitle { color: #555; margin: 0; font-size: 0.95em; }
    .header-panel .back-links { margin-bottom: 6px; }
    .header-panel .back-links a { color: #0056b3; text-decoration: none; font-size: 0.85em; margin-right: 12px; }
    .header-panel .back-links a:hover { text-decoration: underline; }
    .people-info { font-size: 0.82em; color: #888; margin-top: 2px; }
    .people-info b { color: #0056b3; }

    .graph-wrap { position: relative; width: 100%; height: 85vh; min-height: 500px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(0,0,255,0.15); background: #f8f9fa; }
    #sigma-container { position: absolute; inset: 0; width: 100%; height: 100%; }

    .gp { overflow: hidden; transition: box-shadow 0.25s; }
    .gp-h { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; cursor: pointer; user-select: none; background: rgba(0,86,179,0.06); border-bottom: 1px solid rgba(0,0,255,0.08); transition: background 0.2s; }
    .gp-h:hover { background: rgba(0,86,179,0.12); }
    .gp-h strong, .gp-h h3 { color: #0056b3; font-size: 0.78em; font-weight: 600; margin: 0; }
    .gp-h .chv { color: #0056b3; font-size: 0.6em; transition: transform 0.25s; }
    .gp.shut .gp-b { display: none; }
    .gp.shut .gp-h { border-bottom: none; }
    .gp.shut .chv { transform: rotate(180deg); }

    .hud-ctrl { position: absolute; top: 10px; left: 10px; z-index: 12; width: 215px; }
    .cb { padding: 7px 10px 9px; }
    .cb label { font-size: 0.73em; color: #333; display: block; margin: 4px 0 1px; font-weight: 500; }
    .cb select { width: 100%; padding: 4px 6px; border-radius: 5px; border: 1px solid rgba(0,0,255,0.16); background: rgba(255,255,255,0.85); color: #333; font-size: 0.77em; outline: none; }
    .cb select:focus { border-color: #0056b3; }
    .cb input[type="range"] { width: 100%; margin: 2px 0; accent-color: #0056b3; }
    .cb .chks { display: flex; gap: 10px; margin: 5px 0 2px; }
    .cb .chks label { display: flex; align-items: center; gap: 3px; font-size: 0.73em; color: #333; cursor: pointer; margin: 0; }
    .cb .chks input[type="checkbox"] { accent-color: #0056b3; }
    .cb .btns { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
    .cb .btns button { flex: 1; padding: 4px 0; border-radius: 5px; border: 1px solid rgba(0,0,255,0.16); background: rgba(0,86,179,0.08); color: #0056b3; font-size: 0.73em; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 55px; }
    .cb .btns button:hover { background: rgba(0,86,179,0.18); }
    .cb .depth-row { display: flex; align-items: center; gap: 6px; }
    .cb .depth-row input { flex: 1; }
    .cb .depth-row span { font-size: 0.77em; color: #0056b3; font-weight: 700; min-width: 12px; text-align: center; }

    .hud-search { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 12; display: flex; align-items: center; }
    .hud-search input { padding: 5px 11px; border: 1px solid rgba(0,0,255,0.2); border-radius: 6px 0 0 6px; font-size: 0.77em; width: 200px; outline: none; background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); color: #333; }
    .hud-search input::placeholder { color: #888; }
    .hud-search input:focus { border-color: #0056b3; }
    .hud-search button { padding: 5px 9px; border: 1px solid rgba(0,0,255,0.2); border-left: none; border-radius: 0 6px 6px 0; background: rgba(0,86,179,0.1); color: #0056b3; cursor: pointer; font-size: 0.77em; transition: background 0.2s; }
    .hud-search button:hover { background: rgba(0,86,179,0.2); }
    .hud-search .sc { padding: 0 7px; font-size: 0.71em; color: #0056b3; white-space: nowrap; text-shadow: 0 0 4px rgba(255,255,255,0.9); }

    .hud-stats { position: absolute; top: 10px; right: 10px; z-index: 12; }
    .sb { padding: 5px 11px; font-size: 0.74em; color: #333; white-space: nowrap; }
    .sb b { color: #0056b3; font-weight: 700; }

    .hud-cat { position: absolute; bottom: 10px; left: 10px; z-index: 12; width: 190px; }
    .cat-b { padding: 4px 10px 7px; max-height: 180px; overflow-y: auto; }
    .li { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #333; margin: 1px 0; cursor: pointer; padding: 1px 2px; border-radius: 3px; transition: background 0.15s; }
    .li:hover { background: rgba(0,86,179,0.08); }
    .ld { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    .hud-edge { position: absolute; bottom: 10px; right: 10px; z-index: 12; width: 172px; }
    .edge-b { padding: 3px 10px 7px; max-height: 210px; overflow-y: auto; }
    .ei { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #333; margin: 1.5px 0; }
    .el { width: 15px; height: 3px; border-radius: 2px; flex-shrink: 0; }

    .cat-b::-webkit-scrollbar, .edge-b::-webkit-scrollbar { width: 4px; }
    .cat-b::-webkit-scrollbar-track, .edge-b::-webkit-scrollbar-track { background: transparent; }
    .cat-b::-webkit-scrollbar-thumb, .edge-b::-webkit-scrollbar-thumb { background: rgba(0,0,255,0.15); border-radius: 2px; }

    #tip {
      position: fixed; background: rgba(255,255,255,0.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      color: #222; padding: 10px 14px; border-radius: 9px; border: 1px solid rgba(0,0,255,0.15); font-size: 0.79em;
      pointer-events: none; z-index: 200; max-width: 340px; line-height: 1.55; display: none; box-shadow: 0 8px 28px rgba(0,0,0,0.12);
    }
    #tip strong { color: #0056b3; }
    #tip .tip-cat { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.85em; margin-top: 3px; }

    .ld-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 25; transition: opacity 0.5s; }
    .ld-overlay.off { opacity: 0; pointer-events: none; }
    .ld-spinner { width: 38px; height: 38px; border: 3px solid rgba(0,0,255,0.1); border-top-color: #0056b3; border-radius: 50%; animation: spin 0.75s linear infinite; }
    .ld-text { color: #0056b3; font-size: 0.82em; font-weight: 600; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 900px) { .hud-search input { width: 135px; } .hud-ctrl { width: 180px; } .hud-cat { width: 160px; } .hud-edge { width: 148px; } }
    @media (max-width: 600px) { .hud-search { display: none; } .hud-ctrl { width: 160px; } .hud-cat, .hud-edge { width: 135px; } }
  </style>
</head>
<body>
  <nav id="navbar"></nav>

  <div class="main">
  <div class="header-panel">
    <div class="back-links">
      <a href="graph.html"><i class="fa-solid fa-diagram-project"></i> Full Graph</a>
      <a href="index.html"><i class="fa-solid fa-house"></i> Home</a>
      <a href="#" id="btn-entry-top"><i class="fa-solid fa-building"></i> View Entry</a>
    </div>
    <h1><i class="fa-solid fa-spider-web"></i> <span id="page-title">Focused Network</span></h1>
    <p class="subtitle" id="page-subtitle">Loading network data...</p>
    <p class="people-info" id="people-info"></p>
  </div>

  <div class="graph-wrap">
    <div id="sigma-container"></div>

    <div class="ld-overlay" id="loading">
      <div class="ld-spinner"></div>
      <div class="ld-text" id="ld-text">Loading network data...</div>
    </div>

    <div class="hud-ctrl">
      <div class="gp" id="ctrl-p">
        <div class="gp-h" id="ctrl-t">
          <h3><i class="fa-solid fa-sliders"></i> Controls</h3>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cb">
          <label>Depth</label>
          <div class="depth-row">
            <input type="range" id="depth-range" min="1" max="3" value="1" step="1">
            <span id="depth-val">1</span>
          </div>
          <label>Layout</label>
          <select id="layout-select">
            <option value="forceatlas2" selected>Force-Directed</option>
            <option value="circular">Circular</option>
          </select>
          <div class="chks">
            <label><input type="checkbox" id="show-people" checked /> People</label>
            <label><input type="checkbox" id="show-labels" checked /> Labels</label>
          </div>
          <div class="btns">
            <button id="btn-reload"><i class="fa-solid fa-rotate"></i> Reload</button>
            <button id="btn-fit"><i class="fa-solid fa-compress"></i> Fit</button>
          </div>
          <div class="btns">
            <button id="btn-entry"><i class="fa-solid fa-building"></i> View Entry</button>
          </div>
        </div>
      </div>
    </div>

    <div class="hud-search">
      <input type="text" id="s-input" placeholder="Search nodes..." />
      <button id="s-btn"><i class="fa-solid fa-search"></i></button>
      <span class="sc" id="s-count"></span>
    </div>

    <div class="hud-stats">
      <div class="sb" id="stats"><b>Loading...</b></div>
    </div>

    <div class="hud-cat">
      <div class="gp" id="cat-p">
        <div class="gp-h" id="cat-t">
          <strong><i class="fa-solid fa-palette"></i> Categories</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cat-b" id="cat-b"></div>
      </div>
    </div>

    <div class="hud-edge">
      <div class="gp" id="edge-p">
        <div class="gp-h" id="edge-t">
          <strong><i class="fa-solid fa-link"></i> Connections</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b edge-b" id="edge-b"></div>
      </div>
    </div>
  </div>
  </div>

  <div id="tip"></div>

  <script src="app.js"></script>
  <script src="/lib/graph-lib.min.js"></script>
  <script>
  /* =================================================================
   *  SIGMA.JS v2 + GRAPHOLOGY + FORCEATLAS2 — WebGL GPU-rendered
   *  Focused network graph. Handles 1000+ nodes smoothly.
   * ================================================================= */
  initPage('jewish');

  // ─── Collapsible panels ──────────────────────────────
  ['ctrl','cat','edge'].forEach(k => {
    document.getElementById(k+'-t').onclick = () => document.getElementById(k+'-p').classList.toggle('shut');
  });

  // ─── Color maps ──────────────────────────────────────
  const CC = {
    'Entertainment & Media':'#e74c3c','Religion & Synagogues':'#9b59b6',
    'Culture & Arts':'#e67e22','Technology':'#2ecc71',
    'Community & Social Organizations':'#3498db','Education & Academia':'#1abc9c',
    'Education':'#1abc9c',
    'Representative & Umbrella Bodies':'#f39c12','Heritage & Memorials':'#8e44ad',
    'Charity & Philanthropy':'#e91e63','Investment & Private Equity':'#00bcd4',
    'Real Estate & Property':'#795548','Sports':'#ff5722',
    'Advocacy & Public Affairs':'#607d8b','Healthcare & Pharmaceuticals':'#4caf50',
    'Banking & Financial Services':'#ff9800','Research & Think Tanks':'#673ab7',
    'Retail & E-Commerce':'#009688','Defense & Security':'#f44336',
    'Food & Beverage':'#8bc34a','Conglomerates & Holding Companies':'#9e9e9e',
    'Government & Diplomacy':'#3f51b5','Fashion & Consumer Goods':'#ff4081',
    'Manufacturing & Industry':'#757575','Law Firms':'#455a64',
    'Notable Individuals':'#ffc107','Transportation':'#00acc1',
    'Advertising & PR':'#d81b60','Telecommunications':'#7c4dff',
    'Utilities & Energy':'#66bb6a','People':'#ffab40','Controversy':'#d32f2f',
    'Advocacy & Political Organizations':'#607d8b','Corporate':'#78909c',
    'Energy':'#66bb6a','Finance':'#ff9800','Government':'#3f51b5',
    'Intelligence':'#f44336','Legal':'#455a64','Media':'#e74c3c',
    'Non-Profit':'#4caf50','Philanthropy':'#e91e63','Philanthropy & Foundations':'#e91e63',
    'Political':'#f44336','Real Estate & Property':'#795548',
    'Retail & Consumer Goods':'#009688','Fashion & Luxury':'#ff4081',
    'Conglomerates':'#9e9e9e','Healthcare & Pharmaceuticals':'#4caf50',
    'Community & Social Organizations':'#3498db','Defense & Security':'#f44336'
  };
  const DC = '#546e7a', PC = '#ffab40';
  const EC = {
    'financial':'#ff9800','shared-person':'#9c27b0','political':'#f44336',
    'organizational':'#2196f3','ideological':'#4caf50','historical':'#795548',
    'legal':'#607d8b','related':'#78909c','partnership':'#00bcd4',
    'subsidiary':'#ff5722','funding':'#ffc107','membership':'#3f51b5',
    'affiliation':'#e91e63','leadership':'#8e44ad','collaboration':'#1abc9c',
    'person-affiliation':'#ffab40','industry peer':'#78909c',
    'affiliate':'#42a5f5','communal partner':'#4db6ac',
    'heritage partner':'#ab47bc','funder':'#ffa726',
    'community institution':'#66bb6a','religious partner':'#ce93d8',
    'umbrella body':'#5c6bc0','member':'#26a69a',
    'museum peer':'#7e57c2','cultural partner':'#ec407a',
    'regional connection':'#8d6e63','educational partner':'#29b6f6',
    'government partner':'#ef5350','sports affiliate':'#ff7043',
    'operating body':'#26c6da','governing body':'#d4e157',
    'preservation partner':'#9ccc65','support':'#7986cb',
    'diplomatic partner':'#f06292','historical support':'#a1887f',
    'parent organization':'#4fc3f7','research partner':'#ba68c8',
    'educational':'#1abc9c','lobbying':'#607d8b',
    'advocacy peer':'#607d8b','pro-Israel peer':'#5c6bc0',
    'super PAC':'#f44336','affiliated charity':'#e91e63',
    'lobbying target':'#3f51b5','congressional ally':'#3f51b5',
    'major donor':'#ff9800','diplomatic bridge':'#f06292',
    'pro-Israel ecosystem':'#4caf50','think tank engagement':'#673ab7',
    'social connection':'#9c27b0','academic donation':'#1abc9c',
    'alleged intelligence connection':'#f44336',
    'science connection':'#2ecc71','property':'#795548',
    'investigation':'#607d8b','social':'#9c27b0'
  };
  const DEC = '#90a4ae';

  // ─── Parse URL ───────────────────────────────────────
  const ID_ALIASES = { 'jeffrey-epstein-network': 'epstein-network' };
  const params = new URLSearchParams(window.location.search);
  let focusEntryId = params.get('id') || 'epstein-network';
  if (ID_ALIASES[focusEntryId]) {
    focusEntryId = ID_ALIASES[focusEntryId];
    const newUrl = new URL(window.location);
    newUrl.searchParams.set('id', focusEntryId);
    window.history.replaceState({}, '', newUrl);
  }
  document.getElementById('btn-entry-top').href = 'entry.html?religion=jewish&id=' + encodeURIComponent(focusEntryId);
  document.getElementById('btn-entry').onclick = () => {
    window.location.href = 'entry.html?religion=jewish&id=' + encodeURIComponent(focusEntryId);
  };

  const tipEl = document.getElementById('tip');
  const containerEl = document.getElementById('sigma-container');
  let renderer = null;
  let graph = null;
  let hoveredNode = null;
  let searchMatches = new Set();
  let showLabels = true;

  // ─── Tooltip helpers ─────────────────────────────────
  let lastMouseX = 0, lastMouseY = 0;
  document.addEventListener('mousemove', e => { lastMouseX = e.clientX; lastMouseY = e.clientY; });

  function showTip(html) {
    tipEl.innerHTML = html;
    tipEl.style.display = 'block';
    tipEl.style.left = Math.min(lastMouseX + 15, window.innerWidth - 360) + 'px';
    tipEl.style.top = Math.min(lastMouseY - 10, window.innerHeight - 120) + 'px';
  }
  function hideTip() { tipEl.style.display = 'none'; }

  // ─── Circular layout helper ──────────────────────────
  function applyCircularLayout(g, focusId) {
    let i = 0;
    const N = g.order;
    g.forEachNode((node) => {
      if (node === focusId) {
        g.setNodeAttribute(node, 'x', 0);
        g.setNodeAttribute(node, 'y', 0);
      } else {
        const angle = (2 * Math.PI * i) / (N - (focusId ? 1 : 0));
        g.setNodeAttribute(node, 'x', 10 * Math.cos(angle));
        g.setNodeAttribute(node, 'y', 10 * Math.sin(angle));
        i++;
      }
    });
  }

  // ─── Build graph from API data ──────────────────────
  function buildGraph(data) {
    if (renderer) { renderer.kill(); renderer = null; }

    graph = new Graph();

    // Compute degrees
    const degMap = {};
    data.nodes.forEach(n => { degMap[n.id] = 0; });
    data.links.forEach(l => {
      degMap[l.source] = (degMap[l.source] || 0) + 1;
      degMap[l.target] = (degMap[l.target] || 0) + 1;
    });

    // Add nodes with circular initial positions
    const N = data.nodes.length;
    const focusData = data.nodes.find(n => n.isFocus);
    const focusId = focusData ? focusData.id : null;

    data.nodes.forEach((n, i) => {
      const deg = degMap[n.id] || 0;
      const isPerson = n.nodeType === 'person';
      const isFocus = !!n.isFocus;
      const catColor = CC[n.category] || DC;
      const angle = (2 * Math.PI * i) / N;

      graph.addNode(n.id, {
        x: isFocus ? 0 : 10 * Math.cos(angle),
        y: isFocus ? 0 : 10 * Math.sin(angle),
        size: isFocus ? 18 : isPerson ? Math.max(3, 2 + Math.sqrt(deg) * 0.8) : Math.max(5, 3 + Math.sqrt(deg) * 1.5),
        label: n.name,
        color: isFocus ? '#c62828' : isPerson ? PC : catColor,
        nodeType: n.nodeType,
        category: n.category || '',
        country: n.country || '',
        entryType: n.type || '',
        role: n.role || '',
        personId: n.personId || '',
        isFocus: isFocus,
        degree: deg,
        origColor: isFocus ? '#c62828' : isPerson ? PC : catColor
      });
    });

    // Add edges (skip duplicates)
    const edgeSet = new Set();
    data.links.forEach(l => {
      if (!graph.hasNode(l.source) || !graph.hasNode(l.target)) return;
      const key = l.source < l.target ? l.source + '|' + l.target : l.target + '|' + l.source;
      if (edgeSet.has(key)) return;
      edgeSet.add(key);
      try {
        graph.addEdge(l.source, l.target, {
          color: EC[l.type] || DEC,
          origColor: EC[l.type] || DEC,
          size: l.type === 'person-affiliation' ? 0.3 : 0.6,
          edgeType: l.type || 'related',
          description: l.description || ''
        });
      } catch(e) { /* skip duplicate */ }
    });

    // Run layout
    const layoutName = document.getElementById('layout-select').value;
    document.getElementById('ld-text').textContent = 'Computing layout for ' + N + ' nodes...';

    if (layoutName === 'forceatlas2') {
      const iterations = N > 500 ? 80 : N > 200 ? 150 : 300;
      forceAtlas2.assign(graph, {
        iterations: iterations,
        settings: {
          gravity: 1.5,
          scalingRatio: N > 300 ? 8 : 4,
          barnesHutOptimize: N > 50,
          strongGravityMode: false,
          slowDown: 5,
          outboundAttractionDistribution: true
        }
      });
    } else {
      applyCircularLayout(graph, focusId);
    }

    // Pin focus node at center after layout
    if (focusId && graph.hasNode(focusId)) {
      graph.setNodeAttribute(focusId, 'x', 0);
      graph.setNodeAttribute(focusId, 'y', 0);
    }

    // Create Sigma renderer
    renderer = new Sigma(graph, containerEl, {
      renderEdgeLabels: false,
      labelSize: 14,
      labelFont: 'Arial',
      labelWeight: 'bold',
      labelColor: { color: '#222' },
      labelDensity: 0.12,
      labelGridCellSize: 80,
      labelRenderedSizeThreshold: 3,
      zIndex: true,
      minCameraRatio: 0.02,
      maxCameraRatio: 20,
      defaultEdgeType: 'line',
      nodeReducer: function(node, data) {
        var res = Object.assign({}, data);
        if (hoveredNode) {
          if (node === hoveredNode) {
            res.highlighted = true;
            res.zIndex = 2;
          } else if (graph.areNeighbors(hoveredNode, node)) {
            res.zIndex = 1;
          } else {
            res.color = '#e8e8e8';
            res.label = '';
            res.zIndex = 0;
          }
        }
        if (searchMatches.size > 0 && !hoveredNode) {
          if (searchMatches.has(node)) {
            res.highlighted = true;
            res.zIndex = 2;
          } else {
            res.color = '#e8e8e8';
            res.label = '';
          }
        }
        if (!showLabels && !res.highlighted) res.label = '';
        return res;
      },
      edgeReducer: function(edge, data) {
        var res = Object.assign({}, data);
        if (hoveredNode) {
          if (graph.hasExtremity(edge, hoveredNode)) {
            res.size = 2;
            res.zIndex = 1;
          } else {
            res.hidden = true;
          }
        }
        if (searchMatches.size > 0 && !hoveredNode) {
          var ends = graph.extremities(edge);
          if (!searchMatches.has(ends[0]) && !searchMatches.has(ends[1])) {
            res.hidden = true;
          }
        }
        return res;
      }
    });

    // ─── Sigma events ────────────────────────────────
    renderer.on('enterNode', function(e) {
      hoveredNode = e.node;
      containerEl.style.cursor = 'pointer';
      var d = graph.getNodeAttributes(e.node);
      var html;
      if (d.nodeType === 'person') {
        html = '<strong><i class="fa-solid fa-user"></i> ' + d.label + '</strong><br/>'
          + '<i class="fa-solid fa-briefcase"></i> ' + (d.role || 'Individual') + '<br/>'
          + '<i class="fa-solid fa-globe"></i> ' + (d.country || '')
          + '<br/><span style="color:#666;font-size:0.85em">' + (d.degree || 0) + ' connections</span>';
      } else {
        html = '<strong>' + d.label + '</strong><br/>'
          + '<i class="fa-solid fa-building"></i> ' + (d.entryType || '') + '<br/>'
          + '<i class="fa-solid fa-globe"></i> ' + (d.country || '') + '<br/>'
          + '<span class="tip-cat" style="background:' + (d.origColor || DC) + '30;color:' + (d.origColor || DC) + '">' + (d.category || '') + '</span>'
          + '<br/><span style="color:#666;font-size:0.85em">' + (d.degree || 0) + ' connections</span>';
      }
      showTip(html);
      renderer.refresh();
    });

    renderer.on('leaveNode', function() {
      hoveredNode = null;
      containerEl.style.cursor = 'default';
      hideTip();
      renderer.refresh();
    });

    renderer.on('clickNode', function(e) {
      var d = graph.getNodeAttributes(e.node);
      if (d.nodeType === 'person') {
        window.location.href = 'person.html?id=' + encodeURIComponent(d.personId || e.node);
      } else if (d.isFocus) {
        window.location.href = 'entry.html?religion=jewish&id=' + encodeURIComponent(e.node);
      } else {
        window.location.href = 'network.html?id=' + encodeURIComponent(e.node);
      }
    });

    renderer.on('clickStage', function() {
      searchMatches = new Set();
      document.getElementById('s-count').textContent = '';
      document.getElementById('s-input').value = '';
      renderer.refresh();
    });

    // ─── Stats ──────────────────────────────────────
    var entryCount = data.nodes.filter(function(n) { return n.nodeType !== 'person'; }).length;
    var peopleCount = data.nodes.filter(function(n) { return n.nodeType === 'person'; }).length;
    document.getElementById('stats').innerHTML =
      '<b>' + entryCount + '</b> entries &middot; <b>' + peopleCount + '</b> people &middot; <b>' + graph.size + '</b> links';

    if (data.focusName) {
      setSEO({ title: data.focusName + ' Network - Juice Project', description: 'Network graph for ' + data.focusName });
      document.getElementById('page-title').innerHTML = '<span class="focus-name">' + data.focusName + '</span> Network';
      document.getElementById('page-subtitle').textContent =
        entryCount + ' nodes \u00B7 ' + graph.size + ' connections \u00B7 Depth ' + document.getElementById('depth-range').value;
    }
    if (data.totalPeople !== undefined) {
      var showing = document.getElementById('show-people').checked;
      document.getElementById('people-info').innerHTML = showing
        ? 'Showing <b>' + peopleCount + '</b> of <b>' + data.totalPeople + '</b> associated individuals'
        : '<b>' + data.totalPeople + '</b> people available \u2014 check "People" to show';
    }

    buildCatLegend(data.nodes);
    buildEdgeLegend(data.links);

    setTimeout(function() { document.getElementById('loading').classList.add('off'); }, 200);
  }

  function buildCatLegend(nodeList) {
    var cats = []; var seen = {};
    nodeList.forEach(function(n) { if (n.category && !seen[n.category]) { seen[n.category] = true; cats.push(n.category); } });
    cats.sort();
    var catB = document.getElementById('cat-b');
    catB.innerHTML = '';
    cats.forEach(function(c) {
      var r = document.createElement('div'); r.className = 'li';
      var d = document.createElement('div'); d.className = 'ld';
      d.style.background = CC[c] || DC;
      r.appendChild(d);
      r.appendChild(document.createTextNode(c));
      r.onclick = function() {
        searchMatches = new Set();
        graph.forEachNode(function(node, attrs) {
          if (attrs.category === c) searchMatches.add(node);
        });
        document.getElementById('s-count').textContent = searchMatches.size + ' in ' + c;
        document.getElementById('s-input').value = '';
        renderer.refresh();
      };
      catB.appendChild(r);
    });
  }

  function buildEdgeLegend(linkList) {
    var eTypes = []; var seen = {};
    linkList.forEach(function(l) { if (l.type && !seen[l.type]) { seen[l.type] = true; eTypes.push(l.type); } });
    eTypes.sort();
    var edgeB = document.getElementById('edge-b');
    edgeB.innerHTML = '';
    eTypes.forEach(function(t) {
      var r = document.createElement('div'); r.className = 'ei';
      var l = document.createElement('div'); l.className = 'el';
      l.style.background = EC[t] || DEC;
      r.appendChild(l);
      r.appendChild(document.createTextNode(t));
      edgeB.appendChild(r);
    });
  }

  // ─── Data loading ────────────────────────────────────
  function loadGraph() {
    var depth = document.getElementById('depth-range').value;
    var ppl = document.getElementById('show-people').checked;
    var url = '/api/graph/focus/' + encodeURIComponent(focusEntryId) + '?depth=' + depth + '&people=' + (ppl ? '1' : '0');

    var ld = document.getElementById('loading');
    ld.classList.remove('off');
    document.getElementById('ld-text').textContent = 'Fetching network data...';
    document.getElementById('stats').innerHTML = '<b>Loading...</b>';

    fetch(url).then(function(r) { return r.json(); }).then(function(data) {
      if (!data.nodes || data.nodes.length === 0) {
        document.getElementById('ld-text').textContent = 'No data found for this entry.';
        return;
      }
      buildGraph(data);
    }).catch(function(err) {
      console.error('Load error:', err);
      document.getElementById('ld-text').textContent = 'Error loading data: ' + err.message;
    });
  }

  // ─── Controls ────────────────────────────────────────
  document.getElementById('depth-range').oninput = function() {
    document.getElementById('depth-val').textContent = this.value;
  };
  document.getElementById('depth-range').onchange = loadGraph;
  document.getElementById('btn-reload').onclick = loadGraph;
  document.getElementById('btn-fit').onclick = function() {
    if (renderer) renderer.getCamera().animatedReset({ duration: 500 });
  };
  document.getElementById('show-people').onchange = loadGraph;
  document.getElementById('layout-select').onchange = loadGraph;
  document.getElementById('show-labels').onchange = function() {
    showLabels = this.checked;
    if (renderer) renderer.refresh();
  };

  // ─── Search ──────────────────────────────────────────
  function doSearch() {
    var q = document.getElementById('s-input').value.trim().toLowerCase();
    searchMatches = new Set();
    if (!q) { document.getElementById('s-count').textContent = ''; if (renderer) renderer.refresh(); return; }
    graph.forEachNode(function(node, attrs) {
      if ((attrs.label || '').toLowerCase().indexOf(q) !== -1) searchMatches.add(node);
    });
    document.getElementById('s-count').textContent = searchMatches.size ? searchMatches.size + ' found' : 'none';
    if (renderer) renderer.refresh();
  }
  document.getElementById('s-btn').onclick = doSearch;
  document.getElementById('s-input').onkeydown = function(e) { if (e.key === 'Enter') doSearch(); };
  document.getElementById('s-input').oninput = function() {
    if (!this.value.trim()) {
      searchMatches = new Set();
      document.getElementById('s-count').textContent = '';
      if (renderer) renderer.refresh();
    }
  };

  // ─── Init ────────────────────────────────────────────
  loadGraph();
  </script>
</body>
</html>
