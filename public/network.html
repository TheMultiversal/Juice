<!-- Juice Project - Est. 2016 | Last updated 2026 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="created" content="2016-03-14">
  <meta name="author" content="Juice Project">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="The Juice Box">
  <meta property="og:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:title" content="Focused Network">
  <meta property="og:description" content="Interactive network explorer for The Juice Box database.">
  <meta property="og:url" content="https://thejuicebox.live/network.html">
  <meta name="twitter:title" content="Focused Network">
  <meta name="twitter:description" content="Interactive network explorer for The Juice Box database.">
  <title>Focused Network</title>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    body{font-family:Arial,sans-serif;margin:0;padding:0;color:#000;background:#fff}
    nav{padding:10px 20px;overflow-x:auto;-webkit-overflow-scrolling:touch}
    nav ul{list-style:none;margin:0;padding:10px 15px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center}
    nav ul li{margin:0;white-space:nowrap}
    nav a{color:#0000EE!important;text-decoration:none;background:rgba(255,255,255,.85);padding:5px 12px;white-space:nowrap;border-radius:6px;border:1px solid rgba(0,0,255,.3);box-shadow:1px 1px 2px rgba(0,0,0,.2);font-size:.82em;display:inline-block;line-height:1.4}
    nav select{padding:6px 10px;border-radius:6px;border:1px solid rgba(0,0,255,.3);font-size:.85em;background:rgba(255,255,255,.85)}
    nav a{background:rgba(255,255,255,.2)!important;backdrop-filter:blur(8px)!important;-webkit-backdrop-filter:blur(8px)!important;border:1px solid rgba(255,255,255,.3)!important;border-radius:8px!important}
    nav select{background:rgba(255,255,255,.2)!important;backdrop-filter:blur(8px)!important;-webkit-backdrop-filter:blur(8px)!important;border:1px solid rgba(255,255,255,.3)!important}

    .main{max-width:1600px;margin:0 auto;padding:15px 20px}
    .header-panel{background:rgba(255,255,255,.85);border:1px solid rgba(0,0,255,.2);border-radius:8px;padding:16px 20px;margin-bottom:15px;backdrop-filter:blur(12px);box-shadow:0 4px 20px rgba(0,0,0,.06)}
    .header-panel h1{margin:0 0 4px;color:#0056b3}
    .header-panel .focus-name{color:#c62828;font-weight:800}
    .header-panel .subtitle{color:#555;margin:0;font-size:.95em}
    .header-panel .back-links{margin-bottom:6px}
    .header-panel .back-links a{color:#0056b3;text-decoration:none;font-size:.85em;margin-right:12px}
    .header-panel .back-links a:hover{text-decoration:underline}
    .people-info{font-size:.82em;color:#888;margin-top:2px}
    .people-info b{color:#0056b3}

    .graph-wrap{position:relative;width:100%;height:85vh;min-height:500px;border-radius:12px;overflow:hidden;border:1px solid rgba(0,0,255,.15);background:#fafbfc}
    #tree-svg{width:100%;height:100%;display:block}

    .gp{overflow:hidden;transition:box-shadow .25s;background:rgba(255,255,255,.88)!important;backdrop-filter:blur(12px)!important;border:1px solid rgba(255,255,255,.25)!important;border-radius:12px!important;box-shadow:0 8px 32px rgba(0,0,0,.08)!important}
    .gp:hover{box-shadow:0 8px 32px rgba(0,0,0,.15)!important}
    .gp-h{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;cursor:pointer;user-select:none;background:rgba(0,86,179,.06);border-bottom:1px solid rgba(0,0,255,.08);transition:background .2s}
    .gp-h:hover{background:rgba(0,86,179,.12)}
    .gp-h strong,.gp-h h3{color:#0056b3;font-size:.78em;font-weight:600;margin:0}
    .gp-h .chv{color:#0056b3;font-size:.6em;transition:transform .25s}
    .gp.shut .gp-b{display:none}
    .gp.shut .gp-h{border-bottom:none}
    .gp.shut .chv{transform:rotate(180deg)}

    .hud-ctrl{position:absolute;top:10px;left:10px;z-index:12;width:215px}
    .cb{padding:7px 10px 9px}
    .cb label{font-size:.73em;color:#333;display:block;margin:4px 0 1px;font-weight:500}
    .cb .chks{display:flex;gap:10px;margin:5px 0 2px}
    .cb .chks label{display:flex;align-items:center;gap:3px;font-size:.73em;color:#333;cursor:pointer;margin:0}
    .cb .chks input[type=checkbox]{accent-color:#0056b3}
    .cb .btns{display:flex;gap:5px;margin-top:5px;flex-wrap:wrap}
    .cb .btns button{flex:1;padding:4px 0;border-radius:5px;border:1px solid rgba(0,0,255,.16);background:rgba(0,86,179,.08);color:#0056b3;font-size:.73em;font-weight:600;cursor:pointer;transition:all .2s;min-width:55px}
    .cb .btns button:hover{background:rgba(0,86,179,.18)}
    .cb .depth-row{display:flex;align-items:center;gap:6px}
    .cb .depth-row input{flex:1;accent-color:#0056b3}
    .cb .depth-row span{font-size:.77em;color:#0056b3;font-weight:700;min-width:12px;text-align:center}

    .hud-search{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:12;display:flex;align-items:center}
    .hud-search input{padding:5px 11px;border:1px solid rgba(0,0,255,.2);border-radius:6px 0 0 6px;font-size:.77em;width:200px;outline:0;background:rgba(255,255,255,.85);backdrop-filter:blur(12px);color:#333}
    .hud-search input::placeholder{color:#888}
    .hud-search input:focus{border-color:#0056b3}
    .hud-search button{padding:5px 9px;border:1px solid rgba(0,0,255,.2);border-left:none;border-radius:0 6px 6px 0;background:rgba(0,86,179,.1);color:#0056b3;cursor:pointer;font-size:.77em;transition:background .2s}
    .hud-search button:hover{background:rgba(0,86,179,.2)}
    .hud-search .sc{padding:0 7px;font-size:.71em;color:#0056b3;white-space:nowrap;text-shadow:0 0 4px rgba(255,255,255,.9)}

    .hud-stats{position:absolute;top:10px;right:10px;z-index:12}
    .sb{padding:5px 11px;font-size:.74em;color:#333;white-space:nowrap;background:rgba(255,255,255,.88)!important;backdrop-filter:blur(12px)!important;border:1px solid rgba(255,255,255,.25)!important;border-radius:12px!important;box-shadow:0 4px 16px rgba(0,0,0,.06)!important}
    .sb b{color:#0056b3;font-weight:700}

    .hud-legend{position:absolute;bottom:10px;right:10px;z-index:12;width:200px}
    .leg-b{padding:4px 10px 7px;max-height:250px;overflow-y:auto}
    .li{display:flex;align-items:center;gap:5px;font-size:.69em;color:#333;margin:1px 0;padding:1px 2px;border-radius:3px}
    .ld{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .leg-b::-webkit-scrollbar{width:4px}
    .leg-b::-webkit-scrollbar-track{background:0 0}
    .leg-b::-webkit-scrollbar-thumb{background:rgba(0,0,255,.15);border-radius:2px}

    #tip{position:fixed;background:rgba(255,255,255,.95);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);color:#222;padding:10px 14px;border-radius:9px;border:1px solid rgba(0,0,255,.15);font-size:.79em;pointer-events:none;z-index:200;max-width:340px;line-height:1.55;display:none;box-shadow:0 8px 28px rgba(0,0,0,.12)}
    #tip strong{color:#0056b3}
    #tip .tip-cat{display:inline-block;padding:1px 6px;border-radius:3px;font-size:.85em;margin-top:3px}

    .ld-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;background:rgba(255,255,255,.8);backdrop-filter:blur(4px);z-index:25;transition:opacity .25s}
    .ld-overlay.off{opacity:0;pointer-events:none}
    .ld-spinner{width:38px;height:38px;border:3px solid rgba(0,0,255,.1);border-top-color:#0056b3;border-radius:50%;animation:spin .75s linear infinite}
    .ld-text{color:#0056b3;font-size:.82em;font-weight:600}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ─── Tree node styles ───────────────────────────── */
    .tree-link{fill:none;stroke-width:1.6;opacity:.45}
    .tree-node{cursor:pointer}
    .tree-node:hover .node-bg{filter:brightness(.97);stroke-width:2.2!important}
    .node-bg{transition:filter .15s,stroke-width .15s}
    .node-name{font-size:11.5px;fill:#222;pointer-events:none}
    .node-info{font-size:9.5px;fill:#888;pointer-events:none}
    .node-toggle{font-size:13px;font-weight:700;fill:#0056b3;pointer-events:none}
    .node-icon{pointer-events:none}
    .node-conns{font-size:8.5px;fill:#aaa;pointer-events:none}
    .tree-node.search-hit .node-bg{stroke:#ff6f00!important;stroke-width:2.5!important;filter:drop-shadow(0 0 4px rgba(255,111,0,.4))}
    .tree-node.search-hit .node-name{fill:#e65100!important;font-weight:700}
    .tree-node.node-loading .node-bg{animation:node-pulse .7s ease-in-out infinite}
    @keyframes node-pulse{0%,100%{stroke-opacity:1;stroke-width:1.5px}50%{stroke-opacity:.5;stroke-width:3px}}

    /* ─── Tier group (people side) colors ────────────── */
    .tier-inner-circle .node-bg{fill:#fff0f0;stroke:#c62828}
    .tier-inner-circle .node-cat-bar{fill:#c62828}
    .tier-victims .node-bg{fill:#fff3e0;stroke:#e65100}
    .tier-victims .node-cat-bar{fill:#e65100}
    .tier-close-assoc .node-bg{fill:#fce4ec;stroke:#ad1457}
    .tier-close-assoc .node-cat-bar{fill:#ad1457}
    .tier-political .node-bg{fill:#e8eaf6;stroke:#283593}
    .tier-political .node-cat-bar{fill:#283593}
    .tier-legal .node-bg{fill:#efebe9;stroke:#4e342e}
    .tier-legal .node-cat-bar{fill:#4e342e}
    .tier-science .node-bg{fill:#e0f7fa;stroke:#00695c}
    .tier-science .node-cat-bar{fill:#00695c}
    .tier-media .node-bg{fill:#fce4ec;stroke:#c2185b}
    .tier-media .node-cat-bar{fill:#c2185b}
    .tier-social .node-bg{fill:#f3e5f5;stroke:#6a1b9a}
    .tier-social .node-cat-bar{fill:#6a1b9a}
    .tier-business .node-bg{fill:#e3f2fd;stroke:#1565c0}
    .tier-business .node-cat-bar{fill:#1565c0}
    .tier-other .node-bg{fill:#f5f5f5;stroke:#616161}
    .tier-other .node-cat-bar{fill:#616161}

    @media (max-width:900px){.hud-search input{width:135px}.hud-ctrl{width:180px}.hud-legend{width:160px}}
    @media (max-width:600px){.hud-search{display:none}.hud-ctrl{width:160px}.hud-legend{width:135px}}
  </style>
</head>
<body>
  <nav id="navbar"></nav>
  <div class="main">
    <div class="header-panel">
      <div class="back-links">
        <a href="graph.html"><i class="fa-solid fa-database"></i> All Entries</a>
        <a href="index.html"><i class="fa-solid fa-house"></i> Home</a>
        <a href="#" id="btn-entry-top"><i class="fa-solid fa-building"></i> View Entry</a>
      </div>
      <h1><i class="fa-solid fa-spider-web"></i> <span id="page-title">Focused Network</span></h1>
      <p class="subtitle" id="page-subtitle">Loading network data...</p>
      <p class="people-info" id="people-info"></p>
    </div>

    <div class="graph-wrap">
      <svg id="tree-svg"></svg>
      <div class="ld-overlay" id="loading">
        <div class="ld-spinner"></div>
        <div class="ld-text" id="ld-text">Loading network data...</div>
      </div>

      <div class="hud-ctrl">
        <div class="gp" id="ctrl-p">
          <div class="gp-h" id="ctrl-t">
            <h3><i class="fa-solid fa-sliders"></i> Controls</h3>
            <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
          </div>
          <div class="gp-b cb">
            <label>Depth</label>
            <div class="depth-row">
              <input type="range" id="depth-range" min="1" max="3" value="1" step="1">
              <span id="depth-val">1</span>
            </div>
            <div class="chks">
              <label><input type="checkbox" id="show-people" checked> People</label>
            </div>
            <label>Filter by Tier</label>
            <select id="tier-filter" style="width:100%;padding:3px 6px;border-radius:5px;border:1px solid rgba(0,0,255,.16);font-size:.73em;margin:3px 0">
              <option value="all">All Tiers</option>
            </select>
            <label>Node Size</label>
            <div class="depth-row">
              <input type="range" id="node-size-range" min="60" max="100" value="100" step="10">
              <span id="node-size-val">100%</span>
            </div>
            <label>Link Opacity</label>
            <div class="depth-row">
              <input type="range" id="link-opacity-range" min="10" max="100" value="45" step="5">
              <span id="link-opacity-val">45%</span>
            </div>
            <div class="btns">
              <button id="btn-reload"><i class="fa-solid fa-rotate"></i> Reload</button>
              <button id="btn-fit"><i class="fa-solid fa-compress"></i> Fit</button>
            </div>
            <div class="btns">
              <button id="btn-expand-all"><i class="fa-solid fa-expand"></i> Open All</button>
              <button id="btn-collapse"><i class="fa-solid fa-minimize"></i> Collapse</button>
            </div>
            <div class="btns">
              <button id="btn-expand-right"><i class="fa-solid fa-sitemap"></i> Orgs</button>
              <button id="btn-expand-left"><i class="fa-solid fa-users"></i> People</button>
            </div>
            <div class="btns">
              <button id="btn-entry"><i class="fa-solid fa-building"></i> Entry Page</button>
            </div>
          </div>
        </div>
      </div>

      <div class="hud-search">
        <input type="text" id="s-input" placeholder="Search nodes...">
        <button id="s-btn"><i class="fa-solid fa-search"></i></button>
        <span class="sc" id="s-count"></span>
      </div>

      <div class="hud-stats">
        <div class="sb" id="stats"><b>Loading...</b></div>
      </div>

      <div class="hud-legend">
        <div class="gp" id="leg-p">
          <div class="gp-h" id="leg-t">
            <strong><i class="fa-solid fa-palette"></i> People Tiers</strong>
            <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
          </div>
          <div class="gp-b leg-b" id="leg-b"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="tip"></div>

  <script src="app.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
  /* =================================================================
   *  D3.js DUAL-SIDED COLLAPSIBLE TREE
   *  LEFT  = People (grouped by severity / proximity tiers)
   *  RIGHT = Organizations / connected entries
   *  Root (focus entry) sits at CENTER
   * ================================================================= */
  initPage('jewish');

  // ─── Collapsible HUD panels ──────────────────────────
  ['ctrl','leg'].forEach(k => {
    document.getElementById(k+'-t').onclick = () => document.getElementById(k+'-p').classList.toggle('shut');
  });

  // ─── Color maps ──────────────────────────────────────
  const CC = {
    'Entertainment & Media':'#e74c3c','Religion & Synagogues':'#9b59b6',
    'Culture & Arts':'#e67e22','Technology':'#2ecc71',
    'Community & Social Organizations':'#3498db','Education & Academia':'#1abc9c',
    'Education':'#1abc9c','Representative & Umbrella Bodies':'#f39c12',
    'Heritage & Memorials':'#8e44ad','Charity & Philanthropy':'#e91e63',
    'Investment & Private Equity':'#00bcd4','Real Estate & Property':'#795548',
    'Sports':'#ff5722','Advocacy & Public Affairs':'#607d8b',
    'Healthcare & Pharmaceuticals':'#4caf50','Banking & Financial Services':'#ff9800',
    'Research & Think Tanks':'#673ab7','Retail & E-Commerce':'#009688',
    'Defense & Security':'#f44336','Food & Beverage':'#8bc34a',
    'Conglomerates & Holding Companies':'#9e9e9e','Government & Diplomacy':'#3f51b5',
    'Fashion & Consumer Goods':'#ff4081','Manufacturing & Industry':'#757575',
    'Law Firms':'#455a64','Notable Individuals':'#ffc107','Transportation':'#00acc1',
    'Advertising & PR':'#d81b60','Telecommunications':'#7c4dff',
    'Utilities & Energy':'#66bb6a','People':'#ffab40','Controversy':'#d32f2f',
    'Advocacy & Political Organizations':'#607d8b','Corporate':'#78909c',
    'Energy':'#66bb6a','Finance':'#ff9800','Government':'#3f51b5',
    'Intelligence':'#f44336','Legal':'#455a64','Media':'#e74c3c',
    'Non-Profit':'#4caf50','Philanthropy':'#e91e63','Philanthropy & Foundations':'#e91e63',
    'Political':'#f44336','Retail & Consumer Goods':'#009688','Fashion & Luxury':'#ff4081',
    'Conglomerates':'#9e9e9e'
  };
  const DC = '#546e7a', PC = '#ffab40';
  const EC = {
    'financial':'#ff9800','shared-person':'#9c27b0','political':'#f44336',
    'organizational':'#2196f3','ideological':'#4caf50','historical':'#795548',
    'legal':'#607d8b','related':'#78909c','partnership':'#00bcd4',
    'subsidiary':'#ff5722','funding':'#ffc107','membership':'#3f51b5',
    'affiliation':'#e91e63','leadership':'#8e44ad','collaboration':'#1abc9c',
    'person-affiliation':'#ffab40'
  };
  const DEC = '#90a4ae';

  /* ═══════════════════════════════════════════════════════
   *  SEVERITY / PROXIMITY TIER CLASSIFICATION
   *  Each person is classified into ONE tier based on role
   * ═══════════════════════════════════════════════════════ */
  const TIERS = [
    { id:'inner-circle', name:'Inner Circle', icon:'\uf06d', color:'#c62828', cls:'tier-inner-circle',
      desc:'Co-conspirators, recruiters, staff, pilots, handlers',
      keywords:['procurer','recruiter','scheduler','assistant','handler','pilot','butler','housekeeper','property manager','mc2','modeling agent','inner circle','npa','estate co-executor','financial manager','estate','longtime lawyer','executor','staff','bodyguard','chauffeur','secretary','valet','chef','maid'] },
    { id:'victims', name:'Victims & Accusers', icon:'\uf4be', color:'#e65100', cls:'tier-victims',
      desc:'Survivors, accusers, Jane Does',
      keywords:['victim','accuser','survivor','jane doe','abuse','trafficking','minor','molest','assault'] },
    { id:'close-assoc', name:'Close Associates', icon:'\uf500', color:'#ad1457', cls:'tier-close-assoc',
      desc:'Close friends, girlfriends, financial backers, frequent visitors',
      keywords:['business partner','girlfriend','client','close friend','frequent','financier','patron','primary','co-founder','funder','major donor','foundation','duke','prince','princess','royal','backup executor','biotech investor','apollo','barclays','jpmorgan','jp morgan','highbridge','deutsche bank','bear stearns','goldman'] },
    { id:'political', name:'Politicians & Government', icon:'\uf19c', color:'#283593', cls:'tier-political',
      desc:'Presidents, governors, diplomats, officials',
      keywords:['president','governor','senator','secretary','ag ','attorney general','pm','prime minister','politician','congressional','vice president','vp','mayor','ambassador','diplomat','cabinet','minister','aide','advisor','usvi','white house'] },
    { id:'legal', name:'Legal & Law Enforcement', icon:'\uf0e3', color:'#4e342e', cls:'tier-legal',
      desc:'Lawyers, prosecutors, judges, police, investigators',
      keywords:['attorney','lawyer','judge','detective','police','ausa','us attorney','state attorney','prosecutor','federal','guard','mcc','corrections','fbi','doj','sdny','palm beach','investigat','law enforce','legal'] },
    { id:'science', name:'Scientists & Academics', icon:'\uf19d', color:'#00695c', cls:'tier-science',
      desc:'Professors, researchers, university affiliates',
      keywords:['professor','harvard','mit','physicist','geneticist','scientist','computer scientist','biologist','neurologist','ai pioneer','mathematician','astronomer','virologist','evolutionary','chemist','university','academic','researcher','edge foundation','college','scholar'] },
    { id:'media', name:'Media & Journalism', icon:'\uf1ea', color:'#c2185b', cls:'tier-media',
      desc:'Journalists, TV anchors, news executives',
      keywords:['journalist','anchor','tv ','cbs','nbc','abc','reporter','herald','editor','news','media','columnist','correspondent','publisher','writer','author'] },
    { id:'entertainment', name:'Entertainment & Celebrity', icon:'\uf008', color:'#6a1b9a', cls:'tier-social',
      desc:'Actors, musicians, models, socialites, sports figures',
      keywords:['actor','actress','director','producer','filmmaker','singer','comedian','musician','supermodel','model','fashion','socialite','celebrity','tennis','magician','artist','entertainer','designer','photographer','chef'] },
    { id:'business', name:'Business & Finance', icon:'\uf201', color:'#1565c0', cls:'tier-business',
      desc:'CEOs, hedge fund managers, billionaires, bankers',
      keywords:['ceo','hedge fund','billionaire','real estate','investor','banker','managing director','co-founder','founder','chairman','executive','vp ','svp','cfo','coo','cto','venture','private equity','wall street','trader','analyst','wealth','consul'] },
    { id:'other', name:'Other Connections', icon:'\uf0c0', color:'#616161', cls:'tier-other',
      desc:'Other associated individuals',
      keywords:[] }
  ];

  const TIER_COLORS = {};
  TIERS.forEach(t => { TIER_COLORS[t.id] = t.color; });

  function classifyPerson(role) {
    if (!role) return 'other';
    const r = role.toLowerCase();
    for (const tier of TIERS) {
      if (tier.id === 'other') continue;
      for (const kw of tier.keywords) {
        if (r.indexOf(kw) !== -1) return tier.id;
      }
    }
    return 'other';
  }

  // ─── Parse URL ───────────────────────────────────────
  const ID_ALIASES = { 'jeffrey-epstein-network': 'epstein-network' };
  const params = new URLSearchParams(window.location.search);
  let focusEntryId = params.get('id') || 'epstein-network';
  if (ID_ALIASES[focusEntryId]) {
    focusEntryId = ID_ALIASES[focusEntryId];
    const nu = new URL(window.location);
    nu.searchParams.set('id', focusEntryId);
    window.history.replaceState({}, '', nu);
  }
  document.getElementById('btn-entry-top').href = 'entry.html?religion=jewish&id=' + encodeURIComponent(focusEntryId);
  document.getElementById('btn-entry').onclick = () => {
    window.location.href = 'entry.html?religion=jewish&id=' + encodeURIComponent(focusEntryId);
  };

  // ─── Tree state ──────────────────────────────────────
  const NW = 220, NH = 40, RIGHT_GAP = 290, LEFT_GAP = 290, SIB_GAP = 48;
  let rightRoot = null, leftRoot = null;
  let rawApiData = null;
  let searchHits = new Set();
  let allVisibleIds = new Set();

  // ─── Tooltip ─────────────────────────────────────────
  const tipEl = document.getElementById('tip');
  let lastMX = 0, lastMY = 0;
  document.addEventListener('mousemove', e => { lastMX = e.clientX; lastMY = e.clientY; });
  function showTip(h) {
    tipEl.innerHTML = h; tipEl.style.display = 'block';
    tipEl.style.left = Math.min(lastMX + 15, window.innerWidth - 360) + 'px';
    tipEl.style.top = Math.min(lastMY - 10, window.innerHeight - 120) + 'px';
  }
  function hideTip() { tipEl.style.display = 'none'; }

  // ─── SVG setup ───────────────────────────────────────
  const svgEl = d3.select('#tree-svg');
  const gMain = svgEl.append('g').attr('class', 'main-group');
  const gLinks = gMain.append('g').attr('class', 'links-group');
  const gNodes = gMain.append('g').attr('class', 'nodes-group');
  // Root node drawn separately on top
  const gRoot = gMain.append('g').attr('class', 'root-group');

  const zoomBehavior = d3.zoom()
    .scaleExtent([0.05, 4])
    .on('zoom', event => { gMain.attr('transform', event.transform); });
  svgEl.call(zoomBehavior);

  /* ═══════════════════════════════════════════════════════
   *  BUILD DUAL TREE from API data
   *  Left tree: people (d.y is negated → grows leftward)
   *  Right tree: organizations (grows rightward)
   * ═══════════════════════════════════════════════════════ */
  function buildTrees(apiData, rootId) {
    const nodeMap = {};
    apiData.nodes.forEach(n => { nodeMap[n.id] = n; });
    const rootNode = nodeMap[rootId];
    if (!rootNode) return;

    // Separate people vs entries
    const entryKids = [], personsByTier = {};
    const seenChild = new Set();
    TIERS.forEach(t => { personsByTier[t.id] = []; });

    apiData.links.forEach(link => {
      let cid = link.source === rootId ? link.target : (link.target === rootId ? link.source : null);
      if (!cid || cid === rootId || seenChild.has(cid)) return;
      seenChild.add(cid);
      const cn = nodeMap[cid];
      if (!cn) return;

      const childBase = {
        id: cn.id, name: cn.name, category: cn.category || '',
        country: cn.country || '', nodeType: cn.nodeType,
        type: cn.type || '', role: cn.role || '', personId: cn.personId || '',
        isFocus: false, _edgeType: link.type || 'related', _edgeDesc: link.description || '',
        children: [], _loaded: false, _collapsed: true, _connCount: 0
      };

      if (cn.nodeType === 'person') {
        const tier = classifyPerson(cn.role || cn.roleTag || '');
        childBase._tier = tier;
        personsByTier[tier].push(childBase);
      } else {
        childBase._connCount = (apiData.linkCount && apiData.linkCount[cn.id]) || 0;
        entryKids.push(childBase);
      }
    });

    entryKids.sort((a, b) => a.name.localeCompare(b.name));

    // Build RIGHT tree (organizations)
    rightRoot = {
      id: rootId, name: rootNode.name, category: rootNode.category || '',
      country: rootNode.country || '', nodeType: 'entry',
      type: rootNode.type || '', role: '', personId: '', isFocus: true,
      _edgeType: 'root', _edgeDesc: '',
      children: entryKids, _loaded: true, _collapsed: false,
      _connCount: (apiData.linkCount && apiData.linkCount[rootId]) || 0,
      _side: 'right'
    };

    // Build LEFT tree (people by tier)
    const tierGroups = [];
    TIERS.forEach(t => {
      const ppl = personsByTier[t.id];
      if (ppl.length === 0) return;
      ppl.sort((a, b) => a.name.localeCompare(b.name));
      tierGroups.push({
        id: '_tier_' + t.id, name: t.name + ' (' + ppl.length + ')',
        category: 'People', nodeType: 'tier-group', _tierDef: t,
        country: '', type: '', role: '', personId: '', isFocus: false,
        _edgeType: 'person-affiliation', _edgeDesc: t.desc,
        children: ppl, _loaded: true, _collapsed: true,
        _connCount: ppl.length, _side: 'left'
      });
    });

    leftRoot = {
      id: rootId + '_left', name: rootNode.name, category: rootNode.category || '',
      country: rootNode.country || '', nodeType: 'mirror',
      type: '', role: '', personId: '', isFocus: true,
      _edgeType: 'root', _edgeDesc: '',
      children: tierGroups, _loaded: true, _collapsed: false,
      _connCount: 0, _side: 'left'
    };
  }

  /* ═══════════════════════════════════════════════════════
   *  RENDER BOTH TREES
   * ═══════════════════════════════════════════════════════ */
  // Store previous node positions for smooth animation
  let _prevPositions = {};

  function renderTree() {
    if (!rightRoot || !leftRoot) return;

    allVisibleIds = new Set();
    collectIds(rightRoot, allVisibleIds);
    collectIds(leftRoot, allVisibleIds);

    // Filter function for children - respects _hidden flag
    function getVisibleChildren(d) {
      if (d._collapsed) return null;
      if (!d.children) return null;
      return d.children.filter(c => !c._hidden);
    }

    // --- Right tree (organizations -> right) ---------
    const rHier = d3.hierarchy(rightRoot, getVisibleChildren);
    d3.tree().nodeSize([SIB_GAP, RIGHT_GAP])(rHier);
    const rNodes = rHier.descendants().slice(1); // skip root
    const rLinks = rHier.links().filter(l => l.source.data.id !== rightRoot.id || l.target.data.id !== rightRoot.id + '_left');

    // ─── Left tree (people -> left) ──────────────────
    const lHier = d3.hierarchy(leftRoot, getVisibleChildren);
    d3.tree().nodeSize([SIB_GAP, LEFT_GAP])(lHier);
    const lNodes = lHier.descendants().slice(1); // skip mirror root
    const lLinks = lHier.links().filter(l => l.source.data.id !== leftRoot.id || l.target.data.id !== leftRoot.id);
    // Mirror: negate y for left side
    lNodes.forEach(d => { d.y = -d.y; });

    const allNodes = [...rNodes, ...lNodes];
    const allLinks = [...rLinks.filter(l => l.source !== rHier), ...lLinks.filter(l => l.source !== lHier)];

    // Build a map of parent positions for entering nodes
    const parentPos = {};
    function mapParent(hier) {
      if (!hier.children) return;
      hier.children.forEach(c => {
        parentPos[c.data.id] = { y: hier === rHier || hier === lHier ? 0 : (hier.data.id === leftRoot.id ? 0 : hier.y), x: hier === rHier || hier === lHier ? 0 : hier.x };
        mapParent(c);
      });
    }
    mapParent(rHier);
    lHier.descendants().forEach(d => { if (d.parent) parentPos[d.data.id] = { y: d.parent === lHier ? 0 : -d.parent.y, x: d.parent === lHier ? 0 : d.parent.x }; });

    // Links from root to first-level children
    const rootLinks = [];
    rHier.children && rHier.children.forEach(c => { rootLinks.push({ sx: 0, sy: 0, tx: c.y, ty: c.x, data: c.data }); });
    lHier.children && lHier.children.forEach(c => { rootLinks.push({ sx: 0, sy: 0, tx: -c.y, ty: c.x, data: c.data }); });

    // ─── Draw links ─────────────────────────────────
    const linkData = [];
    allLinks.forEach(l => {
      const isLeft = l.source.y < 0 || l.target.y < 0;
      linkData.push({
        key: l.source.data.id + '|' + l.target.data.id,
        sx: l.source.y + (isLeft ? -NW/2 : NW/2), sy: l.source.x,
        tx: l.target.y + (isLeft ? NW/2 : -NW/2), ty: l.target.x,
        color: getEdgeColor(l.target.data)
      });
    });
    rootLinks.forEach(rl => {
      const isLeft = rl.tx < 0;
      linkData.push({
        key: 'root|' + rl.data.id,
        sx: isLeft ? -NW/2 - 10 : NW/2 + 10, sy: 0,
        tx: rl.tx + (isLeft ? NW/2 : -NW/2), ty: rl.ty,
        color: getEdgeColor(rl.data)
      });
    });

    const TD = 180; // transition duration - fast for seamless feel

    const linkSel = gLinks.selectAll('.tree-link').data(linkData, d => d.key);
    linkSel.exit().transition().duration(200).attr('opacity', 0).remove();
    const linkEnter = linkSel.enter().append('path').attr('class', 'tree-link').attr('opacity', 0);
    linkSel.merge(linkEnter).transition().duration(TD)
      .attr('opacity', 0.45)
      .attr('stroke', d => d.color)
      .attr('d', d => {
        const mx = (d.sx + d.tx) / 2;
        return 'M' + d.sx + ',' + d.sy + ' C' + mx + ',' + d.sy + ' ' + mx + ',' + d.ty + ' ' + d.tx + ',' + d.ty;
      });

    // ─── Draw nodes ─────────────────────────────────
    const nodeSel = gNodes.selectAll('.tree-node').data(allNodes, d => d.data.id);
    nodeSel.exit().transition().duration(200).attr('opacity', 0).remove();

    const nodeEnter = nodeSel.enter().append('g').attr('class', d => {
      let cls = 'tree-node';
      if (d.data._tierDef) cls += ' ' + d.data._tierDef.cls;
      else if (d.data._tier) {
        const t = TIERS.find(tt => tt.id === d.data._tier);
        if (t) cls += ' ' + t.cls;
      }
      return cls;
    }).attr('opacity', 0).attr('transform', d => {
      // New nodes start at their parent's position for smooth animation
      const pp = parentPos[d.data.id] || _prevPositions[d.data.id] || { y: d.y, x: d.x };
      return 'translate(' + pp.y + ',' + pp.x + ')';
    });

    // Background
    nodeEnter.append('rect').attr('class', 'node-bg')
      .attr('width', NW).attr('height', NH).attr('x', -NW/2).attr('y', -NH/2)
      .attr('rx', 8).attr('ry', 8);
    // Category bar
    nodeEnter.append('rect').attr('class', 'node-cat-bar')
      .attr('width', 4).attr('height', NH - 6).attr('x', -NW/2 + 3).attr('y', -NH/2 + 3).attr('rx', 2);
    // Icon
    nodeEnter.append('text').attr('class', 'node-icon')
      .attr('x', -NW/2 + 16).attr('y', 1).attr('text-anchor', 'middle')
      .attr('font-family', '"Font Awesome 6 Free"').attr('font-weight', 900).attr('font-size', '10px');
    // Name
    nodeEnter.append('text').attr('class', 'node-name').attr('x', -NW/2 + 26).attr('y', -4);
    // Info
    nodeEnter.append('text').attr('class', 'node-info').attr('x', -NW/2 + 26).attr('y', 10);
    // Toggle
    nodeEnter.append('text').attr('class', 'node-toggle').attr('x', NW/2 - 14).attr('y', 5).attr('text-anchor', 'middle');
    // Count badge
    nodeEnter.append('text').attr('class', 'node-conns').attr('x', NW/2 - 30).attr('y', 5).attr('text-anchor', 'end');

    // Events
    nodeEnter
      .on('click', (ev, d) => { ev.stopPropagation(); handleNodeClick(d); })
      .on('contextmenu', (ev, d) => { ev.preventDefault(); navigateTo(d.data); })
      .on('mouseenter', (ev, d) => showNodeTip(d.data))
      .on('mouseleave', () => hideTip());

    // Update all
    const nodeAll = nodeSel.merge(nodeEnter);
    nodeAll.transition().duration(TD).attr('opacity', 1)
      .attr('transform', d => 'translate(' + d.y + ',' + d.x + ')');

    // Save positions for next render
    _prevPositions = {};
    allNodes.forEach(d => { _prevPositions[d.data.id] = { y: d.y, x: d.x }; });

    // Update class for tiers on merge
    nodeAll.attr('class', d => {
      let cls = 'tree-node';
      if (d.data._tierDef) cls += ' ' + d.data._tierDef.cls;
      else if (d.data._tier) { const t = TIERS.find(tt => tt.id === d.data._tier); if (t) cls += ' ' + t.cls; }
      if (searchHits.has(d.data.id)) cls += ' search-hit';
      return cls;
    });

    // BG color for non-tier nodes
    nodeAll.select('.node-bg').each(function(d) {
      const el = d3.select(this);
      if (!d.data._tierDef && !d.data._tier) {
        el.attr('fill', d.data.isFocus ? '#fff3f3' : '#ffffff')
          .attr('stroke', d.data.isFocus ? '#c62828' : CC[d.data.category] || DC)
          .attr('stroke-width', d.data.isFocus ? 2.5 : 1.5)
          .attr('stroke-dasharray', null);
      } else {
        el.attr('stroke-width', 1.5).attr('stroke-dasharray', null);
      }
    });
    // Cat bar for non-tier
    nodeAll.select('.node-cat-bar').each(function(d) {
      const el = d3.select(this);
      if (!d.data._tierDef && !d.data._tier) {
        el.attr('fill', d.data.isFocus ? '#c62828' : CC[d.data.category] || DC);
      }
    });
    // Icon
    nodeAll.select('.node-icon')
      .text(d => {
        if (d.data.nodeType === 'tier-group') return d.data._tierDef.icon;
        if (d.data.nodeType === 'person') return '\uf007';
        if (d.data.isFocus) return '\uf005';
        return '\uf1ad';
      })
      .attr('fill', d => {
        if (d.data._tierDef) return d.data._tierDef.color;
        if (d.data._tier) return TIER_COLORS[d.data._tier] || DC;
        if (d.data.isFocus) return '#c62828';
        return CC[d.data.category] || DC;
      });
    // Name
    nodeAll.select('.node-name')
      .text(d => { const n = d.data.name || d.data.id; return n.length > 22 ? n.substring(0, 20) + '\u2026' : n; })
      .attr('font-weight', d => (d.data.isFocus || d.data.nodeType === 'tier-group') ? 'bold' : 'normal');
    // Info
    nodeAll.select('.node-info').text(d => {
      if (d.data.nodeType === 'tier-group') return d.data._tierDef.desc.substring(0, 34);
      if (d.data.nodeType === 'person') return (d.data.role || 'Individual').substring(0, 30);
      const p = []; if (d.data.category) p.push(d.data.category); if (d.data.country) p.push(d.data.country);
      const txt = p.join(' \xB7 '); return txt.length > 30 ? txt.substring(0, 28) + '\u2026' : txt;
    });
    // Toggle
    nodeAll.select('.node-toggle').text(d => {
      if (d.data.nodeType === 'person' && (!d.data.children || d.data.children.length === 0)) return '';
      if (!d.data._loaded && d.data.nodeType !== 'tier-group') return '\u22EF';
      if (d.data._collapsed) return '+';
      if (d.data.children && d.data.children.length > 0) return '\u2212';
      return '';
    });
    // Count badge
    nodeAll.select('.node-conns').text(d => {
      if (d.data._connCount > 0) return d.data._connCount;
      return '';
    });

    // ─── Root node (center) ─────────────────────────
    drawRootNode();
    updateStats();
  }

  function drawRootNode() {
    gRoot.selectAll('*').remove();
    if (!rightRoot) return;
    const g = gRoot.append('g').attr('class', 'tree-node root-node');
    const rw = NW + 20, rh = NH + 14;
    g.append('rect').attr('class', 'node-bg')
      .attr('width', rw).attr('height', rh).attr('x', -rw/2).attr('y', -rh/2)
      .attr('rx', 10).attr('ry', 10)
      .attr('fill', '#fff3f3').attr('stroke', '#c62828').attr('stroke-width', 2.5);
    g.append('rect').attr('width', 5).attr('height', rh - 8).attr('x', -rw/2 + 4).attr('y', -rh/2 + 4)
      .attr('rx', 2).attr('fill', '#c62828');
    g.append('text').attr('x', -rw/2 + 20).attr('y', -5)
      .attr('font-family', '"Font Awesome 6 Free"').attr('font-weight', 900).attr('font-size', '13px')
      .attr('fill', '#c62828').text('\uf005');
    g.append('text').attr('x', -rw/2 + 36).attr('y', -4)
      .attr('font-size', '13px').attr('font-weight', 'bold').attr('fill', '#c62828')
      .text(rightRoot.name.length > 22 ? rightRoot.name.substring(0, 20) + '\u2026' : rightRoot.name);
    g.append('text').attr('x', -rw/2 + 36).attr('y', 13)
      .attr('font-size', '10px').attr('fill', '#888')
      .text((rightRoot.category || '') + (rightRoot.country ? ' \xB7 ' + rightRoot.country : ''));

    // Root labels
    g.append('text').attr('x', rw/2 + 16).attr('y', 4)
      .attr('font-size', '10px').attr('fill', '#0056b3').attr('font-weight', 600)
      .text('Organizations \u2192');
    g.append('text').attr('x', -rw/2 - 16).attr('y', 4).attr('text-anchor', 'end')
      .attr('font-size', '10px').attr('fill', '#ad1457').attr('font-weight', 600)
      .text('\u2190 People');

    g.on('click', () => { window.location.href = 'entry.html?religion=jewish&id=' + encodeURIComponent(focusEntryId); })
      .on('mouseenter', () => showTip('<strong><i class="fa-solid fa-star"></i> ' + rightRoot.name + '</strong><br/><i class="fa-solid fa-building"></i> ' + (rightRoot.type || '') + '<br/><i class="fa-solid fa-globe"></i> ' + (rightRoot.country || '') + '<br/><span style="color:#0056b3;font-size:0.85em">Click to view entry details</span>'))
      .on('mouseleave', () => hideTip())
      .style('cursor', 'pointer');
  }

  function getEdgeColor(d) {
    if (d._tierDef) return d._tierDef.color;
    if (d._tier) return TIER_COLORS[d._tier] || DEC;
    return EC[d._edgeType] || CC[d.category] || DEC;
  }

  function collectIds(node, set) {
    if (!node) return; set.add(node.id);
    if (!node._collapsed && node.children) node.children.forEach(c => collectIds(c, set));
  }

  /* ═══════════════════════════════════════════════════════
   *  NODE CLICK  -  expand/collapse or lazy-load
   * ═══════════════════════════════════════════════════════ */
  async function handleNodeClick(d) {
    const nd = d.data;

    // Person leaf → navigate to profile
    if (nd.nodeType === 'person') {
      window.location.href = 'person.html?id=' + encodeURIComponent(nd.personId || nd.id);
      return;
    }

    // Toggle
    if (!nd._collapsed) { nd._collapsed = true; renderTree(); return; }

    // If not loaded yet, fetch from API (seamless - no overlay)
    if (!nd._loaded && nd.nodeType !== 'tier-group') {
      // Pulse the node to show it's loading
      const nodeEl = gNodes.selectAll('.tree-node').filter(n => n.data.id === nd.id);
      nodeEl.classed('node-loading', true);
      try {
        const showPeople = document.getElementById('show-people').checked;
        const res = await fetch('/api/graph/focus/' + encodeURIComponent(nd.id) + '?depth=1&people=' + (showPeople ? '1' : '0'));
        const data = await res.json();
        if (!data.nodes || data.nodes.length === 0) { nd._loaded = true; nd.children = []; nd._collapsed = false; nodeEl.classed('node-loading', false); renderTree(); return; }
        const nm = {}; data.nodes.forEach(n => { nm[n.id] = n; });
        const eKids = [], pKids = [];
        const seen = new Set();
        const visIds = new Set();
        collectIds(rightRoot, visIds);
        collectIds(leftRoot, visIds);
        data.links.forEach(link => {
          let cid = link.source === nd.id ? link.target : (link.target === nd.id ? link.source : null);
          if (!cid || cid === nd.id || seen.has(cid)) return;
          if (visIds.has(cid)) return;
          seen.add(cid);
          const cn = nm[cid]; if (!cn) return;
          const child = { id: cn.id, name: cn.name, category: cn.category || '', country: cn.country || '', nodeType: cn.nodeType, type: cn.type || '', role: cn.role || '', personId: cn.personId || '', isFocus: false, _edgeType: link.type || 'related', _edgeDesc: link.description || '', children: [], _loaded: false, _collapsed: true, _connCount: (data.linkCount && data.linkCount[cn.id]) || 0, description: cn.description || '' };
          if (cn.nodeType === 'person') { child._tier = classifyPerson(cn.role || ''); pKids.push(child); }
          else eKids.push(child);
        });
        eKids.sort((a, b) => a.name.localeCompare(b.name));
        const newChildren = [...eKids];
        if (pKids.length > 0) {
          const byTier = {};
          pKids.forEach(p => { const t = p._tier || 'other'; if (!byTier[t]) byTier[t] = []; byTier[t].push(p); });
          TIERS.forEach(t => {
            if (!byTier[t.id] || byTier[t.id].length === 0) return;
            byTier[t.id].sort((a, b) => a.name.localeCompare(b.name));
            newChildren.push({ id: nd.id + '_tier_' + t.id, name: t.name + ' (' + byTier[t.id].length + ')', category: 'People', nodeType: 'tier-group', _tierDef: t, country: '', type: '', role: '', personId: '', isFocus: false, _edgeType: 'person-affiliation', _edgeDesc: t.desc, children: byTier[t.id], _loaded: true, _collapsed: true, _connCount: byTier[t.id].length });
          });
        }
        nd.children = newChildren;
        nd._loaded = true;
      } catch (err) { console.error(err); nd._loaded = true; nd.children = []; }
      nodeEl.classed('node-loading', false);
    }
    nd._collapsed = false;
    renderTree(); // no fitTree - keep zoom stable
  }

  function navigateTo(nd) {
    if (nd.nodeType === 'person') window.location.href = 'person.html?id=' + encodeURIComponent(nd.personId || nd.id);
    else if (nd.nodeType === 'tier-group' || nd.nodeType === 'mirror') return;
    else window.location.href = 'entry.html?religion=jewish&id=' + encodeURIComponent(nd.id);
  }

  function showNodeTip(nd) {
    let h;
    if (nd.nodeType === 'tier-group') {
      h = '<strong><i class="fa-solid fa-layer-group"></i> ' + nd.name + '</strong><br/>' + nd._tierDef.desc + '<br/><span style="color:#0056b3;font-size:0.85em">Click to expand</span>';
    } else if (nd.nodeType === 'person') {
      h = '<strong><i class="fa-solid fa-user"></i> ' + nd.name + '</strong><br/><i class="fa-solid fa-briefcase"></i> ' + (nd.role || 'Individual') + '<br/><i class="fa-solid fa-globe"></i> ' + (nd.country || '') + '<br/><span style="color:#0056b3;font-size:0.85em">Click → profile &middot; Right-click → details</span>';
    } else {
      h = '<strong>' + nd.name + '</strong><br/><i class="fa-solid fa-building"></i> ' + (nd.type || '') + '<br/><i class="fa-solid fa-globe"></i> ' + (nd.country || '') + '<br/><span class="tip-cat" style="background:' + (CC[nd.category] || DC) + '30;color:' + (CC[nd.category] || DC) + '">' + (nd.category || '') + '</span><br/><span style="color:#0056b3;font-size:0.85em">Click to expand &middot; Right-click → details</span>';
    }
    showTip(h);
  }

  // ─── Stats ───────────────────────────────────────────
  function updateStats() {
    let entries = 0, people = 0;
    allVisibleIds.forEach(id => {
      if (id.startsWith('person-')) { people++; return; }
      if (id.startsWith('_tier_') || id.includes('_tier_') || id.includes('_left')) return;
      entries++;
    });
    // Also count people in collapsed tiers
    function countPeople(n) {
      if (!n) return 0;
      let c = 0;
      if (n.nodeType === 'person') c++;
      if (n.children) n.children.forEach(ch => { c += countPeople(ch); });
      return c;
    }
    const totalPeopleInTree = countPeople(leftRoot);
    const parts = ['<b>' + entries + '</b> entries'];
    parts.push('<b>' + people + '</b> of <b>' + totalPeopleInTree + '</b> people visible');
    document.getElementById('stats').innerHTML = parts.join(' &middot; ');
  }

  // ─── Fit ─────────────────────────────────────────────
  function fitTree() {
    const bounds = gMain.node().getBBox();
    if (!bounds.width || !bounds.height) return;
    const svg = svgEl.node();
    const w = svg.clientWidth, h = svg.clientHeight, pad = 60;
    const sx = (w - pad * 2) / bounds.width;
    const sy = (h - pad * 2) / bounds.height;
    const s = Math.min(sx, sy, 1.5);
    const tx = w / 2 - (bounds.x + bounds.width / 2) * s;
    const ty = h / 2 - (bounds.y + bounds.height / 2) * s;
    svgEl.transition().duration(600).call(zoomBehavior.transform, d3.zoomIdentity.translate(tx, ty).scale(s));
  }

  // ─── Legend ──────────────────────────────────────────
  function buildLegend() {
    const legB = document.getElementById('leg-b');
    legB.innerHTML = '';
    const tierSel = document.getElementById('tier-filter');
    tierSel.innerHTML = '<option value="all">All Tiers</option>';
    TIERS.forEach(t => {
      const r = document.createElement('div'); r.className = 'li';
      const d = document.createElement('div'); d.className = 'ld'; d.style.background = t.color;
      r.appendChild(d);
      r.appendChild(document.createTextNode(t.name));
      legB.appendChild(r);
      const opt = document.createElement('option');
      opt.value = t.id; opt.textContent = t.name;
      tierSel.appendChild(opt);
    });
  }

  // ─── Shared batch-load helper ────────────────────────
  async function batchLoadNodes(nodesToLoad, showPeople) {
    for (let i = 0; i < nodesToLoad.length; i += 10) {
      const batch = nodesToLoad.slice(i, i + 10);
      document.getElementById('ld-text').textContent = 'Loading ' + Math.min(i + 10, nodesToLoad.length) + ' of ' + nodesToLoad.length + ' nodes...';
      await Promise.all(batch.map(async nd => {
        try {
          const res = await fetch('/api/graph/focus/' + encodeURIComponent(nd.id) + '?depth=1&people=' + (showPeople ? '1' : '0'));
          const data = await res.json();
          if (!data.nodes || data.nodes.length === 0) { nd._loaded = true; nd.children = []; return; }
          const nm = {}; data.nodes.forEach(n => { nm[n.id] = n; });
          const eKids = [], pKids = [];
          const seen = new Set();
          const visIds = new Set();
          collectIds(rightRoot, visIds);
          collectIds(leftRoot, visIds);
          data.links.forEach(link => {
            let cid = link.source === nd.id ? link.target : (link.target === nd.id ? link.source : null);
            if (!cid || cid === nd.id || seen.has(cid)) return;
            if (visIds.has(cid)) return;
            seen.add(cid);
            const cn = nm[cid]; if (!cn) return;
            const child = { id: cn.id, name: cn.name, category: cn.category || '', country: cn.country || '', nodeType: cn.nodeType, type: cn.type || '', role: cn.role || '', personId: cn.personId || '', isFocus: false, _edgeType: link.type || 'related', _edgeDesc: link.description || '', children: [], _loaded: false, _collapsed: true, _connCount: (data.linkCount && data.linkCount[cn.id]) || 0, description: cn.description || '' };
            if (cn.nodeType === 'person') { child._tier = classifyPerson(cn.role || ''); pKids.push(child); }
            else eKids.push(child);
          });
          eKids.sort((a, b) => a.name.localeCompare(b.name));
          const newChildren = [...eKids];
          if (pKids.length > 0) {
            const byTier = {};
            pKids.forEach(p => { const t = p._tier || 'other'; if (!byTier[t]) byTier[t] = []; byTier[t].push(p); });
            TIERS.forEach(t => {
              if (!byTier[t.id] || byTier[t.id].length === 0) return;
              byTier[t.id].sort((a, b) => a.name.localeCompare(b.name));
              newChildren.push({ id: nd.id + '_tier_' + t.id, name: t.name + ' (' + byTier[t.id].length + ')', category: 'People', nodeType: 'tier-group', _tierDef: t, country: '', type: '', role: '', personId: '', isFocus: false, _edgeType: 'person-affiliation', _edgeDesc: t.desc, children: byTier[t.id], _loaded: true, _collapsed: true, _connCount: byTier[t.id].length });
            });
          }
          nd.children = newChildren;
          nd._loaded = true;
        } catch (err) { console.error('Failed loading', nd.id, err); nd._loaded = true; nd.children = []; }
      }));
    }
  }

  // Collect unloaded entry nodes from a tree
  function collectUnloaded(n, list) {
    if (!n) return;
    if (!n._loaded && n.nodeType !== 'tier-group' && n.nodeType !== 'person' && n.nodeType !== 'mirror') list.push(n);
    if (n.children) n.children.forEach(c => collectUnloaded(c, list));
  }

  // ─── Expand / Collapse all ───────────────────────────
  function expandAll() {
    // Instantly expand all already-loaded nodes — no API calls, no overlay
    function ex(n) { if (!n) return; if (n._loaded && n._collapsed && n.children && n.children.length > 0) n._collapsed = false; if (!n._collapsed && n.children) n.children.forEach(ex); }
    ex(rightRoot); ex(leftRoot);
    renderTree(); setTimeout(fitTree, 350);
  }
  function collapseAll() {
    function cl(n) { if (!n || !n.children) return; n.children.forEach(c => { c._collapsed = true; cl(c); }); }
    cl(rightRoot); cl(leftRoot);
    renderTree(); setTimeout(fitTree, 600);
  }

  // ─── Search ──────────────────────────────────────────
  function doSearch() {
    const q = document.getElementById('s-input').value.trim().toLowerCase();
    searchHits = new Set();
    if (!q) { document.getElementById('s-count').textContent = ''; renderTree(); return; }
    function srch(n) { if (!n) return; if ((n.name || '').toLowerCase().indexOf(q) !== -1) searchHits.add(n.id); if (n.children) n.children.forEach(srch); }
    srch(rightRoot); srch(leftRoot);
    document.getElementById('s-count').textContent = searchHits.size ? searchHits.size + ' found' : 'none';
    renderTree();
  }

  // ─── Load from API ──────────────────────────────────
  async function loadTree() {
    const depth = document.getElementById('depth-range').value;
    const ppl = document.getElementById('show-people').checked;
    const url = '/api/graph/focus/' + encodeURIComponent(focusEntryId) + '?depth=' + depth + '&people=' + (ppl ? '1' : '0');
    document.getElementById('loading').classList.remove('off');
    document.getElementById('ld-text').textContent = 'Fetching network data...';
    document.getElementById('stats').innerHTML = '<b>Loading...</b>';

    try {
      const res = await fetch(url); rawApiData = await res.json();
      if (!rawApiData.nodes || rawApiData.nodes.length === 0) { document.getElementById('ld-text').textContent = 'No data found.'; return; }

      buildTrees(rawApiData, focusEntryId);
      if (!rightRoot) { document.getElementById('ld-text').textContent = 'Entry not found.'; return; }

      if (rawApiData.focusName) {
        setSEO({ title: rawApiData.focusName + ' Network - Juice Project', description: 'Network tree for ' + rawApiData.focusName });
        document.getElementById('page-title').innerHTML = '<span class="focus-name">' + rawApiData.focusName + '</span> Network';
      }
      const entryC = rawApiData.nodes.filter(n => n.nodeType === 'entry').length;
      const pC = rawApiData.nodes.filter(n => n.nodeType === 'person').length;
      const subParts = [entryC + ' entries'];
      subParts.push(pC + ' people');
      subParts.push('Depth ' + depth);
      document.getElementById('page-subtitle').textContent = subParts.join(' \xB7 ');
      if (rawApiData.totalPeople !== undefined) {
        document.getElementById('people-info').innerHTML = ppl
          ? 'Showing <b>' + pC + '</b> of <b>' + rawApiData.totalPeople + '</b> individuals (grouped by severity/proximity)'
          : '<b>' + rawApiData.totalPeople + '</b> people available - check "People" to show';
      }
      buildLegend();
      renderTree();
      setTimeout(() => { fitTree(); document.getElementById('loading').classList.add('off'); }, 150);
    } catch (err) {
      console.error(err);
      document.getElementById('ld-text').textContent = 'Error: ' + err.message;
    }
  }

  // ─── Controls ────────────────────────────────────────
  document.getElementById('depth-range').oninput = function() { document.getElementById('depth-val').textContent = this.value; };
  document.getElementById('depth-range').onchange = loadTree;
  document.getElementById('btn-reload').onclick = loadTree;
  document.getElementById('btn-fit').onclick = fitTree;
  document.getElementById('show-people').onchange = loadTree;
  document.getElementById('btn-expand-all').onclick = expandAll;
  document.getElementById('btn-collapse').onclick = collapseAll;
  document.getElementById('btn-expand-right').onclick = function() {
    // Instantly expand all loaded org nodes — no API calls
    function ex(n) { if (!n) return; if (n._loaded && n._collapsed && n.children && n.children.length > 0) n._collapsed = false; if (!n._collapsed && n.children) n.children.forEach(ex); }
    ex(rightRoot);
    renderTree(); setTimeout(fitTree, 350);
  };
  document.getElementById('btn-expand-left').onclick = function() {
    function ex(n) { if (!n) return; if (n._loaded && n._collapsed && n.children && n.children.length > 0) n._collapsed = false; if (!n._collapsed && n.children) n.children.forEach(ex); }
    ex(leftRoot); renderTree(); setTimeout(fitTree, 600);
  };
  document.getElementById('tier-filter').onchange = function() {
    const val = this.value;
    if (val === 'all') {
      if (leftRoot && leftRoot.children) leftRoot.children.forEach(tg => { tg._hidden = false; });
    } else {
      if (leftRoot && leftRoot.children) leftRoot.children.forEach(tg => {
        tg._hidden = tg._tierDef && tg._tierDef.id !== val ? true : false;
      });
    }
    renderTree(); setTimeout(fitTree, 400);
  };
  document.getElementById('node-size-range').oninput = function() {
    const pct = parseInt(this.value);
    document.getElementById('node-size-val').textContent = pct + '%';
    const scale = pct / 100;
    gNodes.selectAll('.tree-node').attr('transform', function(d) {
      return 'translate(' + d.y + ',' + d.x + ') scale(' + scale + ')';
    });
  };
  document.getElementById('link-opacity-range').oninput = function() {
    const val = parseInt(this.value);
    document.getElementById('link-opacity-val').textContent = val + '%';
    gLinks.selectAll('.tree-link').attr('opacity', val / 100);
  };

  document.getElementById('s-btn').onclick = doSearch;
  document.getElementById('s-input').onkeydown = function(e) { if (e.key === 'Enter') doSearch(); };
  document.getElementById('s-input').oninput = function() { if (!this.value.trim()) { searchHits = new Set(); document.getElementById('s-count').textContent = ''; renderTree(); } };

  // ─── Init ────────────────────────────────────────────
  loadTree();
  </script>
</body>
</html>
