<!-- Juice Project - Est. 2016 | Last updated 2026 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="created" content="2016-03-14">
  <meta name="author" content="Juice Project">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="The Juice Box">
  <meta property="og:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://thejuicebox.live/og-image.png">
  <meta property="og:title" content="Focused Network">
  <meta property="og:description" content="Interactive tree explorer - explore connections for any entity in The Juice Box database.">
  <meta property="og:url" content="https://thejuicebox.live/network.html">
  <meta name="twitter:title" content="Focused Network">
  <meta name="twitter:description" content="Interactive tree explorer - explore connections for any entity in The Juice Box database.">
  <title>Focused Network</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: #000; background: #fff; }
    nav { padding: 10px 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    nav ul { list-style: none; margin: 0; padding: 10px 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; }
    nav ul li { margin: 0; white-space: nowrap; }
    nav a { color: #0000EE !important; text-decoration: none; background: rgba(255,255,255,0.85); padding: 5px 12px; white-space: nowrap; border-radius: 6px; border: 1px solid rgba(0,0,255,0.3); box-shadow: 1px 1px 2px rgba(0,0,0,0.2); font-size: 0.82em; display: inline-block; line-height: 1.4; }
    nav select { padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(0,0,255,0.3); font-size: 0.85em; background: rgba(255,255,255,0.85); }
    .panel, .gp, .sb, .header-panel, .graph-wrap {
      background: rgba(255,255,255,0.15) !important; backdrop-filter: blur(12px) !important; -webkit-backdrop-filter: blur(12px) !important;
      border: 1px solid rgba(255,255,255,0.25) !important; border-radius: 12px !important; box-shadow: 0 8px 32px rgba(0,0,0,0.08) !important;
    }
    .gp:hover, .header-panel:hover { box-shadow: 0 8px 32px rgba(0,0,0,0.15) !important; border-color: rgba(255,255,255,0.35) !important; }
    nav a { background: rgba(255,255,255,0.2) !important; backdrop-filter: blur(8px) !important; -webkit-backdrop-filter: blur(8px) !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 8px !important; }
    nav select { background: rgba(255,255,255,0.2) !important; backdrop-filter: blur(8px) !important; -webkit-backdrop-filter: blur(8px) !important; border: 1px solid rgba(255,255,255,0.3) !important; }

    .main { max-width: 1600px; margin: 0 auto; padding: 15px 20px; }
    .header-panel { background: rgba(255,255,255,0.85); border: 1px solid rgba(0,0,255,0.2); border-radius: 8px; padding: 16px 20px; margin-bottom: 15px; }
    .header-panel h1 { margin: 0 0 4px 0; color: #0056b3; }
    .header-panel .focus-name { color: #c62828; font-weight: 800; }
    .header-panel .subtitle { color: #555; margin: 0; font-size: 0.95em; }
    .header-panel .back-links { margin-bottom: 6px; }
    .header-panel .back-links a { color: #0056b3; text-decoration: none; font-size: 0.85em; margin-right: 12px; }
    .header-panel .back-links a:hover { text-decoration: underline; }
    .people-info { font-size: 0.82em; color: #888; margin-top: 2px; }
    .people-info b { color: #0056b3; }

    .graph-wrap { position: relative; width: 100%; height: 85vh; min-height: 500px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(0,0,255,0.15); background: #f8f9fa; }
    #tree-svg { width: 100%; height: 100%; }

    .gp { overflow: hidden; transition: box-shadow 0.25s; }
    .gp-h { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; cursor: pointer; user-select: none; background: rgba(0,86,179,0.06); border-bottom: 1px solid rgba(0,0,255,0.08); transition: background 0.2s; }
    .gp-h:hover { background: rgba(0,86,179,0.12); }
    .gp-h strong, .gp-h h3 { color: #0056b3; font-size: 0.78em; font-weight: 600; margin: 0; }
    .gp-h .chv { color: #0056b3; font-size: 0.6em; transition: transform 0.25s; }
    .gp.shut .gp-b { display: none; }
    .gp.shut .gp-h { border-bottom: none; }
    .gp.shut .chv { transform: rotate(180deg); }

    .hud-ctrl { position: absolute; top: 10px; left: 10px; z-index: 12; width: 215px; }
    .cb { padding: 7px 10px 9px; }
    .cb label { font-size: 0.73em; color: #333; display: block; margin: 4px 0 1px; font-weight: 500; }
    .cb select { width: 100%; padding: 4px 6px; border-radius: 5px; border: 1px solid rgba(0,0,255,0.16); background: rgba(255,255,255,0.85); color: #333; font-size: 0.77em; outline: none; }
    .cb select:focus { border-color: #0056b3; }
    .cb input[type="range"] { width: 100%; margin: 2px 0; accent-color: #0056b3; }
    .cb .chks { display: flex; gap: 10px; margin: 5px 0 2px; }
    .cb .chks label { display: flex; align-items: center; gap: 3px; font-size: 0.73em; color: #333; cursor: pointer; margin: 0; }
    .cb .chks input[type="checkbox"] { accent-color: #0056b3; }
    .cb .btns { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
    .cb .btns button { flex: 1; padding: 4px 0; border-radius: 5px; border: 1px solid rgba(0,0,255,0.16); background: rgba(0,86,179,0.08); color: #0056b3; font-size: 0.73em; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 55px; }
    .cb .btns button:hover { background: rgba(0,86,179,0.18); }
    .cb .depth-row { display: flex; align-items: center; gap: 6px; }
    .cb .depth-row input { flex: 1; }
    .cb .depth-row span { font-size: 0.77em; color: #0056b3; font-weight: 700; min-width: 12px; text-align: center; }

    .hud-search { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 12; display: flex; align-items: center; }
    .hud-search input { padding: 5px 11px; border: 1px solid rgba(0,0,255,0.2); border-radius: 6px 0 0 6px; font-size: 0.77em; width: 200px; outline: none; background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); color: #333; }
    .hud-search input::placeholder { color: #888; }
    .hud-search input:focus { border-color: #0056b3; }
    .hud-search button { padding: 5px 9px; border: 1px solid rgba(0,0,255,0.2); border-left: none; border-radius: 0 6px 6px 0; background: rgba(0,86,179,0.1); color: #0056b3; cursor: pointer; font-size: 0.77em; transition: background 0.2s; }
    .hud-search button:hover { background: rgba(0,86,179,0.2); }
    .hud-search .sc { padding: 0 7px; font-size: 0.71em; color: #0056b3; white-space: nowrap; text-shadow: 0 0 4px rgba(255,255,255,0.9); }

    .hud-stats { position: absolute; top: 10px; right: 10px; z-index: 12; }
    .sb { padding: 5px 11px; font-size: 0.74em; color: #333; white-space: nowrap; }
    .sb b { color: #0056b3; font-weight: 700; }

    .hud-legend { position: absolute; bottom: 10px; left: 10px; z-index: 12; width: 190px; }
    .cat-b { padding: 4px 10px 7px; max-height: 180px; overflow-y: auto; }
    .li { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #333; margin: 1px 0; cursor: pointer; padding: 1px 2px; border-radius: 3px; transition: background 0.15s; }
    .li:hover { background: rgba(0,86,179,0.08); }
    .ld { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    .hud-edge { position: absolute; bottom: 10px; right: 10px; z-index: 12; width: 172px; }
    .edge-b { padding: 3px 10px 7px; max-height: 210px; overflow-y: auto; }
    .ei { display: flex; align-items: center; gap: 5px; font-size: 0.69em; color: #333; margin: 1.5px 0; }
    .el { width: 15px; height: 3px; border-radius: 2px; flex-shrink: 0; }

    .cat-b::-webkit-scrollbar, .edge-b::-webkit-scrollbar { width: 4px; }
    .cat-b::-webkit-scrollbar-track, .edge-b::-webkit-scrollbar-track { background: transparent; }
    .cat-b::-webkit-scrollbar-thumb, .edge-b::-webkit-scrollbar-thumb { background: rgba(0,0,255,0.15); border-radius: 2px; }

    #tip {
      position: fixed; background: rgba(255,255,255,0.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      color: #222; padding: 10px 14px; border-radius: 9px; border: 1px solid rgba(0,0,255,0.15); font-size: 0.79em;
      pointer-events: none; z-index: 200; max-width: 340px; line-height: 1.55; display: none; box-shadow: 0 8px 28px rgba(0,0,0,0.12);
    }
    #tip strong { color: #0056b3; }
    #tip .tip-cat { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.85em; margin-top: 3px; }

    .ld-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 25; transition: opacity 0.5s; }
    .ld-overlay.off { opacity: 0; pointer-events: none; }
    .ld-spinner { width: 38px; height: 38px; border: 3px solid rgba(0,0,255,0.1); border-top-color: #0056b3; border-radius: 50%; animation: spin 0.75s linear infinite; }
    .ld-text { color: #0056b3; font-size: 0.82em; font-weight: 600; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ─── Tree-specific styles ───────────────────────── */
    .tree-link { fill: none; stroke-width: 1.8; opacity: 0.5; transition: opacity 0.2s, stroke-width 0.2s; }
    .tree-link:hover { opacity: 0.9; stroke-width: 2.5; }
    .tree-link-label { font-size: 9px; fill: #999; pointer-events: none; }
    .tree-node { cursor: pointer; }
    .tree-node:hover .node-bg { filter: brightness(0.97); stroke-width: 2.2 !important; }
    .node-bg { transition: filter 0.15s, stroke-width 0.15s; }
    .node-cat-bar { pointer-events: none; }
    .node-name { font-size: 12px; fill: #222; pointer-events: none; }
    .node-info { font-size: 10px; fill: #888; pointer-events: none; }
    .node-toggle { font-size: 14px; font-weight: bold; fill: #0056b3; pointer-events: none; }
    .node-conns { font-size: 9px; fill: #aaa; pointer-events: none; }

    .tree-node.search-hit .node-bg { stroke: #ff6f00 !important; stroke-width: 2.5 !important; filter: drop-shadow(0 0 4px rgba(255,111,0,0.4)); }
    .tree-node.search-hit .node-name { fill: #e65100 !important; font-weight: bold; }

    @media (max-width: 900px) { .hud-search input { width: 135px; } .hud-ctrl { width: 180px; } .hud-legend { width: 160px; } .hud-edge { width: 148px; } }
    @media (max-width: 600px) { .hud-search { display: none; } .hud-ctrl { width: 160px; } .hud-legend, .hud-edge { width: 135px; } }
  </style>
</head>
<body>
  <nav id="navbar"></nav>

  <div class="main">
  <div class="header-panel">
    <div class="back-links">
      <a href="graph.html"><i class="fa-solid fa-diagram-project"></i> Full Graph</a>
      <a href="index.html"><i class="fa-solid fa-house"></i> Home</a>
      <a href="#" id="btn-entry-top"><i class="fa-solid fa-building"></i> View Entry</a>
    </div>
    <h1><i class="fa-solid fa-spider-web"></i> <span id="page-title">Focused Network</span></h1>
    <p class="subtitle" id="page-subtitle">Loading network data...</p>
    <p class="people-info" id="people-info"></p>
  </div>

  <div class="graph-wrap">
    <svg id="tree-svg"></svg>

    <div class="ld-overlay" id="loading">
      <div class="ld-spinner"></div>
      <div class="ld-text" id="ld-text">Loading network data...</div>
    </div>

    <div class="hud-ctrl">
      <div class="gp" id="ctrl-p">
        <div class="gp-h" id="ctrl-t">
          <h3><i class="fa-solid fa-sliders"></i> Controls</h3>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cb">
          <label>Depth</label>
          <div class="depth-row">
            <input type="range" id="depth-range" min="1" max="3" value="1" step="1">
            <span id="depth-val">1</span>
          </div>
          <div class="chks">
            <label><input type="checkbox" id="show-people" checked /> People</label>
          </div>
          <div class="btns">
            <button id="btn-reload"><i class="fa-solid fa-rotate"></i> Reload</button>
            <button id="btn-fit"><i class="fa-solid fa-compress"></i> Fit</button>
          </div>
          <div class="btns">
            <button id="btn-expand-all"><i class="fa-solid fa-expand"></i> Expand All</button>
            <button id="btn-collapse"><i class="fa-solid fa-compress-alt"></i> Collapse</button>
          </div>
          <div class="btns">
            <button id="btn-entry"><i class="fa-solid fa-building"></i> View Entry</button>
          </div>
        </div>
      </div>
    </div>

    <div class="hud-search">
      <input type="text" id="s-input" placeholder="Search nodes..." />
      <button id="s-btn"><i class="fa-solid fa-search"></i></button>
      <span class="sc" id="s-count"></span>
    </div>

    <div class="hud-stats">
      <div class="sb" id="stats"><b>Loading...</b></div>
    </div>

    <div class="hud-legend">
      <div class="gp" id="cat-p">
        <div class="gp-h" id="cat-t">
          <strong><i class="fa-solid fa-palette"></i> Categories</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b cat-b" id="cat-b"></div>
      </div>
    </div>

    <div class="hud-edge">
      <div class="gp" id="edge-p">
        <div class="gp-h" id="edge-t">
          <strong><i class="fa-solid fa-link"></i> Connections</strong>
          <span class="chv"><i class="fa-solid fa-chevron-up"></i></span>
        </div>
        <div class="gp-b edge-b" id="edge-b"></div>
      </div>
    </div>
  </div>
  </div>

  <div id="tip"></div>

  <script src="app.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
  /* =================================================================
   *  D3.js Interactive Collapsible Tree Explorer
   *  Horizontal tree layout — zero overlap, lazy-loaded from API
   *  Click nodes to expand/collapse connections
   * ================================================================= */
  initPage('jewish');

  // ─── Collapsible panels ──────────────────────────────
  ['ctrl','cat','edge'].forEach(k => {
    document.getElementById(k+'-t').onclick = () => document.getElementById(k+'-p').classList.toggle('shut');
  });

  // ─── Color maps ──────────────────────────────────────
  const CC = {
    'Entertainment & Media':'#e74c3c','Religion & Synagogues':'#9b59b6',
    'Culture & Arts':'#e67e22','Technology':'#2ecc71',
    'Community & Social Organizations':'#3498db','Education & Academia':'#1abc9c',
    'Education':'#1abc9c',
    'Representative & Umbrella Bodies':'#f39c12','Heritage & Memorials':'#8e44ad',
    'Charity & Philanthropy':'#e91e63','Investment & Private Equity':'#00bcd4',
    'Real Estate & Property':'#795548','Sports':'#ff5722',
    'Advocacy & Public Affairs':'#607d8b','Healthcare & Pharmaceuticals':'#4caf50',
    'Banking & Financial Services':'#ff9800','Research & Think Tanks':'#673ab7',
    'Retail & E-Commerce':'#009688','Defense & Security':'#f44336',
    'Food & Beverage':'#8bc34a','Conglomerates & Holding Companies':'#9e9e9e',
    'Government & Diplomacy':'#3f51b5','Fashion & Consumer Goods':'#ff4081',
    'Manufacturing & Industry':'#757575','Law Firms':'#455a64',
    'Notable Individuals':'#ffc107','Transportation':'#00acc1',
    'Advertising & PR':'#d81b60','Telecommunications':'#7c4dff',
    'Utilities & Energy':'#66bb6a','People':'#ffab40','Controversy':'#d32f2f',
    'Advocacy & Political Organizations':'#607d8b','Corporate':'#78909c',
    'Energy':'#66bb6a','Finance':'#ff9800','Government':'#3f51b5',
    'Intelligence':'#f44336','Legal':'#455a64','Media':'#e74c3c',
    'Non-Profit':'#4caf50','Philanthropy':'#e91e63','Philanthropy & Foundations':'#e91e63',
    'Political':'#f44336','Retail & Consumer Goods':'#009688','Fashion & Luxury':'#ff4081',
    'Conglomerates':'#9e9e9e'
  };
  const DC = '#546e7a', PC = '#ffab40';
  const EC = {
    'financial':'#ff9800','shared-person':'#9c27b0','political':'#f44336',
    'organizational':'#2196f3','ideological':'#4caf50','historical':'#795548',
    'legal':'#607d8b','related':'#78909c','partnership':'#00bcd4',
    'subsidiary':'#ff5722','funding':'#ffc107','membership':'#3f51b5',
    'affiliation':'#e91e63','leadership':'#8e44ad','collaboration':'#1abc9c',
    'person-affiliation':'#ffab40','industry peer':'#78909c',
    'affiliate':'#42a5f5','communal partner':'#4db6ac',
    'heritage partner':'#ab47bc','funder':'#ffa726',
    'community institution':'#66bb6a','religious partner':'#ce93d8',
    'umbrella body':'#5c6bc0','member':'#26a69a',
    'museum peer':'#7e57c2','cultural partner':'#ec407a',
    'regional connection':'#8d6e63','educational partner':'#29b6f6',
    'government partner':'#ef5350','sports affiliate':'#ff7043',
    'operating body':'#26c6da','governing body':'#d4e157',
    'preservation partner':'#9ccc65','support':'#7986cb',
    'diplomatic partner':'#f06292','historical support':'#a1887f',
    'parent organization':'#4fc3f7','research partner':'#ba68c8',
    'educational':'#1abc9c','lobbying':'#607d8b',
    'advocacy peer':'#607d8b','pro-Israel peer':'#5c6bc0',
    'super PAC':'#f44336','affiliated charity':'#e91e63',
    'lobbying target':'#3f51b5','congressional ally':'#3f51b5',
    'major donor':'#ff9800','diplomatic bridge':'#f06292',
    'pro-Israel ecosystem':'#4caf50','think tank engagement':'#673ab7',
    'social connection':'#9c27b0','academic donation':'#1abc9c',
    'alleged intelligence connection':'#f44336',
    'science connection':'#2ecc71','property':'#795548',
    'investigation':'#607d8b','social':'#9c27b0'
  };
  const DEC = '#90a4ae';

  // ─── Parse URL ───────────────────────────────────────
  const ID_ALIASES = { 'jeffrey-epstein-network': 'epstein-network' };
  const params = new URLSearchParams(window.location.search);
  let focusEntryId = params.get('id') || 'epstein-network';
  if (ID_ALIASES[focusEntryId]) {
    focusEntryId = ID_ALIASES[focusEntryId];
    const newUrl = new URL(window.location);
    newUrl.searchParams.set('id', focusEntryId);
    window.history.replaceState({}, '', newUrl);
  }
  document.getElementById('btn-entry-top').href = 'entry.html?religion=jewish&id=' + encodeURIComponent(focusEntryId);
  document.getElementById('btn-entry').onclick = () => {
    window.location.href = 'entry.html?religion=jewish&id=' + encodeURIComponent(focusEntryId);
  };

  // ─── Tree state ──────────────────────────────────────
  const NW = 230, NH = 44, LEVEL_GAP = 310, SIB_GAP = 54;
  let treeRoot = null;
  let allVisibleIds = new Set();
  let rawApiData = null;
  let searchHits = new Set();

  // ─── Tooltip helpers ─────────────────────────────────
  const tipEl = document.getElementById('tip');
  let lastMX = 0, lastMY = 0;
  document.addEventListener('mousemove', e => { lastMX = e.clientX; lastMY = e.clientY; });
  function showTip(html) {
    tipEl.innerHTML = html;
    tipEl.style.display = 'block';
    tipEl.style.left = Math.min(lastMX + 15, window.innerWidth - 360) + 'px';
    tipEl.style.top = Math.min(lastMY - 10, window.innerHeight - 120) + 'px';
  }
  function hideTip() { tipEl.style.display = 'none'; }

  // ─── SVG setup ───────────────────────────────────────
  const svgEl = d3.select('#tree-svg');
  const gLinks = svgEl.append('g').attr('class', 'links-group');
  const gNodes = svgEl.append('g').attr('class', 'nodes-group');
  const gLabels = svgEl.append('g').attr('class', 'labels-group');

  const zoomBehavior = d3.zoom()
    .scaleExtent([0.05, 4])
    .on('zoom', (event) => {
      gLinks.attr('transform', event.transform);
      gNodes.attr('transform', event.transform);
      gLabels.attr('transform', event.transform);
    });
  svgEl.call(zoomBehavior);

  // ─── Convert API data → tree hierarchy ───────────────
  function buildTreeData(apiData, rootId) {
    const nodeMap = {};
    apiData.nodes.forEach(n => { nodeMap[n.id] = n; });

    const rootNode = nodeMap[rootId];
    if (!rootNode) return null;

    // Gather connections grouped: entries vs people
    const entryKids = [], personKids = [];
    const seenChild = new Set();

    apiData.links.forEach(link => {
      let cid = link.source === rootId ? link.target : (link.target === rootId ? link.source : null);
      if (!cid || cid === rootId || seenChild.has(cid)) return;
      seenChild.add(cid);
      const cn = nodeMap[cid];
      if (!cn) return;

      const child = {
        id: cn.id, name: cn.name, category: cn.category || '',
        country: cn.country || '', nodeType: cn.nodeType,
        type: cn.type || '', role: cn.role || '', personId: cn.personId || '',
        isFocus: false,
        _edgeType: link.type || 'related', _edgeDesc: link.description || '',
        children: [], _loaded: false, _collapsed: true,
        _connCount: 0
      };

      if (cn.nodeType === 'person') personKids.push(child);
      else entryKids.push(child);
    });

    // Count connections for each entry child (from apiData.links)
    entryKids.forEach(ek => {
      ek._connCount = apiData.links.filter(l => l.source === ek.id || l.target === ek.id).length;
    });

    entryKids.sort((a, b) => a.name.localeCompare(b.name));
    personKids.sort((a, b) => a.name.localeCompare(b.name));

    const children = [...entryKids];
    if (personKids.length > 0) {
      children.push({
        id: '_people_' + rootId, name: 'People (' + personKids.length + ')',
        category: 'People', nodeType: 'people-group',
        country: '', type: '', role: '', personId: '', isFocus: false,
        _edgeType: 'person-affiliation', _edgeDesc: '',
        children: personKids, _loaded: true, _collapsed: true, _connCount: personKids.length
      });
    }

    return {
      id: rootId, name: rootNode.name, category: rootNode.category || '',
      country: rootNode.country || '', nodeType: 'entry',
      type: rootNode.type || '', role: '', personId: '', isFocus: true,
      _edgeType: 'root', _edgeDesc: '',
      children: children, _loaded: true, _collapsed: false,
      _connCount: apiData.links.filter(l => l.source === rootId || l.target === rootId).length
    };
  }

  // ─── Collect all visible IDs ─────────────────────────
  function collectIds(node, set) {
    if (!node) return;
    set.add(node.id);
    if (!node._collapsed && node.children) {
      node.children.forEach(c => collectIds(c, set));
    }
  }

  // ─── Render the tree ─────────────────────────────────
  function renderTree() {
    if (!treeRoot) return;

    allVisibleIds = new Set();
    collectIds(treeRoot, allVisibleIds);

    // Build d3 hierarchy — only include expanded children
    const root = d3.hierarchy(treeRoot, d => d._collapsed ? null : d.children);

    // Compute layout
    const treeLayout = d3.tree().nodeSize([SIB_GAP, LEVEL_GAP]);
    treeLayout(root);

    const nodes = root.descendants();
    const links = root.links();

    // ─── Links ──────────────────────────────────────
    const linkSel = gLinks.selectAll('.tree-link')
      .data(links, d => d.source.data.id + '→' + d.target.data.id);

    linkSel.exit().transition().duration(300).attr('opacity', 0).remove();

    const linkEnter = linkSel.enter()
      .append('path')
      .attr('class', 'tree-link')
      .attr('opacity', 0);

    linkSel.merge(linkEnter)
      .transition().duration(500)
      .attr('opacity', 0.5)
      .attr('stroke', d => EC[d.target.data._edgeType] || DEC)
      .attr('d', d => {
        const sx = d.source.y + NW / 2;
        const sy = d.source.x;
        const tx = d.target.y - NW / 2;
        const ty = d.target.x;
        const mx = (sx + tx) / 2;
        return 'M' + sx + ',' + sy + ' C' + mx + ',' + sy + ' ' + mx + ',' + ty + ' ' + tx + ',' + ty;
      });

    // ─── Link edge-type labels ──────────────────────
    const lblSel = gLabels.selectAll('.tree-link-label')
      .data(links, d => d.source.data.id + '→lbl→' + d.target.data.id);

    lblSel.exit().remove();
    const lblEnter = lblSel.enter()
      .append('text')
      .attr('class', 'tree-link-label')
      .attr('text-anchor', 'middle')
      .attr('dy', -4);

    lblSel.merge(lblEnter)
      .transition().duration(500)
      .attr('x', d => {
        const sx = d.source.y + NW / 2;
        const tx = d.target.y - NW / 2;
        return (sx + tx) / 2;
      })
      .attr('y', d => (d.source.x + d.target.x) / 2)
      .text(d => d.target.data._edgeType || '');

    // ─── Nodes ──────────────────────────────────────
    const nodeSel = gNodes.selectAll('.tree-node')
      .data(nodes, d => d.data.id);

    nodeSel.exit().transition().duration(300).attr('opacity', 0).remove();

    const nodeEnter = nodeSel.enter()
      .append('g')
      .attr('class', 'tree-node')
      .attr('opacity', 0)
      .attr('transform', d => 'translate(' + d.y + ',' + d.x + ')');

    // Background rect
    nodeEnter.append('rect')
      .attr('class', 'node-bg')
      .attr('width', NW).attr('height', NH)
      .attr('x', -NW / 2).attr('y', -NH / 2)
      .attr('rx', 9).attr('ry', 9);

    // Category color bar
    nodeEnter.append('rect')
      .attr('class', 'node-cat-bar')
      .attr('width', 4).attr('height', NH - 6)
      .attr('x', -NW / 2 + 3).attr('y', -NH / 2 + 3)
      .attr('rx', 2);

    // Icon
    nodeEnter.append('text')
      .attr('class', 'node-icon')
      .attr('x', -NW / 2 + 16).attr('y', 1)
      .attr('text-anchor', 'middle')
      .attr('font-family', '"Font Awesome 6 Free"')
      .attr('font-weight', 900)
      .attr('font-size', '11px');

    // Name
    nodeEnter.append('text')
      .attr('class', 'node-name')
      .attr('x', -NW / 2 + 26).attr('y', -5);

    // Info line
    nodeEnter.append('text')
      .attr('class', 'node-info')
      .attr('x', -NW / 2 + 26).attr('y', 10);

    // Toggle indicator
    nodeEnter.append('text')
      .attr('class', 'node-toggle')
      .attr('x', NW / 2 - 16).attr('y', 5)
      .attr('text-anchor', 'middle');

    // Connection count badge
    nodeEnter.append('text')
      .attr('class', 'node-conns')
      .attr('x', NW / 2 - 34).attr('y', 5)
      .attr('text-anchor', 'end');

    // ─── Event handlers (enter only) ────────────────
    nodeEnter
      .on('click', (event, d) => {
        event.stopPropagation();
        handleNodeClick(d);
      })
      .on('contextmenu', (event, d) => {
        event.preventDefault();
        navigateToEntry(d.data);
      })
      .on('mouseenter', (event, d) => {
        const nd = d.data;
        let html;
        if (nd.nodeType === 'person') {
          html = '<strong><i class="fa-solid fa-user"></i> ' + nd.name + '</strong><br/>'
            + '<i class="fa-solid fa-briefcase"></i> ' + (nd.role || 'Individual') + '<br/>'
            + '<i class="fa-solid fa-globe"></i> ' + (nd.country || '')
            + '<br/><span style="color:#0056b3;font-size:0.85em">Click to expand &middot; Right-click → profile</span>';
        } else if (nd.nodeType === 'people-group') {
          html = '<strong><i class="fa-solid fa-users"></i> ' + nd.name + '</strong><br/>'
            + '<span style="color:#666">Click to expand/collapse</span>';
        } else {
          html = '<strong>' + nd.name + '</strong><br/>'
            + '<i class="fa-solid fa-building"></i> ' + (nd.type || '') + '<br/>'
            + '<i class="fa-solid fa-globe"></i> ' + (nd.country || '') + '<br/>'
            + '<span class="tip-cat" style="background:' + (CC[nd.category] || DC) + '30;color:' + (CC[nd.category] || DC) + '">' + (nd.category || '') + '</span>'
            + '<br/><span style="color:#0056b3;font-size:0.85em">Click to expand &middot; Right-click → details</span>';
        }
        showTip(html);
      })
      .on('mouseleave', () => hideTip());

    // ─── Update all nodes ───────────────────────────
    const nodeAll = nodeSel.merge(nodeEnter);

    nodeAll.transition().duration(500)
      .attr('opacity', 1)
      .attr('transform', d => 'translate(' + d.y + ',' + d.x + ')');

    // Update background
    nodeAll.select('.node-bg')
      .attr('fill', d => {
        if (d.data.isFocus) return '#fff3f3';
        if (d.data.nodeType === 'person') return '#fffcf0';
        if (d.data.nodeType === 'people-group') return '#fff8e1';
        return '#ffffff';
      })
      .attr('stroke', d => {
        if (d.data.isFocus) return '#c62828';
        return CC[d.data.category] || DC;
      })
      .attr('stroke-width', d => d.data.isFocus ? 2.5 : 1.5);

    // Update cat bar
    nodeAll.select('.node-cat-bar')
      .attr('fill', d => {
        if (d.data.isFocus) return '#c62828';
        return CC[d.data.category] || DC;
      });

    // Update icon
    nodeAll.select('.node-icon')
      .text(d => {
        if (d.data.nodeType === 'person') return '\uf007';
        if (d.data.nodeType === 'people-group') return '\uf0c0';
        if (d.data.isFocus) return '\uf005';
        return '\uf1ad';
      })
      .attr('fill', d => {
        if (d.data.isFocus) return '#c62828';
        return CC[d.data.category] || DC;
      });

    // Update name
    nodeAll.select('.node-name')
      .text(d => {
        const n = d.data.name || d.data.id;
        return n.length > 24 ? n.substring(0, 22) + '\u2026' : n;
      })
      .attr('font-weight', d => d.data.isFocus ? 'bold' : 'normal');

    // Update info
    nodeAll.select('.node-info')
      .text(d => {
        if (d.data.nodeType === 'person') return (d.data.role || 'Individual').substring(0, 30);
        if (d.data.nodeType === 'people-group') return 'Click to expand';
        const parts = [];
        if (d.data.category) parts.push(d.data.category);
        if (d.data.country) parts.push(d.data.country);
        const txt = parts.join(' \xB7 ');
        return txt.length > 32 ? txt.substring(0, 30) + '\u2026' : txt;
      });

    // Update toggle
    nodeAll.select('.node-toggle')
      .text(d => {
        if (d.data.nodeType === 'person' && (!d.data.children || d.data.children.length === 0)) return '';
        if (!d.data._loaded && d.data.nodeType !== 'people-group') return '\u22EF';
        if (d.data._collapsed) return '+';
        if (d.data.children && d.data.children.length > 0) return '\u2212';
        return '';
      });

    // Update connection count
    nodeAll.select('.node-conns')
      .text(d => {
        if (d.data._connCount > 0 && d.data.nodeType !== 'people-group') return d.data._connCount;
        return '';
      });

    // Search highlighting
    nodeAll.classed('search-hit', d => searchHits.has(d.data.id));

    // ─── Stats ──────────────────────────────────────
    updateStats();
  }

  // ─── Handle node click ───────────────────────────────
  async function handleNodeClick(d) {
    const nd = d.data;

    // Person leaf → toggle expand (fetch that person's connections) or navigate
    if (nd.nodeType === 'person') {
      if (!nd._loaded) {
        // Fetch person's connections
        nd._loaded = true;
        nd._collapsed = false;
        nd.children = []; // persons are leaves for now
        // Navigate to their profile
        window.location.href = 'person.html?id=' + encodeURIComponent(nd.personId || nd.id);
        return;
      }
      window.location.href = 'person.html?id=' + encodeURIComponent(nd.personId || nd.id);
      return;
    }

    // Toggle expand/collapse
    if (!nd._collapsed) {
      // Collapse
      nd._collapsed = true;
      renderTree();
      return;
    }

    // Expand
    if (!nd._loaded) {
      // Fetch from API
      document.getElementById('ld-text').textContent = 'Loading connections for ' + nd.name + '...';
      document.getElementById('loading').classList.remove('off');

      try {
        const showPeople = document.getElementById('show-people').checked;
        const res = await fetch('/api/graph/focus/' + encodeURIComponent(nd.id) + '?depth=1&people=' + (showPeople ? '1' : '0'));
        const data = await res.json();

        if (!data.nodes || data.nodes.length === 0) {
          nd._loaded = true;
          nd.children = [];
          nd._collapsed = false;
          renderTree();
          document.getElementById('loading').classList.add('off');
          return;
        }

        const nodeMap = {};
        data.nodes.forEach(n => { nodeMap[n.id] = n; });

        const entryKids = [], personKids = [];
        const seenChild = new Set();

        data.links.forEach(link => {
          let cid = link.source === nd.id ? link.target : (link.target === nd.id ? link.source : null);
          if (!cid || cid === nd.id || seenChild.has(cid)) return;
          if (allVisibleIds.has(cid)) return; // skip already-visible nodes
          seenChild.add(cid);
          const cn = nodeMap[cid];
          if (!cn) return;

          const child = {
            id: cn.id, name: cn.name, category: cn.category || '',
            country: cn.country || '', nodeType: cn.nodeType,
            type: cn.type || '', role: cn.role || '', personId: cn.personId || '',
            isFocus: false,
            _edgeType: link.type || 'related', _edgeDesc: link.description || '',
            children: [], _loaded: false, _collapsed: true,
            _connCount: data.links.filter(l => l.source === cn.id || l.target === cn.id).length
          };

          if (cn.nodeType === 'person') personKids.push(child);
          else entryKids.push(child);
        });

        entryKids.sort((a, b) => a.name.localeCompare(b.name));
        personKids.sort((a, b) => a.name.localeCompare(b.name));

        const newChildren = [...entryKids];
        if (personKids.length > 0) {
          newChildren.push({
            id: nd.id + '_people', name: 'People (' + personKids.length + ')',
            category: 'People', nodeType: 'people-group',
            country: '', type: '', role: '', personId: '', isFocus: false,
            _edgeType: 'person-affiliation', _edgeDesc: '',
            children: personKids, _loaded: true, _collapsed: true, _connCount: personKids.length
          });
        }

        nd.children = newChildren;
        nd._loaded = true;
      } catch (err) {
        console.error('Fetch error:', err);
        nd._loaded = true;
        nd.children = [];
      }

      document.getElementById('loading').classList.add('off');
    }

    nd._collapsed = false;
    renderTree();
  }

  // ─── Navigate to entry page ──────────────────────────
  function navigateToEntry(nd) {
    if (nd.nodeType === 'person') {
      window.location.href = 'person.html?id=' + encodeURIComponent(nd.personId || nd.id);
    } else if (nd.nodeType !== 'people-group') {
      window.location.href = 'entry.html?religion=jewish&id=' + encodeURIComponent(nd.id);
    }
  }

  // ─── Update stats ────────────────────────────────────
  function updateStats() {
    let entries = 0, people = 0;
    allVisibleIds.forEach(id => {
      if (id.startsWith('person-')) people++;
      else if (!id.startsWith('_people_')) entries++;
    });
    document.getElementById('stats').innerHTML =
      '<b>' + entries + '</b> entries &middot; <b>' + people + '</b> people visible';
  }

  // ─── Fit tree to viewport ────────────────────────────
  function fitTree() {
    const svgNode = svgEl.node();
    const bounds = gNodes.node().getBBox();
    if (!bounds.width || !bounds.height) return;

    const svgW = svgNode.clientWidth;
    const svgH = svgNode.clientHeight;
    const padding = 60;

    const scaleX = (svgW - padding * 2) / bounds.width;
    const scaleY = (svgH - padding * 2) / bounds.height;
    const scale = Math.min(scaleX, scaleY, 1.5);

    const tx = svgW / 2 - (bounds.x + bounds.width / 2) * scale;
    const ty = svgH / 2 - (bounds.y + bounds.height / 2) * scale;

    svgEl.transition().duration(600)
      .call(zoomBehavior.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
  }

  // ─── Category + Edge legends ─────────────────────────
  function buildCatLegend(data) {
    const cats = {};
    data.nodes.forEach(n => { if (n.category) cats[n.category] = true; });
    const sorted = Object.keys(cats).sort();
    const catB = document.getElementById('cat-b');
    catB.innerHTML = '';
    sorted.forEach(c => {
      const r = document.createElement('div'); r.className = 'li';
      const d = document.createElement('div'); d.className = 'ld';
      d.style.background = CC[c] || DC;
      r.appendChild(d); r.appendChild(document.createTextNode(c));
      catB.appendChild(r);
    });
  }

  function buildEdgeLegend(data) {
    const types = {};
    data.links.forEach(l => { if (l.type) types[l.type] = true; });
    const sorted = Object.keys(types).sort();
    const edgeB = document.getElementById('edge-b');
    edgeB.innerHTML = '';
    sorted.forEach(t => {
      const r = document.createElement('div'); r.className = 'ei';
      const l = document.createElement('div'); l.className = 'el';
      l.style.background = EC[t] || DEC;
      r.appendChild(l); r.appendChild(document.createTextNode(t));
      edgeB.appendChild(r);
    });
  }

  // ─── Expand all visible nodes one level ──────────────
  async function expandAll() {
    if (!treeRoot) return;
    // Expand all collapsed nodes that are already loaded
    function expandLoaded(node) {
      if (!node) return;
      if (node._loaded && node._collapsed && node.children && node.children.length > 0) {
        node._collapsed = false;
      }
      if (!node._collapsed && node.children) {
        node.children.forEach(expandLoaded);
      }
    }
    expandLoaded(treeRoot);
    renderTree();
    setTimeout(fitTree, 600);
  }

  function collapseAll() {
    if (!treeRoot) return;
    function collapseKids(node) {
      if (!node || !node.children) return;
      node.children.forEach(c => {
        c._collapsed = true;
        collapseKids(c);
      });
    }
    collapseKids(treeRoot);
    renderTree();
    setTimeout(fitTree, 600);
  }

  // ─── Search ──────────────────────────────────────────
  function doSearch() {
    const q = document.getElementById('s-input').value.trim().toLowerCase();
    searchHits = new Set();
    if (!q) {
      document.getElementById('s-count').textContent = '';
      renderTree();
      return;
    }
    // Search all nodes in the tree recursively
    function searchNode(node) {
      if (!node) return;
      if ((node.name || '').toLowerCase().indexOf(q) !== -1) {
        searchHits.add(node.id);
      }
      if (node.children) node.children.forEach(searchNode);
    }
    searchNode(treeRoot);
    document.getElementById('s-count').textContent = searchHits.size ? searchHits.size + ' found' : 'none';
    renderTree();
  }

  // ─── Load tree from API ──────────────────────────────
  async function loadTree() {
    const depth = document.getElementById('depth-range').value;
    const ppl = document.getElementById('show-people').checked;
    const url = '/api/graph/focus/' + encodeURIComponent(focusEntryId)
      + '?depth=' + depth + '&people=' + (ppl ? '1' : '0');

    document.getElementById('loading').classList.remove('off');
    document.getElementById('ld-text').textContent = 'Fetching network data...';
    document.getElementById('stats').innerHTML = '<b>Loading...</b>';

    try {
      const res = await fetch(url);
      rawApiData = await res.json();

      if (!rawApiData.nodes || rawApiData.nodes.length === 0) {
        document.getElementById('ld-text').textContent = 'No data found for this entry.';
        return;
      }

      treeRoot = buildTreeData(rawApiData, focusEntryId);
      if (!treeRoot) {
        document.getElementById('ld-text').textContent = 'Entry not found in data.';
        return;
      }

      // Update page info
      if (rawApiData.focusName) {
        setSEO({ title: rawApiData.focusName + ' Network - Juice Project', description: 'Network tree for ' + rawApiData.focusName });
        document.getElementById('page-title').innerHTML = '<span class="focus-name">' + rawApiData.focusName + '</span> Network';
      }

      const entryCount = rawApiData.nodes.filter(n => n.nodeType !== 'person').length;
      const peopleCount = rawApiData.nodes.filter(n => n.nodeType === 'person').length;
      document.getElementById('page-subtitle').textContent =
        entryCount + ' entries \xB7 ' + rawApiData.links.length + ' connections \xB7 Depth ' + depth;

      if (rawApiData.totalPeople !== undefined) {
        document.getElementById('people-info').innerHTML = ppl
          ? 'Showing <b>' + peopleCount + '</b> of <b>' + rawApiData.totalPeople + '</b> associated individuals'
          : '<b>' + rawApiData.totalPeople + '</b> people available \u2014 check "People" to show';
      }

      buildCatLegend(rawApiData);
      buildEdgeLegend(rawApiData);

      // Render tree
      renderTree();
      setTimeout(() => {
        fitTree();
        document.getElementById('loading').classList.add('off');
      }, 300);

    } catch (err) {
      console.error('Load error:', err);
      document.getElementById('ld-text').textContent = 'Error: ' + err.message;
    }
  }

  // ─── Control bindings ────────────────────────────────
  document.getElementById('depth-range').oninput = function() {
    document.getElementById('depth-val').textContent = this.value;
  };
  document.getElementById('depth-range').onchange = loadTree;
  document.getElementById('btn-reload').onclick = loadTree;
  document.getElementById('btn-fit').onclick = fitTree;
  document.getElementById('show-people').onchange = loadTree;
  document.getElementById('btn-expand-all').onclick = expandAll;
  document.getElementById('btn-collapse').onclick = collapseAll;

  document.getElementById('s-btn').onclick = doSearch;
  document.getElementById('s-input').onkeydown = function(e) { if (e.key === 'Enter') doSearch(); };
  document.getElementById('s-input').oninput = function() {
    if (!this.value.trim()) {
      searchHits = new Set();
      document.getElementById('s-count').textContent = '';
      renderTree();
    }
  };

  // ─── Init ────────────────────────────────────────────
  loadTree();
  </script>
</body>
</html>
